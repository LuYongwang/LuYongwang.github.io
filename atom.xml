<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lä¸¶luluâ€˜s Blog</title>
  
  <subtitle>æ•¬å¾€äº‹ä¸€æ¯é…’,å†çˆ±æˆ‘ä¹Ÿä¸å›å¤´ğŸŒ¹</subtitle>
  <link href="https://blog.yongwang.lu/atom.xml" rel="self"/>
  
  <link href="https://blog.yongwang.lu/"/>
  <updated>2023-01-05T08:40:00.000Z</updated>
  <id>https://blog.yongwang.lu/</id>
  
  <author>
    <name>Lä¸¶lulu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰7ã€å¥åº·æ£€æŸ¥è¯¦è§£</title>
    <link href="https://blog.yongwang.lu/post/bb9b1e8e.html"/>
    <id>https://blog.yongwang.lu/post/bb9b1e8e.html</id>
    <published>2023-01-05T08:40:00.000Z</published>
    <updated>2023-01-05T08:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><blockquote><p>Kubernetesä¸­çš„å¥åº·æ£€æŸ¥ä¸»è¦ä½¿ç”¨ å°±ç»ªæ€§æ¢é’ˆï¼ˆ<code>readinessProbes</code>ï¼‰å’Œ å­˜æ´»æ€§æ¢é’ˆï¼ˆ<code>livenessProbes</code>ï¼‰ æ¥å®ç°ï¼Œserviceå³ä¸ºè´Ÿè½½å‡è¡¡ï¼Œk8sä¿è¯ service åé¢çš„ pod éƒ½å¯ç”¨ï¼Œæ˜¯k8sä¸­è‡ªæ„ˆèƒ½åŠ›çš„ä¸»è¦æ‰‹æ®µï¼Œä¸»è¦åŸºäºè¿™ä¸¤ç§æ¢æµ‹æœºåˆ¶ï¼Œå¯ä»¥å®ç°å¦‚ä¸‹éœ€æ±‚ï¼š</p></blockquote><ul><li><p>å¼‚å¸¸å®ä¾‹è‡ªåŠ¨å‰”é™¤ï¼Œå¹¶é‡å¯æ–°å®ä¾‹</p></li><li><p>å¤šç§ç±»å‹æ¢é’ˆæ£€æµ‹ï¼Œä¿è¯å¼‚å¸¸podä¸æ¥å…¥æµé‡</p></li><li><p>ä¸åœæœºéƒ¨ç½²ï¼Œæ›´å®‰å…¨çš„æ»šåŠ¨å‡çº§</p></li></ul><p><img src="https://res.yongwang.lu/img/20230322232410.png" alt="å›¾ç‰‡"><br>å®˜æ–¹æ–‡æ¡£ï¼š<a href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/">https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/configure-liveness-readiness-startup-probes/</a>  </p><h3 id="1ï¼‰k8sä¸­çš„æ¢é’ˆç§ç±»"><a href="#1ï¼‰k8sä¸­çš„æ¢é’ˆç§ç±»" class="headerlink" title="1ï¼‰k8sä¸­çš„æ¢é’ˆç§ç±»"></a>1ï¼‰k8sä¸­çš„æ¢é’ˆç§ç±»</h3><h4 id="1ã€å°±ç»ªæ£€æŸ¥ï¼ˆreadinessProbeï¼Œå°±ç»ªæ¢é’ˆï¼‰"><a href="#1ã€å°±ç»ªæ£€æŸ¥ï¼ˆreadinessProbeï¼Œå°±ç»ªæ¢é’ˆï¼‰" class="headerlink" title="1ã€å°±ç»ªæ£€æŸ¥ï¼ˆreadinessProbeï¼Œå°±ç»ªæ¢é’ˆï¼‰"></a>1ã€å°±ç»ªæ£€æŸ¥ï¼ˆreadinessProbeï¼Œå°±ç»ªæ¢é’ˆï¼‰</h4><blockquote><p><code>readiness probes</code>å‡†å¤‡å°±ç»ªæ£€æŸ¥ï¼Œé€šè¿‡readinessæ˜¯å¦å‡†å¤‡æ¥å—æµé‡ï¼Œå‡†å¤‡å®Œæ¯•åŠ å…¥åˆ°<code>Endpoint</code>ï¼Œå¦åˆ™å‰”é™¤ã€‚å¦‚æœå®¹å™¨ä¸æä¾›å°±ç»ªæ¢é’ˆï¼Œåˆ™<strong>é»˜è®¤çŠ¶æ€ä¸º Success</strong>ã€‚</p></blockquote><h4 id="2ã€å­˜æ´»æ£€æŸ¥ï¼ˆlivenessProbeï¼Œå­˜æ´»æ¢é’ˆï¼‰"><a href="#2ã€å­˜æ´»æ£€æŸ¥ï¼ˆlivenessProbeï¼Œå­˜æ´»æ¢é’ˆï¼‰" class="headerlink" title="2ã€å­˜æ´»æ£€æŸ¥ï¼ˆlivenessProbeï¼Œå­˜æ´»æ¢é’ˆï¼‰"></a>2ã€å­˜æ´»æ£€æŸ¥ï¼ˆlivenessProbeï¼Œå­˜æ´»æ¢é’ˆï¼‰</h4><blockquote><p><code>liveness probes</code>åœ¨çº¿æ£€æŸ¥æœºåˆ¶ï¼Œæ£€æŸ¥åº”ç”¨æ˜¯å¦å¯ç”¨ï¼Œå¦‚æ­»é”ï¼Œæ— æ³•å“åº”ï¼Œå¼‚å¸¸æ—¶å°†æ ¹æ®<code>restartPolicy</code>æ¥è®¾ç½® Pod çŠ¶æ€ä¼šè‡ªåŠ¨é‡å¯å®¹å™¨ï¼Œå¦‚æœå®¹å™¨ä¸æä¾›å­˜æ´»æ¢é’ˆï¼Œåˆ™<strong>é»˜è®¤çŠ¶æ€ä¸º Success</strong>ã€‚</p></blockquote><p><code>restartPolicy</code>æœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š</p><ul><li><p><code>Always</code>ï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œ<strong>é»˜è®¤ç­–ç•¥</strong>ã€‚</p></li><li><p><code>OnFailure</code>ï¼šå½“å®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰æ—¶ï¼Œæ‰é‡å¯å®¹å™¨ã€‚</p></li><li><p><code>Never</code>ï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºï¼Œä»ä¸é‡å¯å®¹å™¨ã€‚</p></li></ul><h4 id="3ã€å¯åŠ¨æ£€æŸ¥ï¼ˆstartupProbeï¼Œå¯åŠ¨æ¢é’ˆï¼Œ1-17-ç‰ˆæœ¬æ–°å¢ï¼‰"><a href="#3ã€å¯åŠ¨æ£€æŸ¥ï¼ˆstartupProbeï¼Œå¯åŠ¨æ¢é’ˆï¼Œ1-17-ç‰ˆæœ¬æ–°å¢ï¼‰" class="headerlink" title="3ã€å¯åŠ¨æ£€æŸ¥ï¼ˆstartupProbeï¼Œå¯åŠ¨æ¢é’ˆï¼Œ1.17 ç‰ˆæœ¬æ–°å¢ï¼‰"></a>3ã€å¯åŠ¨æ£€æŸ¥ï¼ˆstartupProbeï¼Œå¯åŠ¨æ¢é’ˆï¼Œ1.17 ç‰ˆæœ¬æ–°å¢ï¼‰</h4><ul><li><p><code>startupProbes</code>Â å¯åŠ¨æ£€æŸ¥æœºåˆ¶ï¼Œåº”ç”¨ä¸€äº›å¯åŠ¨ç¼“æ…¢çš„ä¸šåŠ¡ï¼Œé¿å…ä¸šåŠ¡é•¿æ—¶é—´å¯åŠ¨è€Œè¢«å‰é¢çš„æ¢é’ˆkillæ‰ã€‚</p></li><li><p>åˆ¤æ–­å®¹å™¨å†…çš„åº”ç”¨ç¨‹åºæ˜¯å¦å·²å¯åŠ¨ï¼Œä¸»è¦é’ˆå¯¹äºä¸èƒ½ç¡®å®šå…·ä½“å¯åŠ¨æ—¶é—´çš„åº”ç”¨ã€‚å¦‚æœåŒ¹é…äº†Â <code>startupProbes</code>Â æ¢æµ‹ï¼Œåˆ™åœ¨Â <code>startupProbes</code>Â çŠ¶æ€ä¸º Success ä¹‹å‰ï¼Œå…¶ä»–æ‰€æœ‰æ¢é’ˆéƒ½å¤„äºæ— æ•ˆçŠ¶æ€ï¼Œç›´<strong>åˆ°å®ƒæˆåŠŸåå…¶ä»–æ¢é’ˆæ‰èµ·ä½œç”¨</strong>ã€‚</p></li><li><p>å¦‚æœÂ <code>startupProbe</code>Â å¤±è´¥ï¼Œkubelet å°†æ€æ­»å®¹å™¨ï¼Œå®¹å™¨å°†æ ¹æ®Â <code>restartPolicy</code>Â æ¥é‡å¯ã€‚å¦‚æœå®¹å™¨æ²¡æœ‰é…ç½®Â <code>startupProbe</code>ï¼Œåˆ™<strong>é»˜è®¤çŠ¶æ€ä¸º Success</strong>ã€‚å…¶å®ä¸€èˆ¬ä¸»è¦æ˜¯è®¾ç½®ä¸Šé¢ä¸¤ç§å³å¯ã€‚</p></li></ul><p><strong>å°±ç»ªã€å­˜æ´»ä¸¤ç§æ¢é’ˆçš„åŒºåˆ«ï¼š</strong></p><blockquote><p><strong>readinessProbe</strong>Â å’ŒÂ <strong>livenessProbe</strong>Â å¯ä»¥ä½¿ç”¨ç›¸åŒæ¢æµ‹æ–¹å¼ï¼Œåªæ˜¯å¯¹ Pod çš„å¤„ç½®æ–¹å¼ä¸åŒã€‚</p></blockquote><ul><li><p><strong>livenessProbe</strong>Â å½“æ£€æµ‹å¤±è´¥åï¼Œå°†æ€æ­»å®¹å™¨å¹¶æ ¹æ® Pod çš„<strong>é‡å¯ç­–ç•¥æ¥å†³å®šä½œå‡ºå¯¹åº”çš„æªæ–½</strong>ã€‚</p></li><li><p><strong>readinessProbe</strong>Â å½“æ£€æµ‹å¤±è´¥åï¼Œå°† Pod çš„ IP:Port ä»å¯¹åº”çš„Â <code>EndPoint</code>Â åˆ—è¡¨ä¸­åˆ é™¤ã€‚</p></li></ul><h3 id="2ï¼‰k8sä¸­çš„ä¸‰ç§æ¢æµ‹æ–¹å¼"><a href="#2ï¼‰k8sä¸­çš„ä¸‰ç§æ¢æµ‹æ–¹å¼" class="headerlink" title="2ï¼‰k8sä¸­çš„ä¸‰ç§æ¢æµ‹æ–¹å¼"></a>2ï¼‰k8sä¸­çš„ä¸‰ç§æ¢æµ‹æ–¹å¼</h3><blockquote><p>æ¯ç§æ¢æµ‹æœºåˆ¶æ”¯æŒä¸‰ç§å¥åº·æ£€æŸ¥æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯å‘½ä»¤è¡Œexecï¼ŒhttpGetå’ŒtcpSocketï¼Œå…¶ä¸­execé€šç”¨æ€§æœ€å¼ºï¼Œé€‚ç”¨ä¸å¤§éƒ¨åˆ†åœºæ™¯ï¼ŒtcpSocketé€‚ç”¨äºTCPä¸šåŠ¡ï¼ŒhttpGeté€‚ç”¨äºwebä¸šåŠ¡ã€‚</p></blockquote><ul><li><p><code>exec</code>ï¼ˆè‡ªå®šä¹‰å¥åº·æ£€æŸ¥ï¼‰ï¼šåœ¨å®¹å™¨ä¸­æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œå¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œé€€å‡ºç ä¸º 0 åˆ™æ¢æµ‹æˆåŠŸã€‚</p></li><li><p><code>httpGet</code>ï¼šé€šè¿‡å®¹å™¨çš„IPåœ°å€ã€ç«¯å£å·åŠè·¯å¾„è°ƒç”¨ HTTP Getæ–¹æ³•ï¼Œå¦‚æœå“åº”çš„çŠ¶æ€ç å¤§äºç­‰äº200ä¸”å°äº400ï¼Œåˆ™è®¤ä¸ºå®¹å™¨ å¥åº·ã€‚</p></li><li><p><code>tcpSocket</code>ï¼šé€šè¿‡å®¹å™¨çš„ IP åœ°å€å’Œç«¯å£å·æ‰§è¡Œ TCP æ£€ æŸ¥ï¼Œå¦‚æœèƒ½å¤Ÿå»ºç«‹ TCP è¿æ¥ï¼Œåˆ™è¡¨æ˜å®¹å™¨å¥åº·ã€‚</p></li></ul><p>æ¢é’ˆæ¢æµ‹ç»“æœæœ‰ä»¥ä¸‹å€¼ï¼š</p><ul><li><p><code>Success</code>ï¼šè¡¨ç¤ºé€šè¿‡æ£€æµ‹ã€‚</p></li><li><p><code>Failure</code>ï¼šè¡¨ç¤ºæœªé€šè¿‡æ£€æµ‹ã€‚</p></li><li><p><code>Unknown</code>ï¼šè¡¨ç¤ºæ£€æµ‹æ²¡æœ‰æ­£å¸¸è¿›è¡Œã€‚</p></li></ul><h2 id="äºŒã€readinessProbeï¼ˆå°±ç»ªæ€§æ¢é’ˆï¼‰"><a href="#äºŒã€readinessProbeï¼ˆå°±ç»ªæ€§æ¢é’ˆï¼‰" class="headerlink" title="äºŒã€readinessProbeï¼ˆå°±ç»ªæ€§æ¢é’ˆï¼‰"></a>äºŒã€readinessProbeï¼ˆå°±ç»ªæ€§æ¢é’ˆï¼‰</h2><ul><li><p><strong>readiness probe</strong>Â å°±ç»ªæ€§æ¢é’ˆï¼Œç”¨äºåˆ¤æ–­å®¹å™¨å†…çš„ç¨‹åºæ˜¯å¦å­˜æ´»ï¼ˆæˆ–è€…è¯´æ˜¯å¦å¥åº·ï¼‰ï¼Œåªæœ‰ç¨‹åº(æœåŠ¡)æ­£å¸¸ï¼Œ å®¹å™¨å¼€å§‹å¯¹å¤–æä¾›ç½‘ç»œè®¿é—®ï¼ˆå¯åŠ¨å®Œæˆå¹¶å°±ç»ªï¼‰ï¼›</p></li><li><p>å®¹å™¨å¯åŠ¨åæŒ‰ç…§<code>readiness probe</code>é…ç½®è¿›è¡Œæ¢æµ‹ï¼Œæ— é—®é¢˜åç»“æœä¸ºæˆåŠŸå³çŠ¶æ€ä¸ºÂ <code>Success</code>ï¼›</p></li><li><p>podçš„<code>READY</code>çŠ¶æ€ä¸º trueï¼Œä»0&#x2F;1å˜ä¸º1&#x2F;1ã€‚å¦‚æœå¤±è´¥ç»§ç»­ä¸º0&#x2F;1ï¼ŒçŠ¶æ€ä¸º falseï¼›</p></li><li><p>è‹¥<strong>æœªé…ç½®å°±ç»ªæ¢é’ˆ</strong>ï¼Œåˆ™**é»˜è®¤çŠ¶æ€å®¹å™¨å¯åŠ¨åä¸º<code>Success</code>**ã€‚å¯¹äºæ­¤podã€æ­¤podå…³è”çš„<code>Service</code>èµ„æºã€<code>EndPoint</code>Â çš„å…³ç³»ä¹Ÿå°†åŸºäº Pod çš„Â <code>Ready</code>Â çŠ¶æ€è¿›è¡Œè®¾ç½®ï¼›</p></li><li><p>å¦‚æœ Pod è¿è¡Œè¿‡ç¨‹ä¸­Â <strong>Ready çŠ¶æ€å˜ä¸º false</strong>ï¼Œåˆ™ç³»ç»Ÿè‡ªåŠ¨<strong>ä»Â <code>Service</code>èµ„æº å…³è”çš„Â <code>EndPoint</code>åˆ—è¡¨ä¸­å»é™¤æ­¤pod</strong>ï¼Œå±Šæ—¶serviceèµ„æºæ¥æ”¶åˆ°GETè¯·æ±‚åï¼Œ<code>kube-proxy</code>å°†ä¸€å®šä¸ä¼šæŠŠæµé‡å¼•å…¥æ­¤podä¸­ï¼Œé€šè¿‡è¿™ç§æœºåˆ¶å°±èƒ½é˜²æ­¢å°†æµé‡è½¬å‘åˆ°ä¸å¯ç”¨çš„ Pod ä¸Šã€‚</p></li><li><p>å¦‚æœÂ <strong>Pod æ¢å¤ä¸º Ready çŠ¶æ€</strong>ã€‚å°†å†<strong>ä¼šè¢«åŠ å›Â <code>Endpoint</code>Â åˆ—è¡¨</strong>ã€‚<code>kube-proxy</code>ä¹Ÿå°†æœ‰æ¦‚ç‡é€šè¿‡è´Ÿè½½æœºåˆ¶ä¼šå¼•å…¥æµé‡åˆ°æ­¤podä¸­ã€‚</p></li></ul><h2 id="ä¸‰ã€livenessProbeï¼ˆå­˜æ´»æ€§æ¢é’ˆï¼‰"><a href="#ä¸‰ã€livenessProbeï¼ˆå­˜æ´»æ€§æ¢é’ˆï¼‰" class="headerlink" title="ä¸‰ã€livenessProbeï¼ˆå­˜æ´»æ€§æ¢é’ˆï¼‰"></a>ä¸‰ã€livenessProbeï¼ˆå­˜æ´»æ€§æ¢é’ˆï¼‰</h2><ul><li><p><strong>liveness probe</strong>å­˜æ´»æ€§æ¢é’ˆï¼Œç”¨äºåˆ¤æ–­å®¹å™¨æ˜¯ä¸æ˜¯å¥åº·ï¼Œ<strong>å¦‚æœä¸æ»¡è¶³å¥åº·æ¡ä»¶</strong>ï¼Œ<strong>é‚£ä¹ˆ Kubelet å°†æ ¹æ® Pod ä¸­è®¾ç½®çš„Â <code>restartPolicy</code>Â ï¼ˆé‡å¯ç­–ç•¥ï¼‰æ¥åˆ¤æ–­ï¼ŒPod æ˜¯å¦è¦è¿›è¡Œé‡å¯æ“ä½œ</strong>ï¼›</p></li><li><p>LivenessProbeæŒ‰ç…§é…ç½®å»æ¢æµ‹ (Â <strong>è¿›ç¨‹ã€æˆ–è€…ç«¯å£ã€æˆ–è€…å‘½ä»¤æ‰§è¡Œåæ˜¯å¦æˆåŠŸç­‰ç­‰</strong>)ï¼Œæ¥åˆ¤æ–­å®¹å™¨æ˜¯ä¸æ˜¯æ­£å¸¸ï¼›</p></li><li><p>å¦‚æœæ¢æµ‹ä¸åˆ°ï¼Œä»£è¡¨å®¹å™¨ä¸å¥åº·ï¼ˆå¯ä»¥é…ç½®è¿ç»­å¤šå°‘æ¬¡å¤±è´¥æ‰è®°ä¸ºä¸å¥åº·ï¼‰ï¼Œåˆ™ kubelet ä¼šæ€æ‰è¯¥å®¹å™¨ï¼Œå¹¶æ ¹æ®å®¹å™¨çš„é‡å¯ç­–ç•¥åšç›¸åº”çš„å¤„ç†ï¼›</p></li><li><p>å¦‚æœ<strong>æœªé…ç½®å­˜æ´»æ¢é’ˆ</strong>ï¼Œåˆ™<strong>é»˜è®¤å®¹å™¨å¯åŠ¨ä¸ºé€šè¿‡ï¼ˆSuccessï¼‰çŠ¶æ€</strong>ã€‚å³æ¢é’ˆè¿”å›çš„å€¼æ°¸è¿œæ˜¯Â <code>Success</code>ã€‚å³SuccessåpodçŠ¶æ€æ˜¯<code>RUNING</code>ã€‚</p></li></ul><h2 id="å››ã€å®æˆ˜æ¼”ç¤º"><a href="#å››ã€å®æˆ˜æ¼”ç¤º" class="headerlink" title="å››ã€å®æˆ˜æ¼”ç¤º"></a>å››ã€å®æˆ˜æ¼”ç¤º</h2><p>å¸¸ç”¨çš„æ¢é’ˆå¯é€‰å‚æ•°ï¼š</p><table><thead><tr><th>å‚æ•°åç§°</th><th>é»˜è®¤å€¼</th><th>æœ€å°å€¼</th><th>æè¿°</th></tr></thead><tbody><tr><td>initialDelaySeconds</td><td>0ç§’</td><td>0ç§’</td><td>æ¢æµ‹å»¶è¿Ÿæ—¶é•¿ï¼Œå®¹å™¨å¯åŠ¨åå¤šä¹…å¼€å§‹è¿›è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å·¥ä½œã€‚</td></tr><tr><td>periodSeconds</td><td>10ç§’</td><td>1ç§’</td><td>æ¢æµ‹é¢‘åº¦ï¼Œé¢‘ç‡è¿‡é«˜ä¼šå¯¹podå¸¦æ¥è¾ƒå¤§çš„é¢å¤–å¼€é”€ï¼Œé¢‘ç‡è¿‡ä½åˆ™æ— æ³•åŠæ—¶åæ˜ å®¹å™¨äº§ç”Ÿçš„é”™è¯¯ã€‚</td></tr><tr><td>timeoutSeconds</td><td>1ç§’</td><td>1ç§’</td><td>æ¢æµ‹çš„è¶…æ—¶æ—¶é•¿ã€‚</td></tr><tr><td>failureThreshold</td><td>3</td><td>1</td><td>å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</td></tr><tr><td>successThreshold</td><td>1</td><td>1</td><td>å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</td></tr></tbody></table><h3 id="1ï¼‰execæ–¹å¼"><a href="#1ï¼‰execæ–¹å¼" class="headerlink" title="1ï¼‰execæ–¹å¼"></a>1ï¼‰execæ–¹å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;exec-liveness.yaml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    test: liveness</span></span><br><span class="line"><span class="string">  name: liveness-exec</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  # ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼ŒæŒ‡å®šè°ƒåº¦æœºå™¨</span></span><br><span class="line"><span class="string">  nodeName: local-168-182-110</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: liveness</span></span><br><span class="line"><span class="string">    image: registry.aliyuncs.com/google_containers/busybox</span></span><br><span class="line"><span class="string">    args:</span></span><br><span class="line"><span class="string">    - /bin/sh</span></span><br><span class="line"><span class="string">    - -c</span></span><br><span class="line"><span class="string">    - touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      exec:</span></span><br><span class="line"><span class="string">        command:</span></span><br><span class="line"><span class="string">        - cat</span></span><br><span class="line"><span class="string">        - /tmp/healthy</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      periodSeconds: 5</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼š</p><ul><li><p><code>initialDelaySeconds</code>Â å­—æ®µå‘Šè¯‰ kubelet åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥<strong>ç­‰å¾… 5 ç§’</strong>ã€‚</p></li><li><p><code>periodSeconds</code>Â å­—æ®µæŒ‡å®šäº† kubelet åº”è¯¥<strong>æ¯ 5 ç§’æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢æµ‹</strong>ã€‚</p></li><li><p>kubelet åœ¨å®¹å™¨å†…æ‰§è¡Œå‘½ä»¤Â <strong>cat &#x2F;tmp&#x2F;healthy æ¥è¿›è¡Œæ¢æµ‹</strong>ã€‚</p></li><li><p>å¦‚æœå‘½ä»¤æ‰§è¡ŒæˆåŠŸå¹¶ä¸”è¿”å›å€¼ä¸º 0ï¼Œkubelet å°±ä¼šè®¤ä¸ºè¿™ä¸ªå®¹å™¨æ˜¯å¥åº·å­˜æ´»çš„ã€‚</p></li><li><p>å¦‚æœè¿™ä¸ªå‘½ä»¤è¿”å›é 0 å€¼ï¼Œkubelet ä¼šæ€æ­»è¿™ä¸ªå®¹å™¨å¹¶é‡æ–°å¯åŠ¨å®ƒã€‚</p></li><li><p>å½“å®¹å™¨å¯åŠ¨æ—¶ï¼Œæ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤ï¼š</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/sh -c <span class="string">&quot;touch /tmp/healthy; sleep 30; rm -f /tmp/healthy; sleep 600&quot;</span></span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªå®¹å™¨ç”Ÿå‘½çš„å‰ 30 ç§’ï¼Œ&#x2F;tmp&#x2F;healthy æ–‡ä»¶æ˜¯å­˜åœ¨çš„ã€‚ æ‰€ä»¥åœ¨è¿™æœ€å¼€å§‹çš„ 30 ç§’å†…ï¼Œæ‰§è¡Œå‘½ä»¤ cat &#x2F;tmp&#x2F;healthy ä¼šè¿”å›æˆåŠŸä»£ç ã€‚ 30 ç§’ä¹‹åï¼Œæ‰§è¡Œå‘½ä»¤ cat &#x2F;tmp&#x2F;healthy å°±ä¼šè¿”å›å¤±è´¥ä»£ç ã€‚</li></ul><p>åˆ›å»º Podï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æœ€å¥½å…ˆæ‹‰å–é•œåƒï¼Œå¦‚æœæ˜¯ä½¿ç”¨dockerï¼Œå°±æ¢æˆdockerå°±è¡Œ</span></span><br><span class="line">crictl pull registry.aliyuncs.com/google_containers/busybox</span><br><span class="line"></span><br><span class="line">kubectl apply -f exec-liveness.yaml</span><br></pre></td></tr></table></figure><p>ã€é—®é¢˜ã€‘<code>ERRO[0000] unable to determine image API version: rpc error: code = Unavailable desc = connection error: desc = â€œtransport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directoryâ€</code><br>ã€è§£å†³ã€‘åŸå› ï¼šæœªé…ç½®endpoints</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">crictl config runtime-endpoint unix:///run/containerd/containerd.sock</span><br><span class="line">crictl config image-endpoint unix:///run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod liveness-exec</span><br></pre></td></tr></table></figure><p>ã€ç°è±¡ã€‘30sä¹‹åæ£€æŸ¥å¤±è´¥åå°±é‡å¯podäº†ï¼Œåˆæ­£å¸¸äº†ã€‚</p><h3 id="2ï¼‰httpGet-æ–¹å¼"><a href="#2ï¼‰httpGet-æ–¹å¼" class="headerlink" title="2ï¼‰httpGet æ–¹å¼"></a>2ï¼‰httpGet æ–¹å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt;http-liveness.yaml&lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: liveness-httpget</span></span><br><span class="line"><span class="string">  namespace: default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  # ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼ŒæŒ‡å®šè°ƒåº¦æœºå™¨</span></span><br><span class="line"><span class="string">  nodeName: local-168-182-110</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: liveness-httpget-container</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    imagePullPolicy: IfNotPresent</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - name: nginx</span></span><br><span class="line"><span class="string">      containerPort: 80</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      httpGet:</span></span><br><span class="line"><span class="string">        port: nginx</span></span><br><span class="line"><span class="string">        path: /index.html</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 1</span></span><br><span class="line"><span class="string">      periodSeconds: 3</span></span><br><span class="line"><span class="string">      timeoutSeconds: 10</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼š</p><ul><li><p><code>initialDelaySeconds</code>å­—æ®µå‘Šè¯‰ kubelet åœ¨æ‰§è¡Œç¬¬ä¸€æ¬¡æ¢æµ‹å‰åº”è¯¥<strong>ç­‰å¾… 1 ç§’</strong>ã€‚</p></li><li><p><code>periodSeconds</code>Â å­—æ®µæŒ‡å®šäº† kubeletÂ <strong>æ¯éš” 3 ç§’</strong>æ‰§è¡Œä¸€æ¬¡å­˜æ´»æ¢æµ‹ã€‚</p></li><li><p>kubelet ä¼šå‘å®¹å™¨å†…è¿è¡Œçš„æœåŠ¡ï¼ˆæœåŠ¡åœ¨ç›‘å¬ 80 ç«¯å£ï¼‰å‘é€ä¸€ä¸ª HTTP GET è¯·æ±‚æ¥æ‰§è¡Œæ¢æµ‹ã€‚</p></li><li><p>å¦‚æœæœåŠ¡å™¨ä¸Š<code>/index.html</code>è·¯å¾„ä¸‹çš„å¤„ç†ç¨‹åºè¿”å›æˆåŠŸä»£ç ï¼Œåˆ™ kubelet è®¤ä¸ºå®¹å™¨æ˜¯å¥åº·å­˜æ´»çš„ã€‚</p></li><li><p>å¦‚æœå¤„ç†ç¨‹åºè¿”å›å¤±è´¥ä»£ç ï¼Œåˆ™ kubelet ä¼šæ€æ­»è¿™ä¸ªå®¹å™¨å¹¶å°†å…¶é‡å¯ã€‚</p></li><li><p>è¿”å›<strong>å¤§äºæˆ–ç­‰äºÂ <code>200</code></strong>Â å¹¶ä¸”<strong>å°äºÂ <code>400</code></strong>Â çš„ä»»ä½•ä»£ç éƒ½<strong>æ ‡ç¤ºæˆåŠŸ</strong>ï¼Œå…¶å®ƒè¿”å›ä»£ç éƒ½æ ‡ç¤ºå¤±è´¥ã€‚</p></li></ul><p>æ‰§è¡Œå¹¶æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crictl pull nginx</span><br><span class="line">kubectl apply -f http-liveness.yaml</span><br><span class="line">kubectl describe pod liveness-httpget</span><br></pre></td></tr></table></figure><p>åˆ é™¤ Pod çš„ index.html æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">exec</span> -it liveness-httpget -- <span class="built_in">rm</span> -rf /usr/share/nginx/html/index.html</span><br><span class="line"><span class="comment"># å†æŸ¥çœ‹</span></span><br><span class="line">kubectl describe pod liveness-httpget</span><br><span class="line">kubectl get pod liveness-httpget</span><br></pre></td></tr></table></figure><ul><li><p>é‡å¯åŸå› æ˜¯ HTTP æ¢æµ‹å¾—åˆ°çš„çŠ¶æ€è¿”å›ç æ˜¯ 404ï¼Œ<code>Liveness probe failed: HTTP probe failed with statuscode: 404</code>ã€‚</p></li><li><p>é‡å¯å®Œæˆåï¼Œä¸ä¼šå†æ¬¡é‡å¯ï¼Œå› ä¸ºé‡æ–°æ‹‰å–çš„é•œåƒä¸­åŒ…å«äº† index.html æ–‡ä»¶ã€‚</p></li></ul><p>HTTP Probes å…è®¸é’ˆå¯¹ httpGet é…ç½®é¢å¤–çš„å­—æ®µï¼š</p><ul><li><p><code>host</code>ï¼šè¿æ¥ä½¿ç”¨çš„ä¸»æœºåï¼Œé»˜è®¤æ˜¯ Pod çš„ IPã€‚ä¹Ÿå¯ä»¥åœ¨ HTTP å¤´ä¸­è®¾ç½® â€œHostâ€ æ¥ä»£æ›¿ã€‚</p></li><li><p><code>scheme</code>Â ï¼šç”¨äºè®¾ç½®è¿æ¥ä¸»æœºçš„æ–¹å¼ï¼ˆHTTP è¿˜æ˜¯ HTTPSï¼‰ã€‚é»˜è®¤æ˜¯ â€œHTTPâ€ã€‚</p></li><li><p><code>path</code>ï¼šè®¿é—® HTTP æœåŠ¡çš„è·¯å¾„ã€‚é»˜è®¤å€¼ä¸º â€œ&#x2F;â€œã€‚</p></li><li><p><code>httpHeaders</code>ï¼šè¯·æ±‚ä¸­è‡ªå®šä¹‰çš„ HTTP å¤´ã€‚HTTP å¤´å­—æ®µå…è®¸é‡å¤ã€‚</p></li><li><p><code>port</code>ï¼šè®¿é—®å®¹å™¨çš„ç«¯å£å·æˆ–è€…ç«¯å£åã€‚å¦‚æœæ•°å­—å¿…é¡»åœ¨ 1ï½65535 ä¹‹é—´ã€‚</p></li></ul><p>ä½ å¯ä»¥é€šè¿‡ä¸ºæ¢æµ‹è®¾ç½® .httpHeaders æ¥é‡è½½é»˜è®¤çš„å¤´éƒ¨å­—æ®µå€¼ï¼›ä¾‹å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">httpHeaders:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Accept</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">application/json</span></span><br><span class="line"></span><br><span class="line"><span class="attr">startupProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">httpHeaders:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">User-Agent</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">MyUserAgent</span></span><br></pre></td></tr></table></figure><h3 id="3ï¼‰tcpSocket-æ–¹å¼"><a href="#3ï¼‰tcpSocket-æ–¹å¼" class="headerlink" title="3ï¼‰tcpSocket æ–¹å¼"></a>3ï¼‰tcpSocket æ–¹å¼</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; tcp-liveness-readiness.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Pod</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: liveness-readiness-tcpsocket</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    app: liveness-readiness-tcpsocket</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  # ä¸ºäº†æµ‹è¯•æ–¹ä¾¿ï¼ŒæŒ‡å®šè°ƒåº¦æœºå™¨</span></span><br><span class="line"><span class="string">  nodeName: local-168-182-110</span></span><br><span class="line"><span class="string">  containers:</span></span><br><span class="line"><span class="string">  - name: liveness-readiness-tcpsocket</span></span><br><span class="line"><span class="string">    image: nginx</span></span><br><span class="line"><span class="string">    ports:</span></span><br><span class="line"><span class="string">    - containerPort: 80</span></span><br><span class="line"><span class="string">    readinessProbe:</span></span><br><span class="line"><span class="string">      tcpSocket:</span></span><br><span class="line"><span class="string">        port: 80</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 5</span></span><br><span class="line"><span class="string">      periodSeconds: 10</span></span><br><span class="line"><span class="string">    livenessProbe:</span></span><br><span class="line"><span class="string">      tcpSocket:</span></span><br><span class="line"><span class="string">        port: 80</span></span><br><span class="line"><span class="string">      initialDelaySeconds: 15</span></span><br><span class="line"><span class="string">      periodSeconds: 20</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>è§£é‡Šï¼š</p><ul><li><p>kubelet ä¼šåœ¨å®¹å™¨å¯åŠ¨ 5 ç§’åå‘é€ç¬¬ä¸€ä¸ª<strong>å°±ç»ªæ¢æµ‹ï¼ˆlivenessProbeï¼‰</strong>ã€‚</p></li><li><p>æ¢æµ‹å™¨ä¼šå°è¯•è¿æ¥ goproxy å®¹å™¨çš„ 80 ç«¯å£ã€‚ å¦‚æœæ¢æµ‹æˆåŠŸï¼Œè¿™ä¸ª Pod ä¼šè¢«æ ‡è®°ä¸ºå°±ç»ªçŠ¶æ€ï¼Œkubelet å°†ç»§ç»­æ¯éš” 10 ç§’è¿è¡Œä¸€æ¬¡æ£€æµ‹ã€‚</p></li><li><p>é™¤äº†å°±ç»ªæ¢æµ‹ï¼Œè¿™ä¸ªé…ç½®åŒ…æ‹¬äº†ä¸€ä¸ª<strong>å­˜æ´»æ¢æµ‹ï¼ˆlivenessProbeï¼‰</strong>ã€‚</p></li><li><p>kubelet ä¼šåœ¨å®¹å™¨å¯åŠ¨Â <strong>15 ç§’åè¿›è¡Œç¬¬ä¸€æ¬¡å­˜æ´»æ¢æµ‹ï¼ˆlivenessProbeï¼‰</strong>ã€‚</p></li><li><p>ä¸å°±ç»ªæ¢æµ‹ç±»ä¼¼ï¼Œæ´»è·ƒæ¢æµ‹å™¨ä¼šå°è¯•è¿æ¥ goproxy å®¹å™¨çš„ 80 ç«¯å£ã€‚ å¦‚æœå­˜æ´»æ¢æµ‹å¤±è´¥ï¼Œå®¹å™¨ä¼šè¢«é‡æ–°å¯åŠ¨ã€‚<br>æ‰§è¡Œ</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f tcp-liveness-readiness.yaml</span><br><span class="line">kubectl get pod liveness-readiness-tcpsocket</span><br><span class="line">kubectl describe pod liveness-readiness-tcpsocket</span><br></pre></td></tr></table></figure><h3 id="4ï¼‰ä½¿ç”¨å‘½åç«¯å£"><a href="#4ï¼‰ä½¿ç”¨å‘½åç«¯å£" class="headerlink" title="4ï¼‰ä½¿ç”¨å‘½åç«¯å£"></a>4ï¼‰ä½¿ç”¨å‘½åç«¯å£</h3><blockquote><p>å¯¹äº HTTP æˆ–è€… TCP å­˜æ´»æ£€æµ‹å¯ä»¥ä½¿ç”¨å‘½åçš„ portã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure><p><strong>å®Œæ•´ç‰ˆé…ç½®</strong></p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ports:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">hostPort:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># readinessProbeï¼Œå°±ç»ªæ¢é’ˆ</span></span><br><span class="line"><span class="attr">readinessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># livenessProbeï¼Œå­˜æ´»æ¢é’ˆ</span></span><br><span class="line"><span class="attr">livenessProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># startupProbeï¼Œå¯åŠ¨æ¢é’ˆ</span></span><br><span class="line"><span class="attr">startupProbe:</span></span><br><span class="line">  <span class="attr">httpGet:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">    <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">  <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">  <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">  <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">  <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">  <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">  <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">  <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">  <span class="attr">successThreshold:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ä½¿ç”¨æ§åˆ¶å™¨å»åˆ›å»ºç®¡ç†podï¼Œå¯¹k8s æ§åˆ¶å™¨ä¸æ¸…æ™°çš„å°ä¼™ä¼´ï¼Œå¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼šKubernetesï¼ˆk8sï¼‰Deploymentã€StatefulSetã€DaemonSetã€Jobã€CronJobäº”ç§æ§åˆ¶å™¨è¯¦è§£</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªå®Œæ•´ç‰ˆçš„ç¤ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">deployment-probe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">deployment-probe</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">deployment-probe</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.17.1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># readinessProbeï¼Œå°±ç»ªæ¢é’ˆ</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># livenessProbeï¼Œå­˜æ´»æ¢é’ˆ</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment"># startupProbeï¼Œå¯åŠ¨æ¢é’ˆ</span></span><br><span class="line">        <span class="attr">startupProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/index.html</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">nginx</span></span><br><span class="line">          <span class="comment"># å»¶è¿Ÿå¤šä¹…åå¼€å§‹æ¢æµ‹</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment"># æ‰§è¡Œæ¢æµ‹é¢‘ç‡(ç§’) ã€ æ¯éš”ç§’æ‰§è¡Œä¸€æ¬¡ ã€‘</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="comment">#  è¶…æ—¶æ—¶é—´</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">1</span></span><br><span class="line">          <span class="comment"># å¤„äºæˆåŠŸçŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­å¤±è´¥å‡ æ¬¡å¯è¢«è®¤ä¸ºå¤±è´¥ã€‚</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="comment"># å¤„äºå¤±è´¥çŠ¶æ€æ—¶ï¼Œæ¢æµ‹è¿ç»­æˆåŠŸå‡ æ¬¡ï¼Œè¢«è®¤ä¸ºæˆåŠŸã€‚</span></span><br><span class="line">          <span class="attr">successThreshold:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">crictl pull nginx:1.17.1</span><br><span class="line">kubectl apply -f deployment-probe.yaml</span><br><span class="line">kubectl get pod,deploy</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰6ã€kube-proxyã€Serviceè¯¦è§£</title>
    <link href="https://blog.yongwang.lu/post/9f7e260b.html"/>
    <id>https://blog.yongwang.lu/post/9f7e260b.html</id>
    <published>2023-01-05T07:40:00.000Z</published>
    <updated>2023-01-05T07:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€kube-proxyç®€ä»‹"><a href="#ä¸€ã€kube-proxyç®€ä»‹" class="headerlink" title="ä¸€ã€kube-proxyç®€ä»‹"></a>ä¸€ã€kube-proxyç®€ä»‹</h2><blockquote><p><strong>kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡</strong>ï¼Œå®ƒè¿è¡Œåœ¨æ¯ä¸ªNodeè®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£Podç½‘ç»œä»£ç†, å®ƒä¼šå®šæ—¶ä»etcdæœåŠ¡è·å–åˆ°serviceä¿¡æ¯æ¥åšç›¸åº”çš„ç­–ç•¥ï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™å’Œå››å±‚è´Ÿè½½å‡è¡¡å·¥ä½œã€‚åœ¨K8sé›†ç¾¤ä¸­å¾®æœåŠ¡çš„è´Ÿè½½å‡è¡¡æ˜¯ç”±Kube-proxyå®ç°çš„ï¼Œå®ƒæ˜¯K8sé›†ç¾¤å†…éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»£ç†æœåŠ¡å™¨ï¼Œåœ¨K8sçš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ªï¼Œè¿™ä¸€è®¾è®¡ä½“ç°äº†å®ƒçš„ä¼¸ç¼©æ€§ä¼˜åŠ¿ï¼Œéœ€è¦è®¿é—®æœåŠ¡çš„èŠ‚ç‚¹è¶Šå¤šï¼Œæä¾›è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„Kube-proxyå°±è¶Šå¤šï¼Œé«˜å¯ç”¨èŠ‚ç‚¹ä¹Ÿéšä¹‹å¢å¤šã€‚</p></blockquote><blockquote><p><strong>serviceæ˜¯ä¸€ç»„podçš„æœåŠ¡æŠ½è±¡ï¼Œç›¸å½“äºä¸€ç»„podçš„LB</strong>ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„podã€‚serviceä¼šä¸ºè¿™ä¸ªLBæä¾›ä¸€ä¸ªIPï¼Œä¸€èˆ¬ç§°ä¸ºcluster IPã€‚<strong>kube-proxyçš„ä½œç”¨ä¸»è¦æ˜¯è´Ÿè´£serviceçš„å®ç°</strong>ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°äº†å†…éƒ¨ä»podåˆ°serviceå’Œå¤–éƒ¨çš„ä»node portå‘serviceçš„è®¿é—®ã€‚</p></blockquote><p>ç®€å•æ¥è¯´:</p><ul><li><p>kube-proxyå…¶å®å°±æ˜¯ç®¡ç†serviceçš„è®¿é—®å…¥å£ï¼ŒåŒ…æ‹¬é›†ç¾¤å†…Podåˆ°Serviceçš„è®¿é—®å’Œé›†ç¾¤å¤–è®¿é—®serviceã€‚</p></li><li><p>kube-proxyç®¡ç†seviceçš„Endpointsï¼Œè¯¥serviceå¯¹å¤–æš´éœ²ä¸€ä¸ªVirtual IPï¼Œä¹Ÿæˆä¸ºCluster IP, é›†ç¾¤å†…é€šè¿‡è®¿é—®è¿™ä¸ªCluster IP:Portå°±èƒ½è®¿é—®åˆ°é›†ç¾¤å†…å¯¹åº”çš„serivceä¸‹çš„Podã€‚</p></li><li><p>serviceæ˜¯é€šè¿‡Selectoré€‰æ‹©çš„ä¸€ç»„Podsçš„æœåŠ¡æŠ½è±¡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œæä¾›äº†æœåŠ¡çš„LBå’Œåå‘ä»£ç†çš„èƒ½åŠ›ï¼Œè€Œkube-proxyçš„ä¸»è¦ä½œç”¨å°±æ˜¯è´Ÿè´£serviceçš„å®ç°ã€‚</p></li><li><p>serviceå¦å¤–ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡åç«¯çš„Podså¯èƒ½ä¼šéšç€ç”Ÿå­˜ç­äº¡è€Œå‘ç”ŸIPçš„æ”¹å˜ï¼Œserviceçš„å‡ºç°ï¼Œç»™æœåŠ¡æä¾›äº†ä¸€ä¸ªå›ºå®šçš„IPï¼Œè€Œæ— è§†åç«¯Endpointçš„å˜åŒ–ã€‚</p></li></ul><h2 id="äºŒã€Service-ç®€ä»‹"><a href="#äºŒã€Service-ç®€ä»‹" class="headerlink" title="äºŒã€Service ç®€ä»‹"></a>äºŒã€Service ç®€ä»‹</h2><blockquote><p>Kubernetes Serviceå®šä¹‰äº†è¿™æ ·ä¸€ç§æŠ½è±¡ï¼š Serviceæ˜¯ä¸€ç§å¯ä»¥è®¿é—® Podé€»è¾‘åˆ†ç»„çš„ç­–ç•¥ï¼Œ Serviceé€šå¸¸æ˜¯é€šè¿‡ Label Selectorè®¿é—® Podç»„ã€‚</p></blockquote><blockquote><p>Serviceèƒ½å¤Ÿæä¾›è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸Šæœ‰ä»¥ä¸‹é™åˆ¶ï¼š<strong>åªæä¾› 4 å±‚è´Ÿè½½å‡è¡¡èƒ½åŠ›</strong>ï¼Œè€Œæ²¡æœ‰ 7 å±‚åŠŸèƒ½ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¯èƒ½éœ€è¦æ›´å¤šçš„åŒ¹é…è§„åˆ™æ¥è½¬å‘è¯·æ±‚ï¼Œè¿™ç‚¹ä¸Š 4 å±‚è´Ÿè½½å‡è¡¡æ˜¯ä¸æ”¯æŒçš„ã€‚</p></blockquote><h2 id="ä¸‰ã€Service-ç±»å‹"><a href="#ä¸‰ã€Service-ç±»å‹" class="headerlink" title="ä¸‰ã€Service ç±»å‹"></a>ä¸‰ã€Service ç±»å‹</h2><p>Serviceåœ¨ K8sä¸­æœ‰ä»¥ä¸‹å››ç§ç±»å‹ï¼š</p><h3 id="1ï¼‰ClusterIpï¼ˆé›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰"><a href="#1ï¼‰ClusterIpï¼ˆé›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰" class="headerlink" title="1ï¼‰ClusterIpï¼ˆé›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰"></a>1ï¼‰ClusterIpï¼ˆé›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰</h3><blockquote><p><strong>é»˜è®¤ç±»å‹</strong>ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…Clusterå†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹ŸIPï¼ˆVIPï¼‰ã€‚</p></blockquote><h3 id="2ï¼‰NodePortï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼‰"><a href="#2ï¼‰NodePortï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼‰" class="headerlink" title="2ï¼‰NodePortï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼‰"></a>2ï¼‰NodePortï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼‰</h3><blockquote><p>åœ¨ClusterIPåŸºç¡€ä¸Šä¸ºServiceåœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡NodeIP:NodePortè®¿é—®æ¥è®¿é—®è¯¥æœåŠ¡ã€‚<br>ç«¯å£èŒƒå›´ï¼š30000~32767</p></blockquote><h3 id="3ï¼‰LoadBalancerï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨äºå…¬æœ‰äº‘ï¼‰"><a href="#3ï¼‰LoadBalancerï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨äºå…¬æœ‰äº‘ï¼‰" class="headerlink" title="3ï¼‰LoadBalancerï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨äºå…¬æœ‰äº‘ï¼‰"></a>3ï¼‰LoadBalancerï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨äºå…¬æœ‰äº‘ï¼‰</h3><blockquote><p>åœ¨NodePortçš„åŸºç¡€ä¸Šï¼Œå€ŸåŠ©Cloud Provideråˆ›å»ºä¸€ä¸ªå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°NodePortã€‚</p></blockquote><h3 id="4ï¼‰ExternalName"><a href="#4ï¼‰ExternalName" class="headerlink" title="4ï¼‰ExternalName"></a>4ï¼‰ExternalName</h3><blockquote><p>åˆ›å»ºä¸€ä¸ªdnsåˆ«åæŒ‡åˆ°service nameä¸Šï¼Œä¸»è¦æ˜¯é˜²æ­¢service nameå‘ç”Ÿå˜åŒ–ï¼Œè¦é…åˆdnsæ’ä»¶ä½¿ç”¨ã€‚é€šè¿‡è¿”å› CNAME å’Œå®ƒçš„å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° externalName å­—æ®µçš„å†…å®¹ã€‚è¿™åªæœ‰ Kubernetes 1.7æˆ–æ›´é«˜ç‰ˆæœ¬çš„kube-dnsæ‰æ”¯æŒï¼ˆ<strong>æˆ‘è¿™é‡Œæ˜¯Kubernetes 1.22.1ç‰ˆæœ¬</strong>ï¼‰ã€‚</p></blockquote><h2 id="å››ã€Service-å·¥ä½œæµç¨‹"><a href="#å››ã€Service-å·¥ä½œæµç¨‹" class="headerlink" title="å››ã€Service å·¥ä½œæµç¨‹"></a>å››ã€Service å·¥ä½œæµç¨‹</h2><p><img src="https://res.yongwang.lu/img/20230322225854.png" alt="Service å·¥ä½œæµç¨‹"></p><ol><li><p>å®¢æˆ·ç«¯è®¿é—®èŠ‚ç‚¹æ—¶é€šè¿‡ iptableså®ç°çš„</p></li><li><p>iptablesè§„åˆ™æ˜¯é€šè¿‡ kube-proxyå†™å…¥çš„</p></li><li><p>apiserveré€šè¿‡ç›‘æ§ kube-proxyå»è¿›è¡Œå¯¹æœåŠ¡å’Œç«¯ç‚¹çš„ç›‘æ§</p></li><li><p>kube-proxyé€šè¿‡ podçš„æ ‡ç­¾ï¼ˆ lablesï¼‰å»åˆ¤æ–­è¿™ä¸ªæ–­ç‚¹ä¿¡æ¯æ˜¯å¦å†™å…¥åˆ° Endpointsé‡Œ</p></li></ol><h2 id="äº”ã€Endpointsç®€ä»‹"><a href="#äº”ã€Endpointsç®€ä»‹" class="headerlink" title="äº”ã€Endpointsç®€ä»‹"></a>äº”ã€Endpointsç®€ä»‹</h2><blockquote><p>endpointæ˜¯k8sé›†ç¾¤ä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œ<strong>ç”¨æ¥è®°å½•ä¸€ä¸ªserviceå¯¹åº”çš„æ‰€æœ‰podçš„è®¿é—®åœ°å€</strong>ã€‚serviceé…ç½®selectorï¼Œendpoint controlleræ‰ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„endpointå¯¹è±¡ï¼›å¦åˆ™ï¼Œä¸ä¼šç”Ÿæˆendpointå¯¹è±¡ã€‚</p></blockquote><blockquote><p>ã€ä¾‹å¦‚ã€‘k8sé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºhelloçš„serviceï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªåŒåçš„endpointå¯¹è±¡ï¼ŒENDPOINTSå°±æ˜¯serviceå…³è”çš„podçš„ipåœ°å€å’Œç«¯å£ã€‚</p></blockquote><h3 id="1ï¼‰å·¥ä½œæµç¨‹"><a href="#1ï¼‰å·¥ä½œæµç¨‹" class="headerlink" title="1ï¼‰å·¥ä½œæµç¨‹"></a>1ï¼‰å·¥ä½œæµç¨‹</h3><blockquote><p><strong>ä¸€ä¸ª Service ç”±ä¸€ç»„ backend Pod ç»„æˆã€‚è¿™äº› Pod é€šè¿‡ endpoints æš´éœ²å‡ºæ¥</strong>ã€‚ Service Selector å°†æŒç»­è¯„ä¼°ï¼Œç»“æœè¢« POST åˆ°ä¸€ä¸ªåç§°ä¸º Service-hello çš„ Endpoint å¯¹è±¡ä¸Šã€‚ å½“ Pod ç»ˆæ­¢åï¼Œå®ƒä¼šè‡ªåŠ¨ä» Endpoint ä¸­ç§»é™¤ï¼Œæ–°çš„èƒ½å¤ŸåŒ¹é…ä¸Š Service Selector çš„ Pod å°†è‡ªåŠ¨åœ°è¢«æ·»åŠ åˆ° Endpoint ä¸­ã€‚ æ£€æŸ¥è¯¥ Endpointï¼Œæ³¨æ„åˆ° IP åœ°å€ä¸åˆ›å»ºçš„ Pod æ˜¯ç›¸åŒçš„ã€‚ç°åœ¨ï¼Œèƒ½å¤Ÿä»é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹ä¸Šä½¿ç”¨ curl å‘½ä»¤è¯·æ±‚ hello Service <CLUSTER-IP>:<PORT> ã€‚</p></blockquote><h3 id="2ï¼‰ç¤ºä¾‹"><a href="#2ï¼‰ç¤ºä¾‹" class="headerlink" title="2ï¼‰ç¤ºä¾‹"></a>2ï¼‰ç¤ºä¾‹</h3><p>1ã€deployment-hello.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; deployment-hello.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">     run: hello</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: hello</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.17.1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>2ã€service-hello.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; service-hello.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: service-hello</span><br><span class="line">  labels:</span><br><span class="line">  name: service-hello</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort      #è¿™é‡Œä»£è¡¨æ˜¯NodePortç±»å‹çš„,å¦å¤–è¿˜æœ‰ingress,LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80          </span><br><span class="line">    targetPort: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 31111   # æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šå¼€æ”¾æ­¤ç«¯å£30000--32767ï¼Œæ­¤ç«¯å£ä¾›å¤–éƒ¨è°ƒç”¨ã€‚</span><br><span class="line">  selector:</span><br><span class="line">    run: hello</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹éªŒè¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f deployment-hello.yaml</span><br><span class="line">$ kubectl apply -f service-hello.yaml</span><br><span class="line"># æŸ¥çœ‹podï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰é•œåƒï¼Œå¯èƒ½ç­‰å¾…çš„æ—¶å€™æ¯”è¾ƒé•¿ï¼Œä¸€å®šè¦ç­‰åˆ°æ‰€æœ‰podéƒ½åœ¨è¿è¡Œä¸­æ‰è¡Œã€‚</span><br><span class="line">$ kubectl get pod -o wide|grep hello-*</span><br><span class="line"># æŸ¥çœ‹service</span><br><span class="line">$ kubectl get service service-hello -o wide</span><br><span class="line"># æŸ¥çœ‹serviceè¯¦æƒ…</span><br><span class="line">$ kubectl describe service service-hello</span><br><span class="line"># æŸ¥çœ‹pointer</span><br><span class="line">$ kubectl get endpoints service-hello</span><br></pre></td></tr></table></figure><h2 id="å…­ã€Service-Endpointsä¸Podçš„å…³ç³»"><a href="#å…­ã€Service-Endpointsä¸Podçš„å…³ç³»" class="headerlink" title="å…­ã€Service, Endpointsä¸Podçš„å…³ç³»"></a>å…­ã€Service, Endpointsä¸Podçš„å…³ç³»</h2><p><img src="https://res.yongwang.lu/img/20230322230158.png" alt="Service, Endpointsä¸Podçš„å…³ç³»"></p><blockquote><p>Kube-proxyè¿›ç¨‹è·å–æ¯ä¸ªServiceçš„Endpoints,å®ç°Serviceçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p></blockquote><p>Serviceçš„è´Ÿè½½å‡è¡¡è½¬å‘è§„åˆ™<br><img src="https://res.yongwang.lu/img/20230322230057.png" alt="Serviceçš„è´Ÿè½½å‡è¡¡è½¬å‘è§„åˆ™ "></p><blockquote><p>è®¿é—®Serviceçš„è¯·æ±‚ï¼Œä¸è®ºæ˜¯Cluster IP+TargetPortçš„æ–¹å¼ï¼›è¿˜æ˜¯ç”¨NodeèŠ‚ç‚¹IP+NodePortçš„æ–¹å¼ï¼Œéƒ½è¢«NodeèŠ‚ç‚¹çš„Iptablesè§„åˆ™é‡å®šå‘åˆ°Kube-proxyç›‘å¬ServiceæœåŠ¡ä»£ç†ç«¯å£ã€‚kube-proxyæ¥æ”¶åˆ°Serviceçš„è®¿é—®è¯·æ±‚åï¼Œæ ¹æ®è´Ÿè½½ç­–ç•¥ï¼Œè½¬å‘åˆ°åç«¯çš„Podã€‚</p></blockquote><h2 id="ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£"><a href="#ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£" class="headerlink" title="ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£"></a>ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">#å…ƒæ•°æ®</span><br><span class="line">  name: string</span><br><span class="line">  #Serviceåç§°</span><br><span class="line">  namespace: string</span><br><span class="line">  #å‘½åç©ºé—´ï¼Œä¸æŒ‡å®šæ—¶é»˜è®¤ä¸ºdefaultå‘½åç©ºé—´</span><br><span class="line">  labels:</span><br><span class="line">  #è‡ªå®šä¹‰æ ‡ç­¾å±æ€§åˆ—è¡¨     </span><br><span class="line">    - name: string</span><br><span class="line">  annotations:</span><br><span class="line">  #è‡ªå®šä¹‰æ³¨è§£å±æ€§åˆ—è¡¨    </span><br><span class="line">    - name: string</span><br><span class="line">spec:</span><br><span class="line">#è¯¦ç»†æè¿°    </span><br><span class="line">  selector: []</span><br><span class="line">  #è¿™é‡Œé€‰æ‹©å™¨ä¸€å®šè¦é€‰æ‹©å®¹å™¨çš„æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯podçš„æ ‡ç­¾</span><br><span class="line">  #selector:</span><br><span class="line">  #  app: web</span><br><span class="line">  #Label Selectoré…ç½®ï¼Œé€‰æ‹©å…·æœ‰æŒ‡å®šlabelæ ‡ç­¾çš„podä½œä¸ºç®¡ç†èŒƒå›´</span><br><span class="line">  type: string</span><br><span class="line">  #serviceçš„ç±»å‹ï¼ŒæŒ‡å®šserviceçš„è®¿é—®æ–¹å¼ï¼Œé»˜è®¤ClusterIP</span><br><span class="line">  #ClusterIPï¼šè™šæ‹Ÿçš„æœåŠ¡ipåœ°å€ï¼Œç”¨äºk8sé›†ç¾¤å†…éƒ¨çš„podè®¿é—®ï¼Œåœ¨Nodeä¸Škube-porxyé€šè¿‡è®¾ç½®çš„iptablesè§„åˆ™è¿›è¡Œè½¬å‘</span><br><span class="line">  #NodePortï¼šä½¿ç”¨å®¿ä¸»æœºç«¯å£ï¼Œèƒ½å¤Ÿè®¿é—®å„Nodeçš„å¤–éƒ¨å®¢æˆ·ç«¯é€šè¿‡Nodeçš„IPå’Œç«¯å£å°±èƒ½è®¿é—®æœåŠ¡å™¨</span><br><span class="line">  #LoadBalancerï¼šä½¿ç”¨å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡å™¨çš„è´Ÿè½½åˆ†å‘ï¼Œ</span><br><span class="line">  #éœ€è¦åœ¨spec.status.loadBalancerå­—æ®µæŒ‡å®šå¤–éƒ¨è´Ÿè½½å‡è¡¡æœåŠ¡å™¨çš„IPï¼Œå¹¶åŒæ—¶å®šä¹‰nodePortå’ŒclusterIPç”¨äºå…¬æœ‰äº‘ç¯å¢ƒã€‚</span><br><span class="line">  clusterIP: string</span><br><span class="line">  #è™šæ‹ŸæœåŠ¡IPåœ°å€ï¼Œå½“type=ClusterIPæ—¶ï¼Œå¦‚ä¸æŒ‡å®šï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚å½“type=loadBalancerï¼Œéœ€è¦æŒ‡å®š</span><br><span class="line">  sessionAffinity: string</span><br><span class="line">  #æ˜¯å¦æ”¯æŒsessionï¼Œå¯é€‰å€¼ä¸ºClietIPï¼Œé»˜è®¤å€¼ä¸ºç©º</span><br><span class="line">  #ClientIPè¡¨ç¤ºå°†åŒä¸€ä¸ªå®¢æˆ·ç«¯(æ ¹æ®å®¢æˆ·ç«¯IPåœ°å€å†³å®š)çš„è®¿é—®è¯·æ±‚éƒ½è½¬å‘åˆ°åŒä¸€ä¸ªåç«¯Pod</span><br><span class="line">  ports:</span><br><span class="line">  #serviceéœ€è¦æš´éœ²çš„ç«¯å£åˆ—è¡¨    </span><br><span class="line">  - name: string</span><br><span class="line">    #ç«¯å£åç§°</span><br><span class="line">    protocol: string</span><br><span class="line">    #ç«¯å£åè®®ï¼Œæ”¯æŒTCPæˆ–UDPï¼Œé»˜è®¤TCP</span><br><span class="line">     port: int</span><br><span class="line">    #æœåŠ¡ç›‘å¬çš„ç«¯å£å·</span><br><span class="line">     targetPort: int</span><br><span class="line">    #éœ€è¦è½¬å‘åˆ°åç«¯çš„ç«¯å£å·</span><br><span class="line">     nodePort: int</span><br><span class="line">    #å½“type=NodePortæ—¶ï¼ŒæŒ‡å®šæ˜ å°„åˆ°ç‰©ç†æœºçš„ç«¯å£å·</span><br><span class="line">  status:</span><br><span class="line">  #å½“type=LoadBalanceræ—¶ï¼Œè®¾ç½®å¤–éƒ¨è´Ÿè½½å‡è¡¡çš„åœ°å€ï¼Œç”¨äºå…¬æœ‰äº‘ç¯å¢ƒ    </span><br><span class="line">    loadBalancer:</span><br><span class="line">    #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨    </span><br><span class="line">      ingress:</span><br><span class="line">      #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ </span><br><span class="line">      ip: string</span><br><span class="line">      #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„IPåœ°å€</span><br><span class="line">      hostname: string</span><br><span class="line">     #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„æœºä¸»æœº</span><br></pre></td></tr></table></figure><h2 id="å…«ã€kubernetesä¸­çš„å››ç§port"><a href="#å…«ã€kubernetesä¸­çš„å››ç§port" class="headerlink" title="å…«ã€kubernetesä¸­çš„å››ç§port"></a>å…«ã€kubernetesä¸­çš„å››ç§port</h2><h3 id="1ï¼‰nodePort"><a href="#1ï¼‰nodePort" class="headerlink" title="1ï¼‰nodePort"></a>1ï¼‰nodePort</h3><blockquote><p><strong>nodePortæ˜¯å¤–éƒ¨è®¿é—®k8sé›†ç¾¤ä¸­serviceçš„ç«¯å£</strong>ï¼Œé€šè¿‡nodeIP: nodePortå¯ä»¥ä»å¤–éƒ¨è®¿é—®åˆ°æŸä¸ªserviceã€‚</p></blockquote><h3 id="2ï¼‰port"><a href="#2ï¼‰port" class="headerlink" title="2ï¼‰port"></a>2ï¼‰port</h3><blockquote><p><strong>portæ˜¯k8sé›†ç¾¤å†…éƒ¨è®¿é—®serviceçš„ç«¯å£</strong>ï¼Œå³é€šè¿‡clusterIP: portå¯ä»¥è®¿é—®åˆ°æŸä¸ªserviceã€‚</p></blockquote><h3 id="3ï¼‰targetPort"><a href="#3ï¼‰targetPort" class="headerlink" title="3ï¼‰targetPort"></a>3ï¼‰targetPort</h3><blockquote><p><strong>targetPortæ˜¯podçš„ç«¯å£</strong>ï¼Œä»portå’ŒnodePortæ¥çš„æµé‡ç»è¿‡kube-proxyæµå…¥åˆ°åç«¯podçš„targetPortä¸Šï¼Œæœ€åè¿›å…¥å®¹å™¨ã€‚</p></blockquote><h3 id="4ï¼‰containerPort"><a href="#4ï¼‰containerPort" class="headerlink" title="4ï¼‰containerPort"></a>4ï¼‰containerPort</h3><blockquote><p><strong>containerPortæ˜¯podå†…éƒ¨å®¹å™¨çš„ç«¯å£</strong>ï¼ŒtargetPortæ˜ å°„åˆ°containerPortã€‚</p></blockquote><p><img src="https://res.yongwang.lu/img/202303221413828.png" alt="å›¾ç‰‡"></p><h2 id="ä¹ã€kubernetesæœåŠ¡å‘ç°"><a href="#ä¹ã€kubernetesæœåŠ¡å‘ç°" class="headerlink" title="ä¹ã€kubernetesæœåŠ¡å‘ç°"></a>ä¹ã€kubernetesæœåŠ¡å‘ç°</h2><blockquote><p>Kubernetesæä¾›äº†ä¸¤ç§æ–¹å¼è¿›è¡ŒæœåŠ¡å‘ç°, å³<strong>ç¯å¢ƒå˜é‡å’ŒDNS</strong>, ç®€å•è¯´æ˜å¦‚ä¸‹:</p></blockquote><h3 id="1ï¼‰ç¯å¢ƒå˜é‡"><a href="#1ï¼‰ç¯å¢ƒå˜é‡" class="headerlink" title="1ï¼‰ç¯å¢ƒå˜é‡"></a>1ï¼‰ç¯å¢ƒå˜é‡</h3><blockquote><p>å½“ä½ åˆ›å»ºä¸€ä¸ªPodçš„æ—¶å€™ï¼Œkubeletä¼šåœ¨è¯¥Podä¸­æ³¨å…¥é›†ç¾¤å†…æ‰€æœ‰Serviceçš„ç›¸å…³ç¯å¢ƒå˜é‡ã€‚</p></blockquote><blockquote><p>ã€æ³¨æ„ã€‘è¦æƒ³ä¸€ä¸ªPodä¸­æ³¨å…¥æŸä¸ªServiceçš„ç¯å¢ƒå˜é‡ï¼Œåˆ™<strong>å¿…é¡»Serviceè¦æ¯”è¯¥Podå…ˆåˆ›å»º</strong>ã€‚è¿™ä¸€ç‚¹ï¼Œå‡ ä¹ä½¿å¾—è¿™ç§æ–¹å¼è¿›è¡ŒæœåŠ¡å‘ç°ä¸å¯ç”¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªServiceNameä¸ºredis-masterçš„Serviceï¼Œå¯¹åº”çš„ClusterIP:Portä¸º172.16.50.11:6379ï¼Œåˆ™å…¶å¯¹åº”çš„ç¯å¢ƒå˜é‡ä¸º:</p></blockquote><blockquote><p>REDIS_MASTER_SERVICE_HOST&#x3D;172.16.50.11<br>REDIS_MASTER_SERVICE_PORT&#x3D;6379<br>REDIS_MASTER_PORT&#x3D;tcp:&#x2F;&#x2F;172.16.50.11:6379<br>REDIS_MASTER_PORT_6379_TCP&#x3D;tcp:&#x2F;&#x2F;172.16.50.11:6379<br>REDIS_MASTER_PORT_6379_TCP_PROTO&#x3D;tcp<br>REDIS_MASTER_PORT_6379_TCP_PORT&#x3D;6379<br>REDIS_MASTER_PORT_6379_TCP_ADDR&#x3D;172.16.50.11</p></blockquote><h3 id="2-DNS"><a href="#2-DNS" class="headerlink" title="2) DNS"></a>2) DNS</h3><blockquote><p>è¿™æ˜¯k8så®˜æ–¹å¼ºçƒˆæ¨èçš„æ–¹å¼!!! å¯ä»¥é€šè¿‡cluster add-onæ–¹å¼è½»æ¾çš„åˆ›å»ºKubeDNSæ¥å¯¹é›†ç¾¤å†…çš„Serviceè¿›è¡ŒæœåŠ¡å‘ç°ã€‚</p></blockquote><h2 id="åã€Serviceä»£ç†æ¨¡å¼"><a href="#åã€Serviceä»£ç†æ¨¡å¼" class="headerlink" title="åã€Serviceä»£ç†æ¨¡å¼"></a>åã€Serviceä»£ç†æ¨¡å¼</h2><blockquote><p>k8sç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªkube-proxyçš„ç»„ä»¶ï¼Œkube-proxyå…¶å®æ˜¯ä¸€ä¸ªä»£ç†å±‚è´Ÿè´£å®ç°serviceã€‚</p></blockquote><blockquote><p><strong>Kubernetes v1.2ä¹‹å‰é»˜è®¤æ˜¯userspaceï¼Œv1.2ä¹‹åé»˜è®¤æ˜¯iptablesæ¨¡å¼</strong>ï¼Œiptablesæ¨¡å¼æ€§èƒ½å’Œå¯é æ€§æ›´å¥½ï¼Œä½†æ˜¯iptablesæ¨¡å¼ä¾èµ–å¥åº·æ£€æŸ¥ï¼Œåœ¨æ²¡æœ‰å¥åº·æ£€æŸ¥çš„æƒ…å†µä¸‹å¦‚æœä¸€ä¸ªpodä¸å“åº”ï¼Œiptablesæ¨¡å¼ä¸ä¼šåˆ‡æ¢å¦ä¸€ä¸ªpodä¸Šã€‚</p></blockquote><h3 id="1ï¼‰userspaceæ¨¡å¼"><a href="#1ï¼‰userspaceæ¨¡å¼" class="headerlink" title="1ï¼‰userspaceæ¨¡å¼"></a>1ï¼‰userspaceæ¨¡å¼</h3><blockquote><p>å®¢æˆ·ç«¯è®¿é—®ServiceIP(clusterIP)è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ä¸­çš„iptablesï¼Œç„¶åå›åˆ°ç”¨æˆ·ç©ºé—´kube-proxyï¼Œkube-proxyè´Ÿè´£ä»£ç†å·¥ä½œã€‚</p></blockquote><p>ç¼ºç‚¹ï¼š</p><blockquote><p>å¯è§ï¼Œuserspaceè¿™ç§modeæœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œserviceçš„è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸iptablesï¼Œç„¶åå†å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±kube-proxyå®Œæˆåç«¯Endpointsçš„é€‰æ‹©å’Œä»£ç†å·¥ä½œï¼Œè¿™æ ·æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å‡ºå†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ã€‚è¿™ä¹Ÿæ˜¯k8s v1.0åŠä¹‹å‰ç‰ˆæœ¬ä¸­å¯¹kube-proxyè´¨ç–‘æœ€å¤§çš„ä¸€ç‚¹ï¼Œå› æ­¤ç¤¾åŒºå°±å¼€å§‹ç ”ç©¶iptables modeã€‚</p></blockquote><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>userspaceè¿™ç§æ¨¡å¼ä¸‹ï¼Œkube-proxy æŒç»­ç›‘å¬ Service ä»¥åŠ Endpoints å¯¹è±¡çš„å˜åŒ–ï¼›å¯¹æ¯ä¸ª Serviceï¼Œå®ƒéƒ½ä¸ºå…¶åœ¨æœ¬åœ°èŠ‚ç‚¹å¼€æ”¾ä¸€ä¸ªç«¯å£ï¼Œä½œä¸ºå…¶æœåŠ¡ä»£ç†ç«¯å£ï¼›å‘å¾€è¯¥ç«¯å£çš„è¯·æ±‚ä¼šé‡‡ç”¨ä¸€å®šçš„ç­–ç•¥è½¬å‘ç»™ä¸è¯¥æœåŠ¡å¯¹åº”çš„åç«¯ Pod å®ä½“ã€‚kube-proxy åŒæ—¶ä¼šåœ¨æœ¬åœ°èŠ‚ç‚¹è®¾ç½® iptables è§„åˆ™ï¼Œé…ç½®ä¸€ä¸ª Virtual IPï¼ŒæŠŠå‘å¾€ Virtual IP çš„è¯·æ±‚é‡å®šå‘åˆ°ä¸è¯¥ Virtual IP å¯¹åº”çš„æœåŠ¡ä»£ç†ç«¯å£ä¸Šã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><blockquote><p>ã€åˆ†æã€‘è¯¥æ¨¡å¼è¯·æ±‚åœ¨åˆ°è¾¾ iptables è¿›è¡Œå¤„ç†æ—¶å°±ä¼šè¿›å…¥å†…æ ¸ï¼Œè€Œ kube-proxy ç›‘å¬åˆ™æ˜¯åœ¨ç”¨æˆ·æ€, è¯·æ±‚å°±å½¢æˆäº†ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€å†è¿”å›åˆ°ç”¨æˆ·æ€çš„ä¼ é€’è¿‡ç¨‹, ä¸€å®šç¨‹åº¦é™ä½äº†æœåŠ¡æ€§èƒ½ã€‚</p></blockquote><h3 id="2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰"><a href="#2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰" class="headerlink" title="2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰"></a>2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰</h3><blockquote><p>è¯¥æ¨¡å¼å®Œå…¨åˆ©ç”¨å†…æ ¸iptablesæ¥å®ç°serviceçš„ä»£ç†å’ŒLB, è¿™æ˜¯K8såœ¨<strong>v1.2åŠä¹‹åç‰ˆæœ¬é»˜è®¤æ¨¡å¼</strong>. å·¥ä½œåŸç†å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322225854.png" alt="iptablesæ¨¡å¼"></p><blockquote><p><strong>iptables modeå› ä¸ºä½¿ç”¨iptable NATæ¥å®Œæˆè½¬å‘ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—</strong>ã€‚å¦å¤–ï¼Œå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service&#x2F;Endpointï¼Œé‚£ä¹ˆNodeä¸Šçš„iptables ruleså°†ä¼šéå¸¸åºå¤§ï¼Œæ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ã€‚è¿™ä¹Ÿå¯¼è‡´ç›®å‰å¤§éƒ¨åˆ†ä¼ä¸šç”¨k8sä¸Šç”Ÿäº§æ—¶ï¼Œéƒ½ä¸ä¼šç›´æ¥ç”¨kube-proxyä½œä¸ºæœåŠ¡ä»£ç†ï¼Œè€Œæ˜¯é€šè¿‡è‡ªå·±å¼€å‘æˆ–è€…é€šè¿‡Ingress Controlleræ¥é›†æˆHAProxy, Nginxæ¥ä»£æ›¿kube-proxyã€‚</p></blockquote><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>iptables æ¨¡å¼ä¸ userspace ç›¸åŒï¼Œkube-proxy æŒç»­ç›‘å¬ Service ä»¥åŠ Endpoints å¯¹è±¡çš„å˜åŒ–ï¼›ä½†å®ƒå¹¶ä¸åœ¨æœ¬åœ°èŠ‚ç‚¹å¼€å¯åå‘ä»£ç†æœåŠ¡ï¼Œè€Œæ˜¯æŠŠåå‘ä»£ç†å…¨éƒ¨äº¤ç»™ iptables æ¥å®ç°ï¼›å³ iptables ç›´æ¥å°†å¯¹ VIP çš„è¯·æ±‚è½¬å‘ç»™åç«¯ Podï¼Œé€šè¿‡ iptables è®¾ç½®è½¬å‘ç­–ç•¥ã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322230525.png" alt="iptables-è¯¦ç»†å·¥ä½œæµç¨‹"></p><blockquote><p>ã€åˆ†æã€‘ è¯¥æ¨¡å¼ç›¸æ¯” userspace æ¨¡å¼ï¼Œå…‹æœäº†è¯·æ±‚åœ¨ç”¨æˆ·æ€-å†…æ ¸æ€åå¤ä¼ é€’çš„é—®é¢˜ï¼Œæ€§èƒ½ä¸Šæœ‰æ‰€æå‡ï¼Œä½†ä½¿ç”¨ iptables NAT æ¥å®Œæˆè½¬å‘ï¼Œå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—ï¼Œè€Œä¸”åœ¨å¤§è§„æ¨¡åœºæ™¯ä¸‹ï¼Œiptables è§„åˆ™çš„æ¡ç›®ä¼šååˆ†å·¨å¤§ï¼Œæ€§èƒ½ä¸Šè¿˜è¦å†æ‰“æŠ˜æ‰£ã€‚</p></blockquote><p>ç¤ºä¾‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; mysql-service.yaml</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: mysql</span></span><br><span class="line"><span class="string">    role: service</span></span><br><span class="line"><span class="string">  name: mysql-service</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - port: 3306</span></span><br><span class="line"><span class="string">      targetPort: 3306</span></span><br><span class="line"><span class="string">      nodePort: 30964</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    mysql-service: &quot;true&quot;</span></span><br><span class="line"><span class="string">    name: mysql</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">$ kubectl apply -f mysql-service.yaml</span><br><span class="line">$ kubectl get svc</span><br></pre></td></tr></table></figure><h3 id="3ï¼‰ipvsæ¨¡å‹"><a href="#3ï¼‰ipvsæ¨¡å‹" class="headerlink" title="3ï¼‰ipvsæ¨¡å‹"></a>3ï¼‰ipvsæ¨¡å‹</h3><blockquote><p>åœ¨kubernetes 1.8ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œå¯¹äºkube-proxyç»„ä»¶å¢åŠ äº†é™¤iptablesæ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼ä¹‹å¤–è¿˜æ”¯æŒipvsæ¨¡å¼ã€‚<strong>kube-proxy ipvs æ˜¯åŸºäº NAT å®ç°çš„</strong>ï¼Œé€šè¿‡ipvsçš„NATæ¨¡å¼ï¼Œå¯¹è®¿é—®k8s serviceçš„è¯·æ±‚è¿›è¡Œè™šIPåˆ°POD IPçš„è½¬å‘ã€‚å½“åˆ›å»ºä¸€ä¸ª service åï¼Œkubernetes ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªç½‘å¡ï¼ŒåŒæ—¶å¸®ä½ å°† Service IP(VIP) ç»‘å®šä¸Šï¼Œæ­¤æ—¶ç›¸å½“äºæ¯ä¸ª Node éƒ½æ˜¯ä¸€ä¸ª dsï¼Œè€Œå…¶ä»–ä»»ä½• Node ä¸Šçš„ Podï¼Œç”šè‡³æ˜¯å®¿ä¸»æœºæœåŠ¡(æ¯”å¦‚ kube-apiserver çš„ 6443)éƒ½å¯èƒ½æˆä¸º rsï¼›</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322230705.png" alt="ipvs-serviceæ¨¡å‹"></p><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>ä¸iptablesã€userspace æ¨¡å¼ä¸€æ ·ï¼Œkube-proxy ä¾ç„¶ç›‘å¬Serviceä»¥åŠEndpointså¯¹è±¡çš„å˜åŒ–, ä¸è¿‡å®ƒå¹¶ä¸åˆ›å»ºåå‘ä»£ç†, ä¹Ÿä¸åˆ›å»ºå¤§é‡çš„ iptables è§„åˆ™, è€Œæ˜¯é€šè¿‡netlink åˆ›å»ºipvsè§„åˆ™ï¼Œå¹¶ä½¿ç”¨k8s Serviceä¸Endpointsä¿¡æ¯ï¼Œå¯¹æ‰€åœ¨èŠ‚ç‚¹çš„ipvsè§„åˆ™è¿›è¡Œå®šæœŸåŒæ­¥; netlink ä¸ iptables åº•å±‚éƒ½æ˜¯åŸºäº netfilter é’©å­ï¼Œä½†æ˜¯ netlink ç”±äºé‡‡ç”¨äº† hash table è€Œä¸”ç›´æ¥å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯” iptables æ›´ä¼˜ã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322230748.png" alt="ipvså·¥ä½œæµç¨‹"></p><blockquote><p>ã€åˆ†æã€‘ipvs æ˜¯ç›®å‰ kube-proxy æ‰€æ”¯æŒçš„æœ€æ–°ä»£ç†æ¨¡å¼ï¼Œç›¸æ¯”ä½¿ç”¨ iptablesï¼Œä½¿ç”¨ ipvs å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><hr><h3 id="4ï¼‰kube-proxyé…ç½®-ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"><a href="#4ï¼‰kube-proxyé…ç½®-ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰" class="headerlink" title="4ï¼‰kube-proxyé…ç½® ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"></a>4ï¼‰kube-proxyé…ç½® ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3><p>1ã€åŠ è½½ip_vsç›¸å…³å†…æ ¸æ¨¡å—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe -- ip_vs</span><br><span class="line">$ modprobe -- ip_vs_sh</span><br><span class="line">$ modprobe -- ip_vs_rr</span><br><span class="line">$ modprobe -- ip_vs_wrr</span><br><span class="line">$ modprobe -- nf_conntrack_ipv4</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰èŠ‚ç‚¹éªŒè¯å¼€å¯äº†ipvsï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod |grep ip_vs</span><br></pre></td></tr></table></figure><p>2ã€å®‰è£…ipvsadmå·¥å…·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install ipset ipvsadm -y</span><br></pre></td></tr></table></figure><p>3ã€ç¼–è¾‘kube-proxyé…ç½®æ–‡ä»¶ï¼Œmodeä¿®æ”¹æˆipvs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit  configmap -n kube-system  kube-proxy</span><br></pre></td></tr></table></figure><p>4ã€é‡å¯kube-proxy<br>å…ˆæŸ¥çœ‹ä¹‹å‰çš„kube-proxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy</span><br></pre></td></tr></table></figure><p>åˆ æ‰ä¸Šé¢ä¸‰ä¸ªkube-proxyï¼Œé‡æ–°æ‹‰èµ·æ–°çš„æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy |awk <span class="string">&#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">title: Kubernetesï¼ˆk8sï¼‰kube-proxyã€Serviceè¯¦è§£</span><br><span class="line">abbrlink: 5475e8a5</span><br><span class="line">tags: kubernetes</span><br><span class="line">categories: kubernetes</span><br><span class="line">keywords: k8s</span><br><span class="line">description: kubernetes1.26</span><br><span class="line">top_img: &#x27;https://kubernetes.io/images/nav_logo2.svg&#x27;</span><br><span class="line">cover: &#x27;https://res.yongwang.lu/img/k8s_card.png&#x27;</span><br><span class="line">date: 2023-03-21 21:40:00</span><br><span class="line">updated: 2023-03-21 21:40:00</span><br><span class="line">comments:</span><br><span class="line">toc:</span><br><span class="line">toc_number:</span><br><span class="line">toc_style_simple:</span><br><span class="line">copyright:</span><br><span class="line">copyright_author:</span><br><span class="line">copyright_author_href:</span><br><span class="line">copyright_url:</span><br><span class="line">copyright_info:</span><br><span class="line">mathjax:</span><br><span class="line">katex:</span><br><span class="line">aplayer:</span><br><span class="line">highlight_shrink:</span><br><span class="line">aside:</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">## ä¸€ã€kube-proxyç®€ä»‹</span><br><span class="line"></span><br><span class="line">&gt; **kube-proxyè´Ÿè´£ä¸ºServiceæä¾›clusterå†…éƒ¨çš„æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡**ï¼Œå®ƒè¿è¡Œåœ¨æ¯ä¸ªNodeè®¡ç®—èŠ‚ç‚¹ä¸Šï¼Œè´Ÿè´£Podç½‘ç»œä»£ç†, å®ƒä¼šå®šæ—¶ä»etcdæœåŠ¡è·å–åˆ°serviceä¿¡æ¯æ¥åšç›¸åº”çš„ç­–ç•¥ï¼Œç»´æŠ¤ç½‘ç»œè§„åˆ™å’Œå››å±‚è´Ÿè½½å‡è¡¡å·¥ä½œã€‚åœ¨K8sé›†ç¾¤ä¸­å¾®æœåŠ¡çš„è´Ÿè½½å‡è¡¡æ˜¯ç”±Kube-proxyå®ç°çš„ï¼Œå®ƒæ˜¯K8sé›†ç¾¤å†…éƒ¨çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»£ç†æœåŠ¡å™¨ï¼Œåœ¨K8sçš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šéƒ½æœ‰ä¸€ä¸ªï¼Œè¿™ä¸€è®¾è®¡ä½“ç°äº†å®ƒçš„ä¼¸ç¼©æ€§ä¼˜åŠ¿ï¼Œéœ€è¦è®¿é—®æœåŠ¡çš„èŠ‚ç‚¹è¶Šå¤šï¼Œæä¾›è´Ÿè½½å‡è¡¡èƒ½åŠ›çš„Kube-proxyå°±è¶Šå¤šï¼Œé«˜å¯ç”¨èŠ‚ç‚¹ä¹Ÿéšä¹‹å¢å¤šã€‚</span><br><span class="line"></span><br><span class="line">&gt; **serviceæ˜¯ä¸€ç»„podçš„æœåŠ¡æŠ½è±¡ï¼Œç›¸å½“äºä¸€ç»„podçš„LB**ï¼Œè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™å¯¹åº”çš„podã€‚serviceä¼šä¸ºè¿™ä¸ªLBæä¾›ä¸€ä¸ªIPï¼Œä¸€èˆ¬ç§°ä¸ºcluster IPã€‚**kube-proxyçš„ä½œç”¨ä¸»è¦æ˜¯è´Ÿè´£serviceçš„å®ç°**ï¼Œå…·ä½“æ¥è¯´ï¼Œå°±æ˜¯å®ç°äº†å†…éƒ¨ä»podåˆ°serviceå’Œå¤–éƒ¨çš„ä»node portå‘serviceçš„è®¿é—®ã€‚</span><br><span class="line"></span><br><span class="line">ç®€å•æ¥è¯´:</span><br><span class="line"></span><br><span class="line">-   kube-proxyå…¶å®å°±æ˜¯ç®¡ç†serviceçš„è®¿é—®å…¥å£ï¼ŒåŒ…æ‹¬é›†ç¾¤å†…Podåˆ°Serviceçš„è®¿é—®å’Œé›†ç¾¤å¤–è®¿é—®serviceã€‚</span><br><span class="line">    </span><br><span class="line">-   kube-proxyç®¡ç†seviceçš„Endpointsï¼Œè¯¥serviceå¯¹å¤–æš´éœ²ä¸€ä¸ªVirtual IPï¼Œä¹Ÿæˆä¸ºCluster IP, é›†ç¾¤å†…é€šè¿‡è®¿é—®è¿™ä¸ªCluster IP:Portå°±èƒ½è®¿é—®åˆ°é›†ç¾¤å†…å¯¹åº”çš„serivceä¸‹çš„Podã€‚</span><br><span class="line">    </span><br><span class="line">-   serviceæ˜¯é€šè¿‡Selectoré€‰æ‹©çš„ä¸€ç»„Podsçš„æœåŠ¡æŠ½è±¡ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ªå¾®æœåŠ¡ï¼Œæä¾›äº†æœåŠ¡çš„LBå’Œåå‘ä»£ç†çš„èƒ½åŠ›ï¼Œè€Œkube-proxyçš„ä¸»è¦ä½œç”¨å°±æ˜¯è´Ÿè´£serviceçš„å®ç°ã€‚</span><br><span class="line">    </span><br><span class="line">-   serviceå¦å¤–ä¸€ä¸ªé‡è¦ä½œç”¨æ˜¯ï¼Œä¸€ä¸ªæœåŠ¡åç«¯çš„Podså¯èƒ½ä¼šéšç€ç”Ÿå­˜ç­äº¡è€Œå‘ç”ŸIPçš„æ”¹å˜ï¼Œserviceçš„å‡ºç°ï¼Œç»™æœåŠ¡æä¾›äº†ä¸€ä¸ªå›ºå®šçš„IPï¼Œè€Œæ— è§†åç«¯Endpointçš„å˜åŒ–ã€‚</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">## äºŒã€Service ç®€ä»‹</span><br><span class="line"></span><br><span class="line">&gt; Kubernetes Serviceå®šä¹‰äº†è¿™æ ·ä¸€ç§æŠ½è±¡ï¼š Serviceæ˜¯ä¸€ç§å¯ä»¥è®¿é—® Podé€»è¾‘åˆ†ç»„çš„ç­–ç•¥ï¼Œ Serviceé€šå¸¸æ˜¯é€šè¿‡ Label Selectorè®¿é—® Podç»„ã€‚</span><br><span class="line"></span><br><span class="line">&gt; Serviceèƒ½å¤Ÿæä¾›è´Ÿè½½å‡è¡¡çš„èƒ½åŠ›ï¼Œä½†æ˜¯åœ¨ä½¿ç”¨ä¸Šæœ‰ä»¥ä¸‹é™åˆ¶ï¼š**åªæä¾› 4 å±‚è´Ÿè½½å‡è¡¡èƒ½åŠ›**ï¼Œè€Œæ²¡æœ‰ 7 å±‚åŠŸèƒ½ï¼Œä½†æœ‰æ—¶æˆ‘ä»¬å¯èƒ½éœ€è¦æ›´å¤šçš„åŒ¹é…è§„åˆ™æ¥è½¬å‘è¯·æ±‚ï¼Œè¿™ç‚¹ä¸Š 4 å±‚è´Ÿè½½å‡è¡¡æ˜¯ä¸æ”¯æŒçš„ã€‚</span><br><span class="line"></span><br><span class="line">## ä¸‰ã€Service ç±»å‹</span><br><span class="line"></span><br><span class="line">Serviceåœ¨ K8sä¸­æœ‰ä»¥ä¸‹å››ç§ç±»å‹ï¼š</span><br><span class="line"></span><br><span class="line">### 1ï¼‰ClusterIpï¼ˆé›†ç¾¤å†…éƒ¨ä½¿ç”¨ï¼‰</span><br><span class="line"></span><br><span class="line">&gt; **é»˜è®¤ç±»å‹**ï¼Œè‡ªåŠ¨åˆ†é…ä¸€ä¸ªä»…Clusterå†…éƒ¨å¯ä»¥è®¿é—®çš„è™šæ‹ŸIPï¼ˆVIPï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">### 2ï¼‰NodePortï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼‰</span><br><span class="line"></span><br><span class="line">&gt; åœ¨ClusterIPåŸºç¡€ä¸Šä¸ºServiceåœ¨æ¯å°æœºå™¨ä¸Šç»‘å®šä¸€ä¸ªç«¯å£ï¼Œè¿™æ ·å°±å¯ä»¥é€šè¿‡NodeIP:NodePortè®¿é—®æ¥è®¿é—®è¯¥æœåŠ¡ã€‚  </span><br><span class="line">&gt; ç«¯å£èŒƒå›´ï¼š30000~32767</span><br><span class="line"></span><br><span class="line">### 3ï¼‰LoadBalancerï¼ˆå¯¹å¤–æš´éœ²åº”ç”¨ï¼Œé€‚ç”¨äºå…¬æœ‰äº‘ï¼‰</span><br><span class="line"></span><br><span class="line">&gt; åœ¨NodePortçš„åŸºç¡€ä¸Šï¼Œå€ŸåŠ©Cloud Provideråˆ›å»ºä¸€ä¸ªå¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œå¹¶å°†è¯·æ±‚è½¬å‘åˆ°NodePortã€‚</span><br><span class="line"></span><br><span class="line">### 4ï¼‰ExternalName</span><br><span class="line"></span><br><span class="line">&gt; åˆ›å»ºä¸€ä¸ªdnsåˆ«åæŒ‡åˆ°service nameä¸Šï¼Œä¸»è¦æ˜¯é˜²æ­¢service nameå‘ç”Ÿå˜åŒ–ï¼Œè¦é…åˆdnsæ’ä»¶ä½¿ç”¨ã€‚é€šè¿‡è¿”å› CNAME å’Œå®ƒçš„å€¼ï¼Œå¯ä»¥å°†æœåŠ¡æ˜ å°„åˆ° externalName å­—æ®µçš„å†…å®¹ã€‚è¿™åªæœ‰ Kubernetes 1.7æˆ–æ›´é«˜ç‰ˆæœ¬çš„kube-dnsæ‰æ”¯æŒï¼ˆ**æˆ‘è¿™é‡Œæ˜¯Kubernetes 1.22.1ç‰ˆæœ¬**ï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">## å››ã€Service å·¥ä½œæµç¨‹</span><br><span class="line"></span><br><span class="line">![Service å·¥ä½œæµç¨‹](https://res.yongwang.lu/img/20230322225854.png)</span><br><span class="line"></span><br><span class="line">1.  å®¢æˆ·ç«¯è®¿é—®èŠ‚ç‚¹æ—¶é€šè¿‡ iptableså®ç°çš„</span><br><span class="line">    </span><br><span class="line">2.  iptablesè§„åˆ™æ˜¯é€šè¿‡ kube-proxyå†™å…¥çš„</span><br><span class="line">    </span><br><span class="line">3.  apiserveré€šè¿‡ç›‘æ§ kube-proxyå»è¿›è¡Œå¯¹æœåŠ¡å’Œç«¯ç‚¹çš„ç›‘æ§</span><br><span class="line">    </span><br><span class="line">4.  kube-proxyé€šè¿‡ podçš„æ ‡ç­¾ï¼ˆ lablesï¼‰å»åˆ¤æ–­è¿™ä¸ªæ–­ç‚¹ä¿¡æ¯æ˜¯å¦å†™å…¥åˆ° Endpointsé‡Œ</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">## äº”ã€Endpointsç®€ä»‹</span><br><span class="line"></span><br><span class="line">&gt; endpointæ˜¯k8sé›†ç¾¤ä¸­çš„ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œå­˜å‚¨åœ¨etcdä¸­ï¼Œ**ç”¨æ¥è®°å½•ä¸€ä¸ªserviceå¯¹åº”çš„æ‰€æœ‰podçš„è®¿é—®åœ°å€**ã€‚serviceé…ç½®selectorï¼Œendpoint controlleræ‰ä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„endpointå¯¹è±¡ï¼›å¦åˆ™ï¼Œä¸ä¼šç”Ÿæˆendpointå¯¹è±¡ã€‚</span><br><span class="line"></span><br><span class="line">&gt; ã€ä¾‹å¦‚ã€‘k8sé›†ç¾¤ä¸­åˆ›å»ºä¸€ä¸ªåä¸ºhelloçš„serviceï¼Œå°±ä¼šç”Ÿæˆä¸€ä¸ªåŒåçš„endpointå¯¹è±¡ï¼ŒENDPOINTSå°±æ˜¯serviceå…³è”çš„podçš„ipåœ°å€å’Œç«¯å£ã€‚</span><br><span class="line"></span><br><span class="line">### 1ï¼‰å·¥ä½œæµç¨‹</span><br><span class="line"></span><br><span class="line">&gt; **ä¸€ä¸ª Service ç”±ä¸€ç»„ backend Pod ç»„æˆã€‚è¿™äº› Pod é€šè¿‡ endpoints æš´éœ²å‡ºæ¥**ã€‚ Service Selector å°†æŒç»­è¯„ä¼°ï¼Œç»“æœè¢« POST åˆ°ä¸€ä¸ªåç§°ä¸º Service-hello çš„ Endpoint å¯¹è±¡ä¸Šã€‚ å½“ Pod ç»ˆæ­¢åï¼Œå®ƒä¼šè‡ªåŠ¨ä» Endpoint ä¸­ç§»é™¤ï¼Œæ–°çš„èƒ½å¤ŸåŒ¹é…ä¸Š Service Selector çš„ Pod å°†è‡ªåŠ¨åœ°è¢«æ·»åŠ åˆ° Endpoint ä¸­ã€‚ æ£€æŸ¥è¯¥ Endpointï¼Œæ³¨æ„åˆ° IP åœ°å€ä¸åˆ›å»ºçš„ Pod æ˜¯ç›¸åŒçš„ã€‚ç°åœ¨ï¼Œèƒ½å¤Ÿä»é›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹ä¸Šä½¿ç”¨ curl å‘½ä»¤è¯·æ±‚ hello Service &lt;CLUSTER-IP&gt;:&lt;PORT&gt; ã€‚</span><br><span class="line"></span><br><span class="line">### 2ï¼‰ç¤ºä¾‹</span><br><span class="line"></span><br><span class="line">1ã€deployment-hello.yaml</span><br><span class="line"></span><br><span class="line">```auto</span><br><span class="line">$ cat &lt;&lt; EOF &gt; deployment-hello.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">     run: hello</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        run: hello</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx:1.17.1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>2ã€service-hello.yaml</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ cat &lt;&lt; EOF &gt; service-hello.yaml</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: service-hello</span><br><span class="line">  labels:</span><br><span class="line">  name: service-hello</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort      #è¿™é‡Œä»£è¡¨æ˜¯NodePortç±»å‹çš„,å¦å¤–è¿˜æœ‰ingress,LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80          </span><br><span class="line">    targetPort: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">    nodePort: 31111   # æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¼šå¼€æ”¾æ­¤ç«¯å£30000--32767ï¼Œæ­¤ç«¯å£ä¾›å¤–éƒ¨è°ƒç”¨ã€‚</span><br><span class="line">  selector:</span><br><span class="line">    run: hello</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>3ã€æŸ¥çœ‹éªŒè¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f deployment-hello.yaml</span><br><span class="line">$ kubectl apply -f service-hello.yaml</span><br><span class="line"># æŸ¥çœ‹podï¼Œå¦‚æœæœ¬åœ°æ²¡æœ‰é•œåƒï¼Œå¯èƒ½ç­‰å¾…çš„æ—¶å€™æ¯”è¾ƒé•¿ï¼Œä¸€å®šè¦ç­‰åˆ°æ‰€æœ‰podéƒ½åœ¨è¿è¡Œä¸­æ‰è¡Œã€‚</span><br><span class="line">$ kubectl get pod -o wide|grep hello-*</span><br><span class="line"># æŸ¥çœ‹service</span><br><span class="line">$ kubectl get service service-hello -o wide</span><br><span class="line"># æŸ¥çœ‹serviceè¯¦æƒ…</span><br><span class="line">$ kubectl describe service service-hello</span><br><span class="line"># æŸ¥çœ‹pointer</span><br><span class="line">$ kubectl get endpoints service-hello</span><br></pre></td></tr></table></figure><h2 id="å…­ã€Service-Endpointsä¸Podçš„å…³ç³»-1"><a href="#å…­ã€Service-Endpointsä¸Podçš„å…³ç³»-1" class="headerlink" title="å…­ã€Service, Endpointsä¸Podçš„å…³ç³»"></a>å…­ã€Service, Endpointsä¸Podçš„å…³ç³»</h2><p><img src="https://res.yongwang.lu/img/20230322230158.png" alt="Service, Endpointsä¸Podçš„å…³ç³»"></p><blockquote><p>Kube-proxyè¿›ç¨‹è·å–æ¯ä¸ªServiceçš„Endpoints,å®ç°Serviceçš„è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚</p></blockquote><p>Serviceçš„è´Ÿè½½å‡è¡¡è½¬å‘è§„åˆ™<br><img src="https://res.yongwang.lu/img/20230322230057.png" alt="Serviceçš„è´Ÿè½½å‡è¡¡è½¬å‘è§„åˆ™ "></p><blockquote><p>è®¿é—®Serviceçš„è¯·æ±‚ï¼Œä¸è®ºæ˜¯Cluster IP+TargetPortçš„æ–¹å¼ï¼›è¿˜æ˜¯ç”¨NodeèŠ‚ç‚¹IP+NodePortçš„æ–¹å¼ï¼Œéƒ½è¢«NodeèŠ‚ç‚¹çš„Iptablesè§„åˆ™é‡å®šå‘åˆ°Kube-proxyç›‘å¬ServiceæœåŠ¡ä»£ç†ç«¯å£ã€‚kube-proxyæ¥æ”¶åˆ°Serviceçš„è®¿é—®è¯·æ±‚åï¼Œæ ¹æ®è´Ÿè½½ç­–ç•¥ï¼Œè½¬å‘åˆ°åç«¯çš„Podã€‚</p></blockquote><h2 id="ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£-1"><a href="#ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£-1" class="headerlink" title="ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£"></a>ä¸ƒã€Serviceçš„èµ„æºæ¸…å•æ–‡ä»¶è¯¦è§£</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">#å…ƒæ•°æ®</span><br><span class="line">  name: string</span><br><span class="line">  #Serviceåç§°</span><br><span class="line">  namespace: string</span><br><span class="line">  #å‘½åç©ºé—´ï¼Œä¸æŒ‡å®šæ—¶é»˜è®¤ä¸ºdefaultå‘½åç©ºé—´</span><br><span class="line">  labels:</span><br><span class="line">  #è‡ªå®šä¹‰æ ‡ç­¾å±æ€§åˆ—è¡¨     </span><br><span class="line">    - name: string</span><br><span class="line">  annotations:</span><br><span class="line">  #è‡ªå®šä¹‰æ³¨è§£å±æ€§åˆ—è¡¨    </span><br><span class="line">    - name: string</span><br><span class="line">spec:</span><br><span class="line">#è¯¦ç»†æè¿°    </span><br><span class="line">  selector: []</span><br><span class="line">  #è¿™é‡Œé€‰æ‹©å™¨ä¸€å®šè¦é€‰æ‹©å®¹å™¨çš„æ ‡ç­¾ï¼Œä¹Ÿå°±æ˜¯podçš„æ ‡ç­¾</span><br><span class="line">  #selector:</span><br><span class="line">  #  app: web</span><br><span class="line">  #Label Selectoré…ç½®ï¼Œé€‰æ‹©å…·æœ‰æŒ‡å®šlabelæ ‡ç­¾çš„podä½œä¸ºç®¡ç†èŒƒå›´</span><br><span class="line">  type: string</span><br><span class="line">  #serviceçš„ç±»å‹ï¼ŒæŒ‡å®šserviceçš„è®¿é—®æ–¹å¼ï¼Œé»˜è®¤ClusterIP</span><br><span class="line">  #ClusterIPï¼šè™šæ‹Ÿçš„æœåŠ¡ipåœ°å€ï¼Œç”¨äºk8sé›†ç¾¤å†…éƒ¨çš„podè®¿é—®ï¼Œåœ¨Nodeä¸Škube-porxyé€šè¿‡è®¾ç½®çš„iptablesè§„åˆ™è¿›è¡Œè½¬å‘</span><br><span class="line">  #NodePortï¼šä½¿ç”¨å®¿ä¸»æœºç«¯å£ï¼Œèƒ½å¤Ÿè®¿é—®å„Nodeçš„å¤–éƒ¨å®¢æˆ·ç«¯é€šè¿‡Nodeçš„IPå’Œç«¯å£å°±èƒ½è®¿é—®æœåŠ¡å™¨</span><br><span class="line">  #LoadBalancerï¼šä½¿ç”¨å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨å®Œæˆåˆ°æœåŠ¡å™¨çš„è´Ÿè½½åˆ†å‘ï¼Œ</span><br><span class="line">  #éœ€è¦åœ¨spec.status.loadBalancerå­—æ®µæŒ‡å®šå¤–éƒ¨è´Ÿè½½å‡è¡¡æœåŠ¡å™¨çš„IPï¼Œå¹¶åŒæ—¶å®šä¹‰nodePortå’ŒclusterIPç”¨äºå…¬æœ‰äº‘ç¯å¢ƒã€‚</span><br><span class="line">  clusterIP: string</span><br><span class="line">  #è™šæ‹ŸæœåŠ¡IPåœ°å€ï¼Œå½“type=ClusterIPæ—¶ï¼Œå¦‚ä¸æŒ‡å®šï¼Œåˆ™ç³»ç»Ÿä¼šè‡ªåŠ¨è¿›è¡Œåˆ†é…ï¼Œä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šã€‚å½“type=loadBalancerï¼Œéœ€è¦æŒ‡å®š</span><br><span class="line">  sessionAffinity: string</span><br><span class="line">  #æ˜¯å¦æ”¯æŒsessionï¼Œå¯é€‰å€¼ä¸ºClietIPï¼Œé»˜è®¤å€¼ä¸ºç©º</span><br><span class="line">  #ClientIPè¡¨ç¤ºå°†åŒä¸€ä¸ªå®¢æˆ·ç«¯(æ ¹æ®å®¢æˆ·ç«¯IPåœ°å€å†³å®š)çš„è®¿é—®è¯·æ±‚éƒ½è½¬å‘åˆ°åŒä¸€ä¸ªåç«¯Pod</span><br><span class="line">  ports:</span><br><span class="line">  #serviceéœ€è¦æš´éœ²çš„ç«¯å£åˆ—è¡¨    </span><br><span class="line">  - name: string</span><br><span class="line">    #ç«¯å£åç§°</span><br><span class="line">    protocol: string</span><br><span class="line">    #ç«¯å£åè®®ï¼Œæ”¯æŒTCPæˆ–UDPï¼Œé»˜è®¤TCP</span><br><span class="line">     port: int</span><br><span class="line">    #æœåŠ¡ç›‘å¬çš„ç«¯å£å·</span><br><span class="line">     targetPort: int</span><br><span class="line">    #éœ€è¦è½¬å‘åˆ°åç«¯çš„ç«¯å£å·</span><br><span class="line">     nodePort: int</span><br><span class="line">    #å½“type=NodePortæ—¶ï¼ŒæŒ‡å®šæ˜ å°„åˆ°ç‰©ç†æœºçš„ç«¯å£å·</span><br><span class="line">  status:</span><br><span class="line">  #å½“type=LoadBalanceræ—¶ï¼Œè®¾ç½®å¤–éƒ¨è´Ÿè½½å‡è¡¡çš„åœ°å€ï¼Œç”¨äºå…¬æœ‰äº‘ç¯å¢ƒ    </span><br><span class="line">    loadBalancer:</span><br><span class="line">    #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨    </span><br><span class="line">      ingress:</span><br><span class="line">      #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ </span><br><span class="line">      ip: string</span><br><span class="line">      #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„IPåœ°å€</span><br><span class="line">      hostname: string</span><br><span class="line">     #å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨çš„æœºä¸»æœº</span><br></pre></td></tr></table></figure><h2 id="å…«ã€kubernetesä¸­çš„å››ç§port-1"><a href="#å…«ã€kubernetesä¸­çš„å››ç§port-1" class="headerlink" title="å…«ã€kubernetesä¸­çš„å››ç§port"></a>å…«ã€kubernetesä¸­çš„å››ç§port</h2><h3 id="1ï¼‰nodePort-1"><a href="#1ï¼‰nodePort-1" class="headerlink" title="1ï¼‰nodePort"></a>1ï¼‰nodePort</h3><blockquote><p><strong>nodePortæ˜¯å¤–éƒ¨è®¿é—®k8sé›†ç¾¤ä¸­serviceçš„ç«¯å£</strong>ï¼Œé€šè¿‡nodeIP: nodePortå¯ä»¥ä»å¤–éƒ¨è®¿é—®åˆ°æŸä¸ªserviceã€‚</p></blockquote><h3 id="2ï¼‰port-1"><a href="#2ï¼‰port-1" class="headerlink" title="2ï¼‰port"></a>2ï¼‰port</h3><blockquote><p><strong>portæ˜¯k8sé›†ç¾¤å†…éƒ¨è®¿é—®serviceçš„ç«¯å£</strong>ï¼Œå³é€šè¿‡clusterIP: portå¯ä»¥è®¿é—®åˆ°æŸä¸ªserviceã€‚</p></blockquote><h3 id="3ï¼‰targetPort-1"><a href="#3ï¼‰targetPort-1" class="headerlink" title="3ï¼‰targetPort"></a>3ï¼‰targetPort</h3><blockquote><p><strong>targetPortæ˜¯podçš„ç«¯å£</strong>ï¼Œä»portå’ŒnodePortæ¥çš„æµé‡ç»è¿‡kube-proxyæµå…¥åˆ°åç«¯podçš„targetPortä¸Šï¼Œæœ€åè¿›å…¥å®¹å™¨ã€‚</p></blockquote><h3 id="4ï¼‰containerPort-1"><a href="#4ï¼‰containerPort-1" class="headerlink" title="4ï¼‰containerPort"></a>4ï¼‰containerPort</h3><blockquote><p><strong>containerPortæ˜¯podå†…éƒ¨å®¹å™¨çš„ç«¯å£</strong>ï¼ŒtargetPortæ˜ å°„åˆ°containerPortã€‚</p></blockquote><p><img src="https://mmbiz.qpic.cn/mmbiz_png/ZyHzM6VdDdXcBuy39GptibDPKJMXiacaicepLhblRia9j7k0YRGicmTZW3RSuF4ofq38gHQY7dYOdu10G45lE1nzE7Q/640?wx_fmt=png&wxfrom=5&wx_lazy=1&wx_co=1" alt="å›¾ç‰‡"></p><h2 id="ä¹ã€kubernetesæœåŠ¡å‘ç°-1"><a href="#ä¹ã€kubernetesæœåŠ¡å‘ç°-1" class="headerlink" title="ä¹ã€kubernetesæœåŠ¡å‘ç°"></a>ä¹ã€kubernetesæœåŠ¡å‘ç°</h2><blockquote><p>Kubernetesæä¾›äº†ä¸¤ç§æ–¹å¼è¿›è¡ŒæœåŠ¡å‘ç°, å³<strong>ç¯å¢ƒå˜é‡å’ŒDNS</strong>, ç®€å•è¯´æ˜å¦‚ä¸‹:</p></blockquote><h3 id="1ï¼‰ç¯å¢ƒå˜é‡-1"><a href="#1ï¼‰ç¯å¢ƒå˜é‡-1" class="headerlink" title="1ï¼‰ç¯å¢ƒå˜é‡"></a>1ï¼‰ç¯å¢ƒå˜é‡</h3><blockquote><p>å½“ä½ åˆ›å»ºä¸€ä¸ªPodçš„æ—¶å€™ï¼Œkubeletä¼šåœ¨è¯¥Podä¸­æ³¨å…¥é›†ç¾¤å†…æ‰€æœ‰Serviceçš„ç›¸å…³ç¯å¢ƒå˜é‡ã€‚</p></blockquote><blockquote><p>ã€æ³¨æ„ã€‘è¦æƒ³ä¸€ä¸ªPodä¸­æ³¨å…¥æŸä¸ªServiceçš„ç¯å¢ƒå˜é‡ï¼Œåˆ™<strong>å¿…é¡»Serviceè¦æ¯”è¯¥Podå…ˆåˆ›å»º</strong>ã€‚è¿™ä¸€ç‚¹ï¼Œå‡ ä¹ä½¿å¾—è¿™ç§æ–¹å¼è¿›è¡ŒæœåŠ¡å‘ç°ä¸å¯ç”¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªServiceNameä¸ºredis-masterçš„Serviceï¼Œå¯¹åº”çš„ClusterIP:Portä¸º172.16.50.11:6379ï¼Œåˆ™å…¶å¯¹åº”çš„ç¯å¢ƒå˜é‡ä¸º:</p></blockquote><blockquote><p>REDIS_MASTER_SERVICE_HOST&#x3D;172.16.50.11<br>REDIS_MASTER_SERVICE_PORT&#x3D;6379<br>REDIS_MASTER_PORT&#x3D;tcp:&#x2F;&#x2F;172.16.50.11:6379<br>REDIS_MASTER_PORT_6379_TCP&#x3D;tcp:&#x2F;&#x2F;172.16.50.11:6379<br>REDIS_MASTER_PORT_6379_TCP_PROTO&#x3D;tcp<br>REDIS_MASTER_PORT_6379_TCP_PORT&#x3D;6379<br>REDIS_MASTER_PORT_6379_TCP_ADDR&#x3D;172.16.50.11</p></blockquote><h3 id="2-DNS-1"><a href="#2-DNS-1" class="headerlink" title="2) DNS"></a>2) DNS</h3><blockquote><p>è¿™æ˜¯k8så®˜æ–¹å¼ºçƒˆæ¨èçš„æ–¹å¼!!! å¯ä»¥é€šè¿‡cluster add-onæ–¹å¼è½»æ¾çš„åˆ›å»ºKubeDNSæ¥å¯¹é›†ç¾¤å†…çš„Serviceè¿›è¡ŒæœåŠ¡å‘ç°ã€‚</p></blockquote><h2 id="åã€Serviceä»£ç†æ¨¡å¼-1"><a href="#åã€Serviceä»£ç†æ¨¡å¼-1" class="headerlink" title="åã€Serviceä»£ç†æ¨¡å¼"></a>åã€Serviceä»£ç†æ¨¡å¼</h2><blockquote><p>k8sç¾¤é›†ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªkube-proxyçš„ç»„ä»¶ï¼Œkube-proxyå…¶å®æ˜¯ä¸€ä¸ªä»£ç†å±‚è´Ÿè´£å®ç°serviceã€‚</p></blockquote><blockquote><p><strong>Kubernetes v1.2ä¹‹å‰é»˜è®¤æ˜¯userspaceï¼Œv1.2ä¹‹åé»˜è®¤æ˜¯iptablesæ¨¡å¼</strong>ï¼Œiptablesæ¨¡å¼æ€§èƒ½å’Œå¯é æ€§æ›´å¥½ï¼Œä½†æ˜¯iptablesæ¨¡å¼ä¾èµ–å¥åº·æ£€æŸ¥ï¼Œåœ¨æ²¡æœ‰å¥åº·æ£€æŸ¥çš„æƒ…å†µä¸‹å¦‚æœä¸€ä¸ªpodä¸å“åº”ï¼Œiptablesæ¨¡å¼ä¸ä¼šåˆ‡æ¢å¦ä¸€ä¸ªpodä¸Šã€‚</p></blockquote><h3 id="1ï¼‰userspaceæ¨¡å¼-1"><a href="#1ï¼‰userspaceæ¨¡å¼-1" class="headerlink" title="1ï¼‰userspaceæ¨¡å¼"></a>1ï¼‰userspaceæ¨¡å¼</h3><blockquote><p>å®¢æˆ·ç«¯è®¿é—®ServiceIP(clusterIP)è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´åˆ°å†…æ ¸ä¸­çš„iptablesï¼Œç„¶åå›åˆ°ç”¨æˆ·ç©ºé—´kube-proxyï¼Œkube-proxyè´Ÿè´£ä»£ç†å·¥ä½œã€‚</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322231436.png" alt="å›¾ç‰‡"></p><p>ç¼ºç‚¹ï¼š</p><blockquote><p>å¯è§ï¼Œuserspaceè¿™ç§modeæœ€å¤§çš„é—®é¢˜æ˜¯ï¼Œserviceçš„è¯·æ±‚ä¼šå…ˆä»ç”¨æˆ·ç©ºé—´è¿›å…¥å†…æ ¸iptablesï¼Œç„¶åå†å›åˆ°ç”¨æˆ·ç©ºé—´ï¼Œç”±kube-proxyå®Œæˆåç«¯Endpointsçš„é€‰æ‹©å’Œä»£ç†å·¥ä½œï¼Œè¿™æ ·æµé‡ä»ç”¨æˆ·ç©ºé—´è¿›å‡ºå†…æ ¸å¸¦æ¥çš„æ€§èƒ½æŸè€—æ˜¯ä¸å¯æ¥å—çš„ã€‚è¿™ä¹Ÿæ˜¯k8s v1.0åŠä¹‹å‰ç‰ˆæœ¬ä¸­å¯¹kube-proxyè´¨ç–‘æœ€å¤§çš„ä¸€ç‚¹ï¼Œå› æ­¤ç¤¾åŒºå°±å¼€å§‹ç ”ç©¶iptables modeã€‚</p></blockquote><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>userspaceè¿™ç§æ¨¡å¼ä¸‹ï¼Œkube-proxy æŒç»­ç›‘å¬ Service ä»¥åŠ Endpoints å¯¹è±¡çš„å˜åŒ–ï¼›å¯¹æ¯ä¸ª Serviceï¼Œå®ƒéƒ½ä¸ºå…¶åœ¨æœ¬åœ°èŠ‚ç‚¹å¼€æ”¾ä¸€ä¸ªç«¯å£ï¼Œä½œä¸ºå…¶æœåŠ¡ä»£ç†ç«¯å£ï¼›å‘å¾€è¯¥ç«¯å£çš„è¯·æ±‚ä¼šé‡‡ç”¨ä¸€å®šçš„ç­–ç•¥è½¬å‘ç»™ä¸è¯¥æœåŠ¡å¯¹åº”çš„åç«¯ Pod å®ä½“ã€‚kube-proxy åŒæ—¶ä¼šåœ¨æœ¬åœ°èŠ‚ç‚¹è®¾ç½® iptables è§„åˆ™ï¼Œé…ç½®ä¸€ä¸ª Virtual IPï¼ŒæŠŠå‘å¾€ Virtual IP çš„è¯·æ±‚é‡å®šå‘åˆ°ä¸è¯¥ Virtual IP å¯¹åº”çš„æœåŠ¡ä»£ç†ç«¯å£ä¸Šã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322231458.png" alt="å›¾ç‰‡"></p><blockquote><p>ã€åˆ†æã€‘è¯¥æ¨¡å¼è¯·æ±‚åœ¨åˆ°è¾¾ iptables è¿›è¡Œå¤„ç†æ—¶å°±ä¼šè¿›å…¥å†…æ ¸ï¼Œè€Œ kube-proxy ç›‘å¬åˆ™æ˜¯åœ¨ç”¨æˆ·æ€, è¯·æ±‚å°±å½¢æˆäº†ä»ç”¨æˆ·æ€åˆ°å†…æ ¸æ€å†è¿”å›åˆ°ç”¨æˆ·æ€çš„ä¼ é€’è¿‡ç¨‹, ä¸€å®šç¨‹åº¦é™ä½äº†æœåŠ¡æ€§èƒ½ã€‚</p></blockquote><h3 id="2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰-1"><a href="#2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰-1" class="headerlink" title="2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰"></a>2ï¼‰iptablesæ¨¡å¼ï¼ˆé»˜è®¤æ¨¡å¼ï¼‰</h3><blockquote><p>è¯¥æ¨¡å¼å®Œå…¨åˆ©ç”¨å†…æ ¸iptablesæ¥å®ç°serviceçš„ä»£ç†å’ŒLB, è¿™æ˜¯K8såœ¨<strong>v1.2åŠä¹‹åç‰ˆæœ¬é»˜è®¤æ¨¡å¼</strong>. å·¥ä½œåŸç†å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322231525.png" alt="å›¾ç‰‡"></p><blockquote><p><strong>iptables modeå› ä¸ºä½¿ç”¨iptable NATæ¥å®Œæˆè½¬å‘ï¼Œä¹Ÿå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—</strong>ã€‚å¦å¤–ï¼Œå¦‚æœé›†ç¾¤ä¸­å­˜åœ¨ä¸Šä¸‡çš„Service&#x2F;Endpointï¼Œé‚£ä¹ˆNodeä¸Šçš„iptables ruleså°†ä¼šéå¸¸åºå¤§ï¼Œæ€§èƒ½è¿˜ä¼šå†æ‰“æŠ˜æ‰£ã€‚è¿™ä¹Ÿå¯¼è‡´ç›®å‰å¤§éƒ¨åˆ†ä¼ä¸šç”¨k8sä¸Šç”Ÿäº§æ—¶ï¼Œéƒ½ä¸ä¼šç›´æ¥ç”¨kube-proxyä½œä¸ºæœåŠ¡ä»£ç†ï¼Œè€Œæ˜¯é€šè¿‡è‡ªå·±å¼€å‘æˆ–è€…é€šè¿‡Ingress Controlleræ¥é›†æˆHAProxy, Nginxæ¥ä»£æ›¿kube-proxyã€‚</p></blockquote><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>iptables æ¨¡å¼ä¸ userspace ç›¸åŒï¼Œkube-proxy æŒç»­ç›‘å¬ Service ä»¥åŠ Endpoints å¯¹è±¡çš„å˜åŒ–ï¼›ä½†å®ƒå¹¶ä¸åœ¨æœ¬åœ°èŠ‚ç‚¹å¼€å¯åå‘ä»£ç†æœåŠ¡ï¼Œè€Œæ˜¯æŠŠåå‘ä»£ç†å…¨éƒ¨äº¤ç»™ iptables æ¥å®ç°ï¼›å³ iptables ç›´æ¥å°†å¯¹ VIP çš„è¯·æ±‚è½¬å‘ç»™åç«¯ Podï¼Œé€šè¿‡ iptables è®¾ç½®è½¬å‘ç­–ç•¥ã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322231458.png" alt="å›¾ç‰‡"></p><blockquote><p>ã€åˆ†æã€‘ è¯¥æ¨¡å¼ç›¸æ¯” userspace æ¨¡å¼ï¼Œå…‹æœäº†è¯·æ±‚åœ¨ç”¨æˆ·æ€-å†…æ ¸æ€åå¤ä¼ é€’çš„é—®é¢˜ï¼Œæ€§èƒ½ä¸Šæœ‰æ‰€æå‡ï¼Œä½†ä½¿ç”¨ iptables NAT æ¥å®Œæˆè½¬å‘ï¼Œå­˜åœ¨ä¸å¯å¿½è§†çš„æ€§èƒ½æŸè€—ï¼Œè€Œä¸”åœ¨å¤§è§„æ¨¡åœºæ™¯ä¸‹ï¼Œiptables è§„åˆ™çš„æ¡ç›®ä¼šååˆ†å·¨å¤§ï¼Œæ€§èƒ½ä¸Šè¿˜è¦å†æ‰“æŠ˜æ‰£ã€‚</p></blockquote><p>ç¤ºä¾‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &lt;&lt; <span class="string">EOF &gt; mysql-service.yaml</span></span><br><span class="line"><span class="string">apiVersion: v1</span></span><br><span class="line"><span class="string">kind: Service</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    name: mysql</span></span><br><span class="line"><span class="string">    role: service</span></span><br><span class="line"><span class="string">  name: mysql-service</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  ports:</span></span><br><span class="line"><span class="string">    - port: 3306</span></span><br><span class="line"><span class="string">      targetPort: 3306</span></span><br><span class="line"><span class="string">      nodePort: 30964</span></span><br><span class="line"><span class="string">  type: NodePort</span></span><br><span class="line"><span class="string">  selector:</span></span><br><span class="line"><span class="string">    mysql-service: &quot;true&quot;</span></span><br><span class="line"><span class="string">    name: mysql</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">$ kubectl apply -f mysql-service.yaml</span><br><span class="line">$ kubectl get svc</span><br></pre></td></tr></table></figure><h3 id="3ï¼‰ipvsæ¨¡å‹-1"><a href="#3ï¼‰ipvsæ¨¡å‹-1" class="headerlink" title="3ï¼‰ipvsæ¨¡å‹"></a>3ï¼‰ipvsæ¨¡å‹</h3><blockquote><p>åœ¨kubernetes 1.8ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­ï¼Œå¯¹äºkube-proxyç»„ä»¶å¢åŠ äº†é™¤iptablesæ¨¡å¼å’Œç”¨æˆ·æ¨¡å¼ä¹‹å¤–è¿˜æ”¯æŒipvsæ¨¡å¼ã€‚<strong>kube-proxy ipvs æ˜¯åŸºäº NAT å®ç°çš„</strong>ï¼Œé€šè¿‡ipvsçš„NATæ¨¡å¼ï¼Œå¯¹è®¿é—®k8s serviceçš„è¯·æ±‚è¿›è¡Œè™šIPåˆ°POD IPçš„è½¬å‘ã€‚å½“åˆ›å»ºä¸€ä¸ª service åï¼Œkubernetes ä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªç½‘å¡ï¼ŒåŒæ—¶å¸®ä½ å°† Service IP(VIP) ç»‘å®šä¸Šï¼Œæ­¤æ—¶ç›¸å½“äºæ¯ä¸ª Node éƒ½æ˜¯ä¸€ä¸ª dsï¼Œè€Œå…¶ä»–ä»»ä½• Node ä¸Šçš„ Podï¼Œç”šè‡³æ˜¯å®¿ä¸»æœºæœåŠ¡(æ¯”å¦‚ kube-apiserver çš„ 6443)éƒ½å¯èƒ½æˆä¸º rsï¼›</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322230705.png" alt="ipvs-serviceæ¨¡å‹"></p><p>è¯¦ç»†å·¥ä½œæµç¨‹ï¼š</p><blockquote><p>ä¸iptablesã€userspace æ¨¡å¼ä¸€æ ·ï¼Œkube-proxy ä¾ç„¶ç›‘å¬Serviceä»¥åŠEndpointså¯¹è±¡çš„å˜åŒ–, ä¸è¿‡å®ƒå¹¶ä¸åˆ›å»ºåå‘ä»£ç†, ä¹Ÿä¸åˆ›å»ºå¤§é‡çš„ iptables è§„åˆ™, è€Œæ˜¯é€šè¿‡netlink åˆ›å»ºipvsè§„åˆ™ï¼Œå¹¶ä½¿ç”¨k8s Serviceä¸Endpointsä¿¡æ¯ï¼Œå¯¹æ‰€åœ¨èŠ‚ç‚¹çš„ipvsè§„åˆ™è¿›è¡Œå®šæœŸåŒæ­¥; netlink ä¸ iptables åº•å±‚éƒ½æ˜¯åŸºäº netfilter é’©å­ï¼Œä½†æ˜¯ netlink ç”±äºé‡‡ç”¨äº† hash table è€Œä¸”ç›´æ¥å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œåœ¨æ€§èƒ½ä¸Šæ¯” iptables æ›´ä¼˜ã€‚å…¶å·¥ä½œæµç¨‹å¤§ä½“å¦‚ä¸‹:</p></blockquote><p><img src="https://res.yongwang.lu/img/20230322230748.png" alt="ipvså·¥ä½œæµç¨‹"></p><blockquote><p>ã€åˆ†æã€‘ipvs æ˜¯ç›®å‰ kube-proxy æ‰€æ”¯æŒçš„æœ€æ–°ä»£ç†æ¨¡å¼ï¼Œç›¸æ¯”ä½¿ç”¨ iptablesï¼Œä½¿ç”¨ ipvs å…·æœ‰æ›´é«˜çš„æ€§èƒ½ã€‚</p></blockquote><hr><h3 id="4ï¼‰kube-proxyé…ç½®-ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰-1"><a href="#4ï¼‰kube-proxyé…ç½®-ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰-1" class="headerlink" title="4ï¼‰kube-proxyé…ç½® ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰"></a>4ï¼‰kube-proxyé…ç½® ipvsæ¨¡å¼ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰</h3><p>1ã€åŠ è½½ip_vsç›¸å…³å†…æ ¸æ¨¡å—</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ modprobe -- ip_vs</span><br><span class="line">$ modprobe -- ip_vs_sh</span><br><span class="line">$ modprobe -- ip_vs_rr</span><br><span class="line">$ modprobe -- ip_vs_wrr</span><br><span class="line">$ modprobe -- nf_conntrack_ipv4</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰èŠ‚ç‚¹éªŒè¯å¼€å¯äº†ipvsï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ lsmod |grep ip_vs</span><br></pre></td></tr></table></figure><p>2ã€å®‰è£…ipvsadmå·¥å…·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ yum install ipset ipvsadm -y</span><br></pre></td></tr></table></figure><p>3ã€ç¼–è¾‘kube-proxyé…ç½®æ–‡ä»¶ï¼Œmodeä¿®æ”¹æˆipvs</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl edit  configmap -n kube-system  kube-proxy</span><br></pre></td></tr></table></figure><p>4ã€é‡å¯kube-proxy<br>å…ˆæŸ¥çœ‹ä¹‹å‰çš„kube-proxy</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy</span><br></pre></td></tr></table></figure><p>åˆ æ‰ä¸Šé¢ä¸‰ä¸ªkube-proxyï¼Œé‡æ–°æ‹‰èµ·æ–°çš„æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy |awk <span class="string">&#x27;&#123;system(&quot;kubectl delete pod &quot;$1&quot; -n kube-system&quot;)&#125;&#x27;</span></span><br></pre></td></tr></table></figure><p>å†æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy</span><br></pre></td></tr></table></figure><p>5ã€æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipvsadm -Ln</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰5ã€å·¥ä½œè´Ÿè½½-Deployment</title>
    <link href="https://blog.yongwang.lu/post/c2d6c004.html"/>
    <id>https://blog.yongwang.lu/post/c2d6c004.html</id>
    <published>2023-01-05T06:40:00.000Z</published>
    <updated>2023-01-05T06:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>åœ¨ kubernetes çš„ä¸–ç•Œé‡Œï¼ŒPod æ˜¯è¿è¡Œåº”ç”¨çš„è½½ä½“ã€‚ Pod æ˜¯ç”±å¤šä¸ªå®¹å™¨ç»„æˆã€æ˜¯ kubernetes çš„æœ€å°è°ƒåº¦å•å…ƒã€Pod å…±äº«åº•å±‚èµ„æºã€ç”± kubernetes æ¥ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚</p></blockquote><blockquote><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ç›´æ¥åˆ›å»º Podï¼Œè€Œæ˜¯é€šè¿‡ Deployment æ¥åˆ›å»º Podï¼Œç”± Deployment æ¥è´Ÿè´£åˆ›å»ºã€æ›´æ–°ã€ç»´æŠ¤å…¶æ‰€ç®¡ç†çš„æ‰€æœ‰ Podsã€‚</p></blockquote><blockquote><p>è¿™é‡Œæ³¨æ„å¹¶ä¸ç›´æ¥ç®¡ç†pod, è€Œæ˜¯é€šè¿‡ç®¡ç†replicasetæ¥é—´æ¥ç®¡ç†podï¼Œå³ï¼šdeploymentç®¡ç†replicasetï¼Œreplicasetç®¡ç†podã€‚æ‰€ä»¥deploymentæ¯”replicasetçš„åŠŸèƒ½æ›´å¼ºå¤§ã€‚</p></blockquote><h2 id="ä¸€ã€Deploymentä»‹ç»ä¸å·¥ä½œåŸç†"><a href="#ä¸€ã€Deploymentä»‹ç»ä¸å·¥ä½œåŸç†" class="headerlink" title="ä¸€ã€Deploymentä»‹ç»ä¸å·¥ä½œåŸç†"></a>ä¸€ã€Deploymentä»‹ç»ä¸å·¥ä½œåŸç†</h2><h3 id="1-ä»‹ç»"><a href="#1-ä»‹ç»" class="headerlink" title="1.ä»‹ç»"></a>1.ä»‹ç»</h3><p>Deploymentæ˜¯ä¸€ç§æ›´é«˜é˜¶çš„å·¥ä½œè´Ÿè½½èµ„æºã€‚å…¶å¯ä»¥è§†ä½œä¸ºå¯¹RSçš„å†ä¸€æ¬¡å‡çº§ã€‚å…¶ä¸ä»…å¯ä»¥éƒ¨ç½²åº”ç”¨è¿˜å¯ä»¥é€šè¿‡å£°æ˜çš„æ–¹å¼å‡çº§åº”ç”¨ã€‚å…·ä½“åœ°ï¼ŒDeploymentè¢«åˆ›å»ºåï¼Œå…¶å†…éƒ¨å…ˆåˆ›å»ºç›¸åº”çš„RSèµ„æºã€‚å†åˆ©ç”¨è¯¥RSèµ„æºåˆ›å»ºç›¸åº”çš„Pod</p><p><img src="https://res.yongwang.lu/img/202303222110977.png" alt="deploymentä»‹ç»"></p><h3 id="2-å·¥ä½œæµç¨‹"><a href="#2-å·¥ä½œæµç¨‹" class="headerlink" title="2.å·¥ä½œæµç¨‹"></a>2.å·¥ä½œæµç¨‹</h3><p><img src="https://res.yongwang.lu/img/202303222114591.png" alt="å·¥ä½œæµç¨‹"><br>å›¾ç‰‡æ¥æºä¹¦ç±: kubernetes in action</p><p>å®¢æˆ·ç«¯å°†åˆ›å»º Deployment çš„è¯·æ±‚å‘é€ç»™ Apiserver<br>Apiserver å°† Deployment ä¿¡æ¯å†™å…¥ etcd,etcd å°†å†™å…¥ç»“æœå“åº”ç»™ Apiserver,Apiserver å°†åˆ›å»ºç»“æœå“åº”ç»™å®¢æˆ·ç«¯ (æ­¤æ—¶æœªç»è¿‡ ControllerManager,deployment çš„ READY çŠ¶æ€ä¸º 0)<br>ControllerManager é€šè¿‡ Apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°æ–°å¢çš„ Deployment èµ„æºï¼ŒDeployment controller å‘ Apiserver å‘é€åˆ›å»º RS çš„è¯·æ±‚ï¼ŒApiserver å°† RS ä¿¡æ¯å†™å…¥ etcdã€‚ã€‚ã€‚<br>ControllerManager é€šè¿‡ Apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°æ–°å¢çš„ ReplicaSet èµ„æºï¼ŒReplicaSet controller å‘ Apiserver å‘é€åˆ›å»º Pod çš„è¯·æ±‚ï¼ŒApiserver å°† Pod ä¿¡æ¯å†™å…¥ etcdã€‚ã€‚ã€‚<br>Scheduler é€šè¿‡ Apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°æœªè°ƒåº¦çš„ Pod çš„é€šçŸ¥ï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•é€‰æ‹©ä¸€ä¸ª node èŠ‚ç‚¹ï¼Œå‘Šè¯‰ Apiserver è¿™ä¸ª Pod åº”è¯¥è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹<br>Apiserver å°†è¿™ä¸ª Pod å’Œ node çš„ç»‘å®šä¿¡æ¯æ›´æ–°åˆ° etcd,etcd å°†å†™å…¥ç»“æœå“åº”ç»™ Apiserver<br>Kubelet é€šè¿‡ Apiserver çš„ watch æ¥å£ï¼Œè·å–åˆ°å½“å‰èŠ‚ç‚¹æœ‰åˆ›å»º Pod çš„é€šçŸ¥ï¼ŒKubelet è°ƒç”¨ docker åˆ›å»ºå®¹å™¨ï¼ŒKubelet å°† Pod è¿è¡ŒçŠ¶æ€å‘é€ç»™ Apiserver<br>Apiserver å°† Pod çŠ¶æ€ä¿¡æ¯æ›´æ–°åˆ° etcd</p><h2 id="äºŒã€Deploymentçš„ä½¿ç”¨"><a href="#äºŒã€Deploymentçš„ä½¿ç”¨" class="headerlink" title="äºŒã€Deploymentçš„ä½¿ç”¨"></a>äºŒã€Deploymentçš„ä½¿ç”¨</h2><h3 id="1-åˆ›å»ºDeployment"><a href="#1-åˆ›å»ºDeployment" class="headerlink" title="1.åˆ›å»ºDeployment"></a>1.åˆ›å»ºDeployment</h3><p>åˆ©ç”¨ Deployment ä¹Ÿå¯ä»¥åˆ›å»º Podï¼Œä¸‹é¢æ¥æ¯”è¾ƒä¸€ä¸‹ä¸¤ç§æ–¹å¼åˆ›å»º Pod çš„åŒºåˆ«ã€‚</p><blockquote><p>æ–¹å¼ä¸€ï¼šä½¿ç”¨kubectl run åˆ›å»º Pod</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run my-nginx --image=nginx:1.20 -n hello-world</span><br></pre></td></tr></table></figure><blockquote><p>æ–¹å¼äºŒï¼šä½¿ç”¨ kubectl create deployment åˆ›å»º Pod</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create deployment my-nginx-dep --image=nginx:1.20 -n hello-world</span><br></pre></td></tr></table></figure><p>å¦‚æœæ­¤æ—¶è¦åˆ é™¤ä¸Šé¢åˆ›å»ºçš„ Pod ï¼Œå¯¹äºæ–¹å¼ä¸€åˆ›å»ºçš„ï¼Œå¾ˆç®€å•ï¼Œç›´æ¥æ‰§è¡Œä¸‹é¢çš„è¿™è¡Œè¯­å¥å³å¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod my-nginx -n hello-world</span><br></pre></td></tr></table></figure><p>è€Œè¦åˆ é™¤æ–¹å¼äºŒåˆ›å»ºçš„ Pod ï¼Œæˆ‘ä»¬è¿˜èƒ½ç”¨ä¸‹é¢çš„è¿™è¡Œè¯­å¥å—ï¼Ÿ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pod my-nginx-dep -n hello-world</span><br></pre></td></tr></table></figure><p>è¿™ä¹ˆåšï¼Œæ˜¯åˆ ä¸æ‰çš„ã€‚å› ä¸ºæ¯åˆ é™¤ä¸€æ¬¡ï¼Œk8såˆä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ my-nginx-dep çš„ Podï¼ˆDeploymentè‡ªæ„ˆèƒ½åŠ›çš„ä½“ç°ï¼‰ã€‚</p><p>åŸå› åœ¨äºæ–¹å¼äºŒæ˜¯é€šè¿‡ Deployment çš„æ–¹å¼åˆ›å»ºçš„ Podï¼ˆä»¥éƒ¨ç½²ä¸€ä¸ªåº”ç”¨çš„æ–¹å¼ï¼‰ã€‚</p><p>å¦‚æœè¦åˆ é™¤æ–¹å¼äºŒåˆ›å»ºçš„ Podï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ­¥éª¤è¿›è¡Œï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¬¬ä¸€æ­¥ï¼Œè·å–deployï¼ˆéƒ¨ç½²ï¼‰åˆ—è¡¨ä¿¡æ¯</span></span><br><span class="line">kubectl get deploy -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¬¬äºŒæ­¥ï¼Œé€šè¿‡åˆ é™¤deployï¼ˆéƒ¨ç½²ï¼‰çš„æ–¹å¼åˆ é™¤Pod</span></span><br><span class="line">kubectl delete deploy my-tomcat -n hello-world</span><br></pre></td></tr></table></figure><h3 id="2-Deploymentçš„å„ç§èƒ½åŠ›"><a href="#2-Deploymentçš„å„ç§èƒ½åŠ›" class="headerlink" title="2.Deploymentçš„å„ç§èƒ½åŠ›"></a>2.Deploymentçš„å„ç§èƒ½åŠ›</h3><h4 id="2-1-å¤šå‰¯æœ¬èƒ½åŠ›"><a href="#2-1-å¤šå‰¯æœ¬èƒ½åŠ›" class="headerlink" title="2.1 å¤šå‰¯æœ¬èƒ½åŠ›"></a>2.1 å¤šå‰¯æœ¬èƒ½åŠ›</h4><p>å‰¯æœ¬ï¼šå¯ä»¥ç†è§£ä¸ºå¯¹äºä¸€ä¸ªåº”ç”¨è€Œè¨€ï¼Œå°†å®ƒè¿è¡Œåœ¨ä¸€ä¸ª Pod ä¸Šå°±æ˜¯èµ·ä¸€ä¸ªå‰¯æœ¬ï¼Œå°†å®ƒè¿è¡Œåœ¨å¤šä¸ª Pod ä¸Šï¼Œå°±æ˜¯èµ·äº†å¤šä¸ªå‰¯æœ¬ã€‚</p><p>ä¸‹é¢é€šè¿‡ä¸¤ç§æ–¹å¼ï¼Œæ¥å®ç°å¤šå‰¯æœ¬çš„èƒ½åŠ›ã€‚</p><blockquote><p>æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œæ–¹å¼</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é€šè¿‡éƒ¨ç½²çš„æ–¹å¼ï¼Œåˆ›å»ºnginxçš„3ä¸ªå‰¯æœ¬</span></span><br><span class="line">kubectl create deployment nginx-base --image=nginx --replicas=3 -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹éƒ¨ç½²åˆ—è¡¨ä¿¡æ¯</span></span><br><span class="line">kubectl get deploy -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æœ¬æ¬¡éƒ¨ç½²ï¼ˆå³åŒæ—¶åˆ é™¤3ä¸ªPodï¼‰</span></span><br><span class="line">kubectl delete deploy nginx-base -n hello-world</span><br></pre></td></tr></table></figure><blockquote><p>æ–¹å¼äºŒï¼šyamlæ–‡ä»¶æ–¹å¼</p></blockquote><p>ï¼ˆ1ï¼‰å†™ä¸€ä¸ª yaml æ–‡ä»¶ï¼Œä¾‹å¦‚ nginx-base.yaml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span> <span class="comment"># ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>    <span class="comment"># èµ„æºç±»å‹</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx-base</span> <span class="comment"># æ ‡ç­¾åç§°</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-base</span>  <span class="comment"># æœ¬æ¬¡éƒ¨ç½²çš„åå­—</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">hello-world</span> <span class="comment"># å‘½åç©ºé—´</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> <span class="comment"># å‰¯æœ¬æ•°é‡</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-base</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-base</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx:1.20</span> <span class="comment"># å®¹å™¨çš„é•œåƒåç§°</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span>  <span class="comment"># å®¹å™¨å</span></span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰æ‰§è¡Œ nginx-base.yaml æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx-base.yaml</span><br></pre></td></tr></table></figure><h4 id="2-2-æ‰©ç¼©å®¹èƒ½åŠ›"><a href="#2-2-æ‰©ç¼©å®¹èƒ½åŠ›" class="headerlink" title="2.2 æ‰©ç¼©å®¹èƒ½åŠ›"></a>2.2 æ‰©ç¼©å®¹èƒ½åŠ›</h4><p>æ‰©å®¹ï¼šé‡åˆ°æµé‡é«˜å³°ï¼Œéœ€è¦å¢åŠ å‰¯æœ¬æ•°é‡ï¼Œé™ä½å½“å‰è´Ÿè½½</p><p>ç¼©å®¹ï¼šæµé‡é«˜å³°è¿‡å»ï¼Œä¸éœ€è¦è¿™ä¹ˆå¤šå‰¯æœ¬ï¼Œå‡å°‘æ•°é‡</p><blockquote><p>æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œæ–¹å¼</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†nginx-baseçš„å‰¯æœ¬æ•°é‡æ‰©å®¹åˆ°5ä¸ª</span></span><br><span class="line">kubectl scale --replicas=5 deployment/nginx-base -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†nginx-baseçš„å‰¯æœ¬æ•°é‡ç¼©å‡åˆ°2ä¸ª</span></span><br><span class="line">kubectl scale --replicas=2 deployment/nginx-base -n hello-world</span><br></pre></td></tr></table></figure><blockquote><p>æ–¹å¼äºŒï¼šä¿®æ”¹yamlæ–¹å¼</p></blockquote><p>æ‰“å¼€å¯¹åº”çš„ yaml æ–‡ä»¶ï¼Œä¿®æ”¹å‰¯æœ¬å‘æ•°é‡ï¼Œç„¶åä¿å­˜é€€å‡ºå³å¯ã€‚</p><p>ï¼ˆ1ï¼‰æ‰“å¼€æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy</span><br><span class="line"></span><br><span class="line">kubectl edit deployment nginx-base</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ç¼–è¾‘æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 <span class="comment"># ç‰ˆæœ¬å·</span></span><br><span class="line">kind: Deployment    <span class="comment"># èµ„æºç±»å‹</span></span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-base <span class="comment"># æ ‡ç­¾åç§°</span></span><br><span class="line">  name: nginx-base  <span class="comment"># æœ¬æ¬¡éƒ¨ç½²çš„åå­—</span></span><br><span class="line">  namespace: hello-world <span class="comment"># å‘½åç©ºé—´</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å‰¯æœ¬æ•°é‡</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-base</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-base</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.20 <span class="comment"># å®¹å™¨çš„é•œåƒåç§°</span></span><br><span class="line">        name: nginx  <span class="comment"># å®¹å™¨å</span></span><br></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ä¿å­˜é€€å‡º</p><h4 id="2-3-è‡ªæ„ˆåŠæ•…éšœè½¬ç§»èƒ½åŠ›"><a href="#2-3-è‡ªæ„ˆåŠæ•…éšœè½¬ç§»èƒ½åŠ›" class="headerlink" title="2.3 è‡ªæ„ˆåŠæ•…éšœè½¬ç§»èƒ½åŠ›"></a>2.3 è‡ªæ„ˆåŠæ•…éšœè½¬ç§»èƒ½åŠ›</h4><p>è‡ªæ„ˆèƒ½åŠ›ï¼šå‡è®¾æŸä¸ª Pod å‘ç”Ÿæ•…éšœï¼Œä¸èƒ½æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œæ­¤æ—¶ k8s ä¼šè‡ªåŠ¨æ€æ­»è¯¥ Pod ï¼Œç„¶åå†å°†è¯¥ Pod é‡æ–°å¯åŠ¨ã€‚</p><p>è½¬ç§»èƒ½åŠ›ï¼šå‡è®¾æŸä¸ª Pod æ‰€åœ¨çš„ç»“ç‚¹ node-01 å‘ç”Ÿäº†å®•æœºï¼Œæ•´ä¸ªæœåŠ¡å™¨åæ‰ï¼Œä¸èƒ½æ­£å¸¸ä½¿ç”¨ï¼Œå½“ k8s ç»è¿‡ä¸€å°æ®µæ—¶é—´ï¼ˆå¯èƒ½æ˜¯5åˆ†é’Ÿï¼‰æ£€æµ‹åï¼Œå‘ç°è¯¥æœåŠ¡å™¨ç¡®å®ä¸èƒ½æä¾›æœåŠ¡äº†ï¼Œé‚£ä¹ˆ k8s ä¼šè‡ªåŠ¨åœ¨å…¶å®ƒç»“ç‚¹ä¸Šé‡æ–°åˆ›å»º node-01 ç»“ç‚¹é‡Œé¢çš„æ‰€æœ‰ Pod ï¼Œä»¥è¾¾åˆ°æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡çš„ç›®çš„ã€‚</p><h4 id="2-4-æ»šåŠ¨æ›´æ–°èƒ½åŠ›"><a href="#2-4-æ»šåŠ¨æ›´æ–°èƒ½åŠ›" class="headerlink" title="2.4 æ»šåŠ¨æ›´æ–°èƒ½åŠ›"></a>2.4 æ»šåŠ¨æ›´æ–°èƒ½åŠ›</h4><p>k8s åœ¨æ›´æ–°é›†ç¾¤åº”ç”¨æ—¶ï¼Œå¯¹äºæ¯ä¸ªç»“ç‚¹ä¸Šçš„ Pod ï¼Œä¼šå…ˆå¯åŠ¨ä¸€ä¸ªæ–°çš„ Pod ï¼Œç„¶åå†åœæ‰å¯¹åº”çš„è€çš„ Podï¼Œå¦‚æ­¤å¾ªç¯ï¼Œç›´è‡³å®ç°æ¯ä¸ªç»“ç‚¹ä¸Šçš„ Pod çš„æ›´æ–°ï¼Œæ‰ç®—å®Œæˆæœ¬æ¬¡é›†ç¾¤åº”ç”¨çš„æ›´æ–°ã€‚</p><blockquote><p>æ–¹å¼ä¸€ï¼šå‘½ä»¤è¡Œæ–¹å¼</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl <span class="built_in">set</span> image deployment/nginx-base nginx=nginx:1.16.1 --record -n hello-world</span><br><span class="line"></span><br><span class="line">kubectl rollout status deployment/nginx-base -n hello-world</span><br></pre></td></tr></table></figure><blockquote><p>æ–¹å¼äºŒï¼šä¿®æ”¹yamlæ–¹å¼</p></blockquote><p>æ‰“å¼€å¯¹åº”çš„ yaml æ–‡ä»¶ï¼Œä¿®æ”¹å‰¯æœ¬å‘æ•°é‡ï¼Œç„¶åä¿å­˜é€€å‡ºå³å¯ã€‚</p><p>ï¼ˆ1ï¼‰æ‰“å¼€æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get deploy</span><br><span class="line"></span><br><span class="line">kubectl edit deployment nginx-base</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰ç¼–è¾‘æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1 <span class="comment"># ç‰ˆæœ¬å·</span></span><br><span class="line">kind: Deployment    <span class="comment"># èµ„æºç±»å‹</span></span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-base <span class="comment"># æ ‡ç­¾åç§°</span></span><br><span class="line">  name: nginx-base  <span class="comment"># æœ¬æ¬¡éƒ¨ç½²çš„åå­—</span></span><br><span class="line">  namespace: hello-world <span class="comment"># å‘½åç©ºé—´</span></span><br><span class="line">spec:</span><br><span class="line">  replicas: 2 <span class="comment"># å‰¯æœ¬æ•°é‡</span></span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-base</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-base</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx:1.16.1 <span class="comment"># å®¹å™¨çš„é•œåƒåç§°</span></span><br><span class="line">        name: nginx  <span class="comment"># å®¹å™¨å</span></span><br></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰ä¿å­˜é€€å‡º</p><h4 id="2-5-ç‰ˆæœ¬å›é€€èƒ½åŠ›"><a href="#2-5-ç‰ˆæœ¬å›é€€èƒ½åŠ›" class="headerlink" title="2.5 ç‰ˆæœ¬å›é€€èƒ½åŠ›"></a>2.5 ç‰ˆæœ¬å›é€€èƒ½åŠ›</h4><p>å¦‚æœå¯¹å½“å‰è¿™æ¬¡éƒ¨ç½²ä¸æ»¡æ„ï¼Œæ— æ³•æ­£å¸¸æä¾›æœåŠ¡ï¼Œk8så¯ä»¥å›æ»šåˆ°ä¹‹å‰çš„å†å²ç‰ˆæœ¬ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å†å²è®°å½•</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-base -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment">#æŸ¥çœ‹æŸä¸ªå†å²è¯¦æƒ…</span></span><br><span class="line">kubectl rollout <span class="built_in">history</span> deployment/nginx-base --revision=2</span><br><span class="line"></span><br><span class="line"><span class="comment">#å›æ»šåˆ°ä¸Šæ¬¡ç‰ˆæœ¬</span></span><br><span class="line">kubectl rollout undo deployment/nginx-base -n hello-world</span><br><span class="line"></span><br><span class="line"><span class="comment">#å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">kubectl rollout undo deployment/nginx-base --to-revision=2 -n hello-world</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰4ã€å·¥ä½œè´Ÿè½½</title>
    <link href="https://blog.yongwang.lu/post/c56c5900.html"/>
    <id>https://blog.yongwang.lu/post/c56c5900.html</id>
    <published>2023-01-05T05:40:00.000Z</published>
    <updated>2023-01-05T05:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒï¼š <a href="https://kubernetes.io/zh/docs/" title="Kubernetes æ–‡æ¡£">Kubernetes æ–‡æ¡£</a> &#x2F; <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/" title="å·¥ä½œè´Ÿè½½">å·¥ä½œè´Ÿè½½</a></p><h2 id="ä¸€ã€kubernetesä¸­çš„å·¥ä½œè´Ÿè½½"><a href="#ä¸€ã€kubernetesä¸­çš„å·¥ä½œè´Ÿè½½" class="headerlink" title="ä¸€ã€kubernetesä¸­çš„å·¥ä½œè´Ÿè½½"></a>ä¸€ã€kubernetesä¸­çš„å·¥ä½œè´Ÿè½½</h2><h3 id="1ã€k8sä¸­çš„å·¥ä½œè´Ÿè½½"><a href="#1ã€k8sä¸­çš„å·¥ä½œè´Ÿè½½" class="headerlink" title="1ã€k8sä¸­çš„å·¥ä½œè´Ÿè½½"></a>1ã€k8sä¸­çš„å·¥ä½œè´Ÿè½½</h3><p>Kubernetesä¸­å†…å»ºäº†å¾ˆå¤šcontrollerï¼ˆæ§åˆ¶å™¨ï¼‰ï¼Œè¿™äº›ç›¸å½“äºä¸€ä¸ªçŠ¶æ€æœºï¼Œç”¨æ¥æ§åˆ¶Podçš„å…·ä½“çŠ¶æ€å’Œè¡Œä¸º</p><ul><li><p><code>Deployment</code>ï¼šé€‚åˆæ— çŠ¶æ€çš„æœåŠ¡éƒ¨ç½²</p></li><li><p><code>ReplicaSet</code> : é€šä¿—è®²å‰¯æœ¬çš„ç®¡ç†, å®é™…åº”ç”¨ä¸­å»ºè®®ä½¿ç”¨ Deployment è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ ReplicaSet</p></li><li><p><code>StatefullSet</code>ï¼šç”¨æ¥ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨çš„å·¥ä½œè´Ÿè½½ API å¯¹è±¡ã€‚</p></li><li><p><code>DaemonSet</code>ï¼šä¸€æ¬¡éƒ¨ç½²ï¼Œæ‰€æœ‰çš„nodeèŠ‚ç‚¹éƒ½ä¼šéƒ¨ç½²ï¼Œä¾‹å¦‚ä¸€äº›å…¸å‹çš„åº”ç”¨åœºæ™¯ï¼š<br>è¿è¡Œé›†ç¾¤å­˜å‚¨ daemonï¼Œä¾‹å¦‚åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œ glusterdã€ceph åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œæ—¥å¿—æ”¶é›† daemonï¼Œä¾‹å¦‚ fluentdã€ logstash åœ¨æ¯ä¸ªNodeä¸Šè¿è¡Œç›‘æ§ daemonï¼Œä¾‹å¦‚ Prometheus Node Exporter</p></li><li><p><code>Job</code>ï¼šä¸€æ¬¡æ€§çš„æ‰§è¡Œä»»åŠ¡</p></li><li><p><code>Cronjob</code>ï¼šå‘¨æœŸæ€§çš„æ‰§è¡Œä»»åŠ¡</p></li><li><p><code>ReplicationController</code> ç¡®ä¿åœ¨ä»»ä½•æ—¶å€™éƒ½æœ‰ç‰¹å®šæ•°é‡çš„ Pod å‰¯æœ¬å¤„äºè¿è¡ŒçŠ¶æ€ã€‚  ç°åœ¨æ¨èä½¿ç”¨é…ç½® ReplicaSet çš„ Deployment æ¥å»ºç«‹å‰¯æœ¬ç®¡ç†æœºåˆ¶ã€‚</p></li></ul><h3 id="2ã€k8sçš„æ§åˆ¶å™¨å›¾ç¤º"><a href="#2ã€k8sçš„æ§åˆ¶å™¨å›¾ç¤º" class="headerlink" title="2ã€k8sçš„æ§åˆ¶å™¨å›¾ç¤º"></a>2ã€k8sçš„æ§åˆ¶å™¨å›¾ç¤º</h3><p><img src="https://res.yongwang.lu/img/202303221916960.png" alt="K8sæ§åˆ¶å™¨"></p>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰3ã€Podè¯¦è§£</title>
    <link href="https://blog.yongwang.lu/post/3664a83f.html"/>
    <id>https://blog.yongwang.lu/post/3664a83f.html</id>
    <published>2023-01-05T04:40:00.000Z</published>
    <updated>2023-01-05T04:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/">https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/pod-lifecycle/</a></p><h2 id="ä¸€ã€ç®€ä»‹"><a href="#ä¸€ã€ç®€ä»‹" class="headerlink" title="ä¸€ã€ç®€ä»‹"></a>ä¸€ã€ç®€ä»‹</h2><blockquote><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼ŒPodæ˜¯æ‰€æœ‰ä¸šåŠ¡ç±»å‹çš„åŸºç¡€ï¼Œä¹Ÿæ˜¯K8Sç®¡ç†çš„<strong>æœ€å°å•ä½çº§</strong>ï¼Œå®ƒæ˜¯<strong>ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„ç»„åˆ</strong>ã€‚è¿™äº›å®¹å™¨<strong>å…±äº«å­˜å‚¨ã€ç½‘ç»œå’Œå‘½åç©ºé—´</strong>ï¼Œä»¥åŠå¦‚ä½•è¿è¡Œçš„è§„èŒƒã€‚åœ¨Podä¸­ï¼Œæ‰€æœ‰å®¹å™¨éƒ½è¢«ç»Ÿä¸€å®‰æ’å’Œè°ƒåº¦ï¼Œå¹¶è¿è¡Œåœ¨å…±äº«çš„ä¸Šä¸‹æ–‡ä¸­ã€‚å¯¹äºå…·ä½“åº”ç”¨è€Œè¨€ï¼ŒPodæ˜¯å®ƒä»¬çš„é€»è¾‘ä¸»æœºï¼ŒPodåŒ…å«ä¸šåŠ¡ç›¸å…³çš„å¤šä¸ªåº”ç”¨å®¹å™¨ã€‚</p></blockquote><h2 id="äºŒã€Podå®ç°æœºåˆ¶ä¸è®¾è®¡æ¨¡å¼"><a href="#äºŒã€Podå®ç°æœºåˆ¶ä¸è®¾è®¡æ¨¡å¼" class="headerlink" title="äºŒã€Podå®ç°æœºåˆ¶ä¸è®¾è®¡æ¨¡å¼"></a>äºŒã€Podå®ç°æœºåˆ¶ä¸è®¾è®¡æ¨¡å¼</h2><blockquote><p>æ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªç‰¹æ®Šçš„è¢«ç§°ä¸ºâ€æ ¹å®¹å™¨â€çš„Pause å®¹å™¨ï¼ˆPauseå®¹å™¨ï¼Œåˆå«Infrastructureå®¹å™¨ï¼‰ã€‚ Pauseå®¹å™¨å¯¹åº”çš„é•œåƒå±äºKuberneteså¹³å°çš„ä¸€éƒ¨åˆ†ï¼Œé™¤äº†Pauseå®¹å™¨ï¼Œæ¯ä¸ªPodè¿˜åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªç´§å¯†ç›¸å…³çš„ç”¨æˆ·ä¸šåŠ¡å®¹å™¨ã€‚</p></blockquote><p><img src="https://res.yongwang.lu/img/202303221607453.png" alt="podç»„æˆ"></p><blockquote><p>ä¼—æ‰€å‘¨çŸ¥ï¼Œå®¹å™¨ä¹‹é—´æ˜¯é€šè¿‡Namespaceéš”ç¦»çš„ï¼ŒPodè¦æƒ³è§£å†³ä¸Šè¿°åº”ç”¨åœºæ™¯ï¼Œé‚£ä¹ˆå°±è¦è®©Podé‡Œçš„å®¹å™¨ä¹‹é—´é«˜æ•ˆå…±äº«ã€‚<br>å…·ä½“åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>ç½‘ç»œå’Œå­˜å‚¨</strong></p></blockquote><ul><li>å…±äº«ç½‘ç»œ</li></ul><blockquote><p>kubernetesçš„è§£æ³•æ˜¯è¿™æ ·çš„ï¼šä¼šåœ¨æ¯ä¸ªPodé‡Œå…ˆå¯åŠ¨ä¸€ä¸ªinfra containerå°å®¹å™¨ï¼Œç„¶åè®©å…¶ä»–çš„å®¹å™¨è¿æ¥è¿›æ¥è¿™ä¸ªç½‘ç»œå‘½åç©ºé—´ï¼Œç„¶åå…¶ä»–å®¹å™¨çœ‹åˆ°çš„ç½‘ç»œè¯•å›¾å°±å®Œå…¨ä¸€æ ·äº†ï¼Œå³ç½‘ç»œè®¾å¤‡ã€IPåœ°å€ã€Macåœ°å€ç­‰ï¼Œè¿™å°±æ˜¯è§£å†³ç½‘ç»œå…±äº«é—®é¢˜ã€‚åœ¨Podçš„IPåœ°å€å°±æ˜¯infra containerçš„IPåœ°å€ã€‚</p></blockquote><ul><li>å…±äº«å­˜å‚¨</li></ul><blockquote><p>æ¯”å¦‚æœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œä¸€ä¸ªæ˜¯nginxï¼Œå¦ä¸€ä¸ªæ˜¯æ™®é€šçš„å®¹å™¨ï¼Œæ™®é€šå®¹å™¨è¦æƒ³è®¿é—®nginxé‡Œçš„æ–‡ä»¶ï¼Œå°±éœ€è¦nginxå®¹å™¨å°†å…±äº«ç›®å½•é€šè¿‡volumeæŒ‚è½½å‡ºæ¥ï¼Œç„¶åè®©æ™®é€šå®¹å™¨æŒ‚è½½çš„è¿™ä¸ªvolumeï¼Œæœ€åå¤§å®¶çœ‹åˆ°è¿™ä¸ªå…±äº«ç›®å½•çš„å†…å®¹ä¸€æ ·ã€‚</p></blockquote><p>ä¾‹å¦‚ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># pod-write-read.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span>  </span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-podspec</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">write</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;for i in &#123;1..100&#125;;do echo $i &gt;&gt; /data/hello;sleep 1;done&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line"> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">read</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">centos</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;bash&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail -f /data/hello&quot;</span>]</span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">   </span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹ä¸­æœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œwriteå®¹å™¨è´Ÿè´£æä¾›æ•°æ®ï¼Œreadæ¶ˆè´¹æ•°æ®ï¼Œé€šè¿‡æ•°æ®å·å°†å†™å…¥æ•°æ®çš„ç›®å½•å’Œè¯»å–æ•°æ®çš„ç›®å½•éƒ½æ”¾åˆ°äº†è¯¥å·ä¸­ï¼Œè¿™æ ·æ¯ä¸ªå®¹å™¨éƒ½èƒ½çœ‹åˆ°è¯¥ç›®å½•ã€‚<br>éªŒè¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f pod-write-read.yaml</span><br><span class="line">$ kubectl logs my-pod -c <span class="built_in">read</span> -f</span><br></pre></td></tr></table></figure><p>åœ¨Podä¸­å®¹å™¨åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªç±»å‹ï¼š</p><ul><li><p>Infrastructure Containerï¼šåŸºç¡€å®¹å™¨ï¼Œç»´æŠ¤æ•´ä¸ªPodç½‘ç»œç©ºé—´ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§</p></li><li><p>InitContainersï¼šåˆå§‹åŒ–å®¹å™¨ï¼Œå…ˆäºä¸šåŠ¡å®¹å™¨å¼€å§‹æ‰§è¡Œï¼Œä¸€èˆ¬ç”¨äºä¸šåŠ¡å®¹å™¨çš„åˆå§‹åŒ–å·¥ä½œ</p></li><li><p>Containersï¼šä¸šåŠ¡å®¹å™¨ï¼Œå…·ä½“è·‘åº”ç”¨ç¨‹åºçš„é•œåƒ</p></li></ul><h2 id="ä¸‰ã€é•œåƒæ‹‰å–ç­–ç•¥"><a href="#ä¸‰ã€é•œåƒæ‹‰å–ç­–ç•¥" class="headerlink" title="ä¸‰ã€é•œåƒæ‹‰å–ç­–ç•¥"></a>ä¸‰ã€é•œåƒæ‹‰å–ç­–ç•¥</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod001</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox001</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure><p>imagePullPolicy å­—æ®µæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š</p><ul><li><p>IfNotPresentï¼šé•œåƒåœ¨å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æ—¶æ‰æ‹‰å–</p></li><li><p>Alwaysï¼š<strong>é»˜è®¤å€¼</strong>,æ¯æ¬¡åˆ›å»º Pod éƒ½ä¼šé‡æ–°æ‹‰å–ä¸€æ¬¡é•œåƒ</p></li><li><p>Neverï¼š Pod æ°¸è¿œä¸ä¼šä¸»åŠ¨æ‹‰å–è¿™ä¸ªé•œåƒ</p></li></ul><blockquote><p>æ³¨æ„ï¼Œè¿™é‡Œçš„é‡å¯æ˜¯æŒ‡åœ¨Podæ‰€åœ¨Nodeä¸Šé¢æœ¬åœ°é‡å¯ï¼Œå¹¶ä¸ä¼šè°ƒåº¦åˆ°å…¶ä»–Nodeä¸Šå»ã€‚</p></blockquote><h2 id="å››ã€èµ„æºé™åˆ¶"><a href="#å››ã€èµ„æºé™åˆ¶" class="headerlink" title="å››ã€èµ„æºé™åˆ¶"></a>å››ã€èµ„æºé™åˆ¶</h2><p>Podèµ„æºé…é¢æœ‰ä¸¤ç§ï¼š</p><p>ç”³è¯·é…é¢ï¼šè°ƒåº¦æ—¶ä½¿ç”¨ï¼Œå‚è€ƒæ˜¯å¦æœ‰èŠ‚ç‚¹æ»¡è¶³è¯¥é…ç½®</p><ul><li><p>spec.containers[].resources.limits.cpu</p></li><li><p>spec.containers[].resources.limits.memory</p></li></ul><p>é™åˆ¶é…é¢ï¼šå®¹å™¨èƒ½ä½¿ç”¨çš„æœ€å¤§é…ç½®</p><ul><li><p>spec.containers[].resources.requests.cpu</p></li><li><p>spec.containers[].resources.requests.memory</p></li></ul><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod002</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox002</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;64Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">&quot;128Mi&quot;</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;500m&quot;</span></span><br></pre></td></tr></table></figure><p>å…¶ä¸­cpuå€¼æ¯”è¾ƒæŠ½è±¡ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£ï¼š</p><blockquote><p>1æ ¸&#x3D;1000m</p><p>1.5æ ¸&#x3D;1500m</p></blockquote><p>é‚£ä¸Šé¢é™åˆ¶é…ç½®å°±æ˜¯1æ ¸çš„äºŒåˆ†ä¹‹ä¸€ï¼ˆ500mï¼‰ï¼Œå³è¯¥å®¹å™¨æœ€å¤§ä½¿ç”¨åŠæ ¸CPUã€‚</p><p>è¯¥å€¼ä¹Ÿå¯ä»¥å†™æˆæµ®ç‚¹æ•°ï¼Œæ›´å®¹æ˜“ç†è§£ï¼š</p><blockquote><p>åŠæ ¸&#x3D;0.5</p><p>1æ ¸&#x3D;1</p><p>1.5æ ¸&#x3D;1.5</p></blockquote><h2 id="äº”ã€é‡å¯ç­–ç•¥"><a href="#äº”ã€é‡å¯ç­–ç•¥" class="headerlink" title="äº”ã€é‡å¯ç­–ç•¥"></a>äº”ã€é‡å¯ç­–ç•¥</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">pod003</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox003</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br></pre></td></tr></table></figure><p>restartPolicyå­—æ®µæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š</p><ul><li><p>Alwaysï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºåï¼Œæ€»æ˜¯é‡å¯å®¹å™¨ï¼Œ<strong>é»˜è®¤ç­–ç•¥</strong>ã€‚</p></li><li><p>OnFailureï¼šå½“å®¹å™¨å¼‚å¸¸é€€å‡ºï¼ˆé€€å‡ºçŠ¶æ€ç é0ï¼‰æ—¶ï¼Œæ‰é‡å¯å®¹å™¨ã€‚é€‚äºjob</p></li><li><p>Neverï¼šå½“å®¹å™¨ç»ˆæ­¢é€€å‡ºï¼Œä»ä¸é‡å¯å®¹å™¨ã€‚é€‚äºjob</p></li></ul><h2 id="å…­ã€-å¥åº·æ£€æŸ¥"><a href="#å…­ã€-å¥åº·æ£€æŸ¥" class="headerlink" title="å…­ã€ å¥åº·æ£€æŸ¥"></a>å…­ã€ å¥åº·æ£€æŸ¥</h2><blockquote><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œkubelet æ ¹æ®å®¹å™¨çŠ¶æ€ä½œä¸ºå¥åº·ä¾æ®ï¼Œä½†ä¸èƒ½å®¹å™¨ä¸­åº”ç”¨ç¨‹åºçŠ¶æ€ï¼Œä¾‹å¦‚ç¨‹åºå‡æ­»ã€‚è¿™å°±ä¼šå¯¼è‡´æ— æ³•æä¾›æœåŠ¡ï¼Œä¸¢å¤±æµé‡ã€‚å› æ­¤å¼•å…¥å¥åº·æ£€æŸ¥æœºåˆ¶ç¡®ä¿å®¹å™¨å¥åº·å­˜æ´»ã€‚</p></blockquote><p>å¥åº·æ£€æŸ¥æœ‰ä¸¤ç§ç±»å‹ï¼š</p><ul><li>livenessProbe</li></ul><blockquote><p>å¦‚æœæ£€æŸ¥å¤±è´¥ï¼Œå°†æ€æ­»å®¹å™¨ï¼Œæ ¹æ®Podçš„restartPolicyæ¥æ“ä½œã€‚</p></blockquote><ul><li>readinessProbe</li></ul><blockquote><p>å¦‚æœæ£€æŸ¥å¤±è´¥ï¼ŒKubernetesä¼šæŠŠPodä»service endpointsä¸­å‰”é™¤ã€‚</p></blockquote><p>è¿™ä¸¤ç§ç±»å‹æ”¯æŒä¸‰ç§æ£€æŸ¥æ–¹æ³•ï¼š</p><ul><li>httpGet</li></ul><blockquote><p>å‘é€HTTPè¯·æ±‚ï¼Œè¿”å›200-400èŒƒå›´çŠ¶æ€ç ä¸ºæˆåŠŸã€‚</p></blockquote><ul><li>exec</li></ul><blockquote><p>æ‰§è¡ŒShellå‘½ä»¤è¿”å›çŠ¶æ€ç æ˜¯0ä¸ºæˆåŠŸã€‚</p></blockquote><ul><li>tcpSocket</li></ul><blockquote><p>å‘èµ·TCP Socketå»ºç«‹æˆåŠŸã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># health-check.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-exec</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">60</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ç¤ºä¾‹ï¼šå¯åŠ¨å®¹å™¨ç¬¬ä¸€ä»¶äº‹åœ¨å®¹å™¨å†…åˆ›å»ºæ–‡ä»¶ï¼Œåœæ­¢30sï¼Œåˆ é™¤è¯¥æ–‡ä»¶ï¼Œå†åœæ­¢60sï¼Œç¡®ä¿å®¹å™¨è¿˜åœ¨è¿è¡Œä¸­ã€‚</p><p>éªŒè¯ç°è±¡ï¼šå®¹å™¨å¯åŠ¨æ­£å¸¸ï¼Œ30såå¼‚å¸¸ï¼Œä¼šrestartPolicyç­–ç•¥è‡ªåŠ¨é‡å»ºï¼Œå®¹å™¨ç»§ç»­æ­£å¸¸ï¼Œåå¤ç°è±¡ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f health-check.yaml</span><br><span class="line">$ kubectl describe pod liveness-exec</span><br></pre></td></tr></table></figure><h2 id="ä¸ƒã€è°ƒåº¦ç­–ç•¥"><a href="#ä¸ƒã€è°ƒåº¦ç­–ç•¥" class="headerlink" title="ä¸ƒã€è°ƒåº¦ç­–ç•¥"></a>ä¸ƒã€è°ƒåº¦ç­–ç•¥</h2><blockquote><p>å…ˆçœ‹ä¸‹åˆ›å»ºä¸€ä¸ªPodçš„å·¥ä½œæµç¨‹ï¼š create pod -&gt; apiserver -&gt; write etcd -&gt; scheduler -&gt; bind pod to node -&gt; write etcd -&gt; kubelet( apiserver get pod) -&gt; dcoekr api,create container -&gt; apiserver -&gt; update pod status to etcd -&gt; kubectl get pods</p></blockquote><p><img src="https://res.yongwang.lu/img/202303221620812.png" alt="å›¾ç‰‡"></p><p>Podæ ¹æ®è°ƒåº¦å™¨é»˜è®¤ç®—æ³•å°†Podåˆ†é…åˆ°åˆé€‚çš„èŠ‚ç‚¹ä¸Šï¼Œä¸€èˆ¬æ˜¯æ¯”è¾ƒç©ºé—²çš„èŠ‚ç‚¹ã€‚ä½†æœ‰äº›æƒ…å†µæˆ‘ä»¬å¸Œæœ›å°†Podåˆ†é…åˆ°æŒ‡å®šèŠ‚ç‚¹ï¼Œè¯¥æ€ä¹ˆåšå‘¢ï¼Ÿ</p><blockquote><p>è¿™é‡Œç»™ä½ ä»‹ç»è°ƒåº¦ç­–ç•¥ï¼š<strong>nodeNameã€nodeSelectorå’Œæ±¡ç‚¹</strong></p></blockquote><h3 id="1ï¼‰nodeName"><a href="#1ï¼‰nodeName" class="headerlink" title="1ï¼‰nodeName"></a>1ï¼‰nodeName</h3><p>nodeNameç”¨äºå°†Podè°ƒåº¦åˆ°æŒ‡å®šçš„Nodeåç§°ä¸Šã€‚<br>ä¾‹å¦‚ï¼šä¸‹é¢ç¤ºä¾‹ä¼šç»•è¿‡è°ƒåº¦ç³»ç»Ÿï¼Œç›´æ¥åˆ†é…åˆ°k8s-node1èŠ‚ç‚¹ã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SchedulePolicy-nodeName.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busyboxnn</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeName:</span> <span class="string">k8s-node1</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">bs</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ping&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;baidu.com&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ&amp;æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f SchedulePolicy-nodeName.yaml</span><br><span class="line">$ kubectl get pod busyboxnn -o wide</span><br></pre></td></tr></table></figure><h3 id="2ï¼‰nodeSelector"><a href="#2ï¼‰nodeSelector" class="headerlink" title="2ï¼‰nodeSelector"></a>2ï¼‰nodeSelector</h3><blockquote><p>nodeSelectorç”¨äºå°†Podè°ƒåº¦åˆ°åŒ¹é…Labelçš„Nodeä¸Šã€‚å…ˆç»™è§„åˆ’nodeç”¨é€”ï¼Œç„¶åæ‰“æ ‡ç­¾ï¼Œä¾‹å¦‚å°†ä¸¤å°nodeåˆ’åˆ†ç»™ä¸åŒå›¢é˜Ÿä½¿ç”¨ï¼š</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl label nodes k8s-node1 team=a</span><br><span class="line">$ kubectl label nodes k8s-node2 team=b</span><br></pre></td></tr></table></figure><p>ååœ¨åˆ›å»ºPodåªä¼šè¢«è°ƒåº¦åˆ°å«æœ‰team&#x3D;aæ ‡ç­¾çš„èŠ‚ç‚¹ä¸Šã€‚</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SchedulePolicy-nodeSelector.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busyboxsn</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">team:</span> <span class="string">b</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">bs</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ping&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;baidu.com&quot;</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ&amp;æŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl apply -f SchedulePolicy-nodeSelector.yaml</span><br><span class="line">$ kubectl get pod busyboxsn -o wide</span><br></pre></td></tr></table></figure><h3 id="3ï¼‰taintï¼ˆæ±¡ç‚¹ï¼‰ä¸tolerationsï¼ˆå®¹å¿ï¼‰"><a href="#3ï¼‰taintï¼ˆæ±¡ç‚¹ï¼‰ä¸tolerationsï¼ˆå®¹å¿ï¼‰" class="headerlink" title="3ï¼‰taintï¼ˆæ±¡ç‚¹ï¼‰ä¸tolerationsï¼ˆå®¹å¿ï¼‰"></a>3ï¼‰taintï¼ˆæ±¡ç‚¹ï¼‰ä¸tolerationsï¼ˆå®¹å¿ï¼‰</h3><ul><li>æ±¡ç‚¹åº”ç”¨åœºæ™¯ï¼šèŠ‚ç‚¹ç‹¬å ï¼Œä¾‹å¦‚å…·æœ‰ç‰¹æ®Šç¡¬ä»¶è®¾å¤‡çš„èŠ‚ç‚¹ï¼Œå¦‚GPU<br>è®¾ç½®æ±¡ç‚¹å‘½ä»¤ï¼š<br>kubectl taint node [node] key&#x3D;value[effect]</li></ul><p>å…¶ä¸­[effect] å¯å–å€¼ï¼š</p><ul><li><p>NoSchedule ï¼šä¸€å®šä¸èƒ½è¢«è°ƒåº¦ã€‚</p></li><li><p>PreferNoScheduleï¼šå°½é‡ä¸è¦è°ƒåº¦ã€‚</p></li><li><p>NoExecuteï¼šä¸ä»…ä¸ä¼šè°ƒåº¦ï¼Œè¿˜ä¼šé©±é€Nodeä¸Šå·²æœ‰çš„Podã€‚</p></li></ul><p>ç¤ºä¾‹ï¼š</p><p>å…ˆç»™èŠ‚ç‚¹è®¾ç½®æ±¡ç‚¹ï¼Œè¯´æ˜è¿™ä¸ªèŠ‚ç‚¹ä¸æ˜¯è°éƒ½å¯ä»¥è°ƒåº¦è¿‡æ¥çš„ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node k8s-node1  abc=123:NoSchedule</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ±¡ç‚¹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe node k8s-node1 |grep Taints</span><br></pre></td></tr></table></figure><blockquote><p>ç„¶ååœ¨åˆ›å»ºPod<strong>åªæœ‰å£°æ˜äº†å®¹å¿æ±¡ç‚¹ï¼ˆtolerationsï¼‰ï¼Œæ‰å…è®¸è¢«è°ƒåº¦åˆ°abc&#x3D;123æ±¡ç‚¹èŠ‚ç‚¹ä¸Š</strong>ã€‚</p></blockquote><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SchedulePolicy-tolerations.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">run:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox3</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;abc&quot;</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">    <span class="attr">value:</span> <span class="string">&quot;123&quot;</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">bs</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;ping&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;baidu.com&quot;</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸é…ç½®å®¹å¿æ±¡ç‚¹ï¼Œåˆ™æ°¸è¿œä¸ä¼šè°ƒåº¦åˆ°k8s-node1ã€‚ï¼ˆä¹Ÿå¯ä»¥å«åš<strong>åäº²å’Œæ€§</strong>ï¼‰<br>å»æ‰æ±¡ç‚¹ï¼š</p><blockquote><p>kubectl taint node k8s-node1 abc&#x3D;123:NoSchedule</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl taint node k8s-node1 abc:NoSchedule-</span><br></pre></td></tr></table></figure><p>masterèŠ‚ç‚¹é»˜è®¤æ˜¯æ‰“äº†æ±¡ç‚¹æ ‡è®°ï¼Œä¸è°ƒåº¦çš„ï¼Œå»æ‰æ±¡ç‚¹æ ‡è®°</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#æ·»åŠ  å°½é‡ä¸è°ƒåº¦ PreferNoSchedule </span></span><br><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master:PreferNoSchedule</span><br><span class="line"><span class="comment">#å»é™¤æ±¡ç‚¹NoScheduleï¼Œæœ€åä¸€ä¸ª&quot;-&quot;ä»£è¡¨åˆ é™¤</span></span><br><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure><h2 id="å…«ã€PodçŠ¶æ€"><a href="#å…«ã€PodçŠ¶æ€" class="headerlink" title="å…«ã€PodçŠ¶æ€"></a>å…«ã€PodçŠ¶æ€</h2><h3 id="1ï¼‰Podå¸¸è§çŠ¶æ€"><a href="#1ï¼‰Podå¸¸è§çŠ¶æ€" class="headerlink" title="1ï¼‰Podå¸¸è§çŠ¶æ€"></a>1ï¼‰Podå¸¸è§çŠ¶æ€</h3><p>1ã€Pendingï¼šç­‰å¾…ä¸­</p><blockquote><p>Podå·²ç»è¢«åˆ›å»ºï¼Œä½†è¿˜æ²¡æœ‰å®Œæˆè°ƒåº¦ï¼Œæˆ–è€…è¯´æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªé•œåƒæ­£å¤„äºä»è¿œç¨‹ä»“åº“ä¸‹è½½çš„è¿‡ç¨‹ã€‚å¤„åœ¨è¿™ä¸ªé˜¶æ®µçš„Podå¯èƒ½æ­£åœ¨å†™æ•°æ®åˆ°etcdä¸­ã€è°ƒåº¦ã€pullé•œåƒæˆ–å¯åŠ¨å®¹å™¨ã€‚</p></blockquote><p>2ã€Runningï¼šè¿è¡Œä¸­</p><blockquote><p>è¯¥ Pod å·²ç»ç»‘å®šåˆ°äº†ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ŒPod ä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å·²è¢«åˆ›å»ºã€‚è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ­£åœ¨è¿è¡Œï¼Œæˆ–è€…æ­£å¤„äºå¯åŠ¨æˆ–é‡å¯çŠ¶æ€ã€‚</p></blockquote><p>3ã€Succeededï¼šæ­£å¸¸ç»ˆæ­¢</p><blockquote><p>Podä¸­çš„æ‰€æœ‰çš„å®¹å™¨å·²ç»æ­£å¸¸çš„æ‰§è¡Œåé€€å‡ºï¼Œå¹¶ä¸”ä¸ä¼šè‡ªåŠ¨é‡å¯ï¼Œä¸€èˆ¬ä¼šæ˜¯åœ¨éƒ¨ç½²jobçš„æ—¶å€™ä¼šå‡ºç°ã€‚</p></blockquote><p>4ã€Failedï¼šå¼‚å¸¸åœæ­¢</p><blockquote><p>Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢äº†ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨æ˜¯å› ä¸ºå¤±è´¥ç»ˆæ­¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹å™¨ä»¥é0çŠ¶æ€é€€å‡ºæˆ–è€…è¢«ç³»ç»Ÿç»ˆæ­¢ã€‚</p></blockquote><p>5ã€Terminating æˆ– Unknown çŠ¶æ€</p><blockquote><p>ä» v1.5 å¼€å§‹ï¼ŒKubernetes ä¸ä¼šå› ä¸º Node å¤±è”è€Œåˆ é™¤å…¶ä¸Šæ­£åœ¨è¿è¡Œçš„ Podï¼Œè€Œæ˜¯å°†å…¶æ ‡è®°ä¸º Terminating æˆ– Unknown çŠ¶æ€ã€‚</p></blockquote><p>6ã€Error çŠ¶æ€</p><blockquote><p>é€šå¸¸å¤„äº Error çŠ¶æ€è¯´æ˜ Pod å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿäº†é”™è¯¯ã€‚å¸¸è§çš„åŸå› åŒ…æ‹¬ï¼š</p></blockquote><ul><li><p>ä¾èµ–çš„ ConfigMapã€Secret æˆ–è€… PV ç­‰ä¸å­˜åœ¨</p></li><li><p>è¯·æ±‚çš„èµ„æºè¶…è¿‡äº†ç®¡ç†å‘˜è®¾ç½®çš„é™åˆ¶ï¼Œæ¯”å¦‚è¶…è¿‡äº† LimitRange ç­‰</p></li><li><p>è¿åé›†ç¾¤çš„å®‰å…¨ç­–ç•¥ï¼Œæ¯”å¦‚è¿åäº† PodSecurityPolicy ç­‰</p></li><li><p>å®¹å™¨æ— æƒæ“ä½œé›†ç¾¤å†…çš„èµ„æºï¼Œæ¯”å¦‚å¼€å¯ RBAC åï¼Œéœ€è¦ä¸º ServiceAccount é…ç½®è§’è‰²ç»‘å®šã€‚</p></li></ul><p>7ã€CompletedçŠ¶æ€</p><blockquote><p>çŠ¶æ€ç”±ContainerCreatingå˜ä¸ºCompletedå†å˜ä¸ºCrashLoopBackOffï¼ŒåŸå› æ˜¯command: æˆ–args å‚æ•°é”™è¯¯æ— æ³•æ­£å¸¸æ‰§è¡Œã€‚</p></blockquote><p>ç”¨ä¸€å¼ å›¾æ¥è¡¨ç¤ºPodçš„å„ä¸ªçŠ¶æ€</p><p><img src="https://res.yongwang.lu/img/202303221614525.png" alt="å›¾ç‰‡"></p><h3 id="2ï¼‰Pod-å…¶å®ƒçŠ¶æ€è¯¦ç»†è¯´æ˜"><a href="#2ï¼‰Pod-å…¶å®ƒçŠ¶æ€è¯¦ç»†è¯´æ˜" class="headerlink" title="2ï¼‰Pod å…¶å®ƒçŠ¶æ€è¯¦ç»†è¯´æ˜"></a>2ï¼‰Pod å…¶å®ƒçŠ¶æ€è¯¦ç»†è¯´æ˜</h3><table><thead><tr><th>çŠ¶æ€</th><th>æè¿°</th></tr></thead><tbody><tr><td>ContainerCreating</td><td>å®¹å™¨åˆ›å»ºä¸­</td></tr><tr><td>PodInitializing pod</td><td>åˆå§‹åŒ–ä¸­</td></tr><tr><td>CrashLoopBackOff</td><td>å®¹å™¨æ›¾ç»å¯åŠ¨äº†ï¼Œä½†å¯èƒ½åˆå¼‚å¸¸é€€å‡ºäº†ï¼Œkubeletæ­£åœ¨å°†å®ƒé‡å¯</td></tr><tr><td>InvalidImageName</td><td>æ— æ³•è§£æé•œåƒåç§°</td></tr><tr><td>ImageInspectError</td><td>æ— æ³•æ ¡éªŒé•œåƒ</td></tr><tr><td>ErrImageNeverPull</td><td>ç­–ç•¥ç¦æ­¢æ‹‰å–é•œåƒ</td></tr><tr><td>ImagePullBackOff</td><td>æ­£åœ¨é‡è¯•æ‹‰å–</td></tr><tr><td>RegistryUnavailable</td><td>è¿æ¥ä¸åˆ°é•œåƒä¸­å¿ƒ</td></tr><tr><td>ErrImagePull</td><td>é€šç”¨çš„æ‹‰å–é•œåƒå‡ºé”™</td></tr><tr><td>CreateContainerConfigError</td><td>ä¸èƒ½åˆ›å»ºkubeletä½¿ç”¨çš„å®¹å™¨é…ç½®</td></tr><tr><td>CreateContainerError</td><td>åˆ›å»ºå®¹å™¨å¤±è´¥</td></tr><tr><td>m.internalLifecycle.PreStartContainer</td><td>æ‰§è¡ŒhookæŠ¥é”™</td></tr><tr><td>RunContainerError</td><td>å¯åŠ¨å®¹å™¨å¤±è´¥</td></tr><tr><td>PostStartHookError</td><td>æ‰§è¡ŒhookæŠ¥é”™</td></tr><tr><td>ContainersNotInitialized</td><td>å®¹å™¨æ²¡æœ‰åˆå§‹åŒ–å®Œæ¯•</td></tr><tr><td>ContainersNotRead</td><td>å®¹å™¨æ²¡æœ‰å‡†å¤‡å®Œæ¯•</td></tr><tr><td>DockerDaemonNotReady</td><td>dockerè¿˜æ²¡æœ‰å®Œå…¨å¯åŠ¨</td></tr><tr><td>NetworkPluginNotReady</td><td>ç½‘ç»œæ’ä»¶è¿˜æ²¡æœ‰å®Œå…¨å¯åŠ¨</td></tr></tbody></table><p>podå¯åŠ¨ååœæ­¢é—®é¢˜æ€»ç»“ï¼ˆContainerCreating-ã€‹Completed-ã€‹CrashLoopBackOffï¼‰ï¼š</p><blockquote><p>pod æ˜¯å¦èƒ½æŒç»­è¿è¡Œï¼Œæ˜¯ç”±æ‰§è¡Œå‘½ä»¤å†³å®šçš„ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚æœä¸€æ‰§è¡Œå°±åœæ­¢ï¼Œæ§åˆ¶å°ä¹Ÿåœæ­¢æŒç»­è¾“å‡ºï¼Œpodç”Ÿå‘½å‘¨æœŸå°±ç»“æŸï¼ŒpodçŠ¶æ€å°±ä¼šå˜æˆCrashLoopBackOffã€‚</p></blockquote>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰2ã€é›†ç¾¤æ­å»º(containerd)</title>
    <link href="https://blog.yongwang.lu/post/9866a7eb.html"/>
    <id>https://blog.yongwang.lu/post/9866a7eb.html</id>
    <published>2023-01-05T03:40:00.000Z</published>
    <updated>2023-01-05T03:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h1><p>å‚è€ƒï¼š <a href="https://kubernetes.io/zh/docs/" title="Kubernetes æ–‡æ¡£">Kubernetes æ–‡æ¡£</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/" title="å…¥é—¨">å…¥é—¨</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/" title="ç”Ÿäº§ç¯å¢ƒ">ç”Ÿäº§ç¯å¢ƒ</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/" title="ä½¿ç”¨éƒ¨ç½²å·¥å…·å®‰è£… Kubernetes">ä½¿ç”¨éƒ¨ç½²å·¥å…·å®‰è£… Kubernetes</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" title="ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤">ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" title="å®‰è£… kubeadm">å®‰è£… kubeadm</a></p><p>æµç¨‹å›¾</p><p><img src="https://res.yongwang.lu/img/image_rFtNPTs_40.png"></p><h2 id="å‡†å¤‡å¼€å§‹"><a href="#å‡†å¤‡å¼€å§‹" class="headerlink" title="å‡†å¤‡å¼€å§‹"></a>å‡†å¤‡å¼€å§‹</h2><ul><li>ä¸€å°å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®ä¸ºåŸºäº Debian å’Œ Red Hat çš„ Linux å‘è¡Œç‰ˆä»¥åŠä¸€äº›ä¸æä¾›åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›é€šç”¨çš„æŒ‡ä»¤</li><li>æ¯å°æœºå™¨ <code>2 GB</code> æˆ–æ›´å¤šçš„ RAM ï¼ˆå¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“ä½ åº”ç”¨çš„è¿è¡Œå†…å­˜)</li><li><code>2 CPU æ ¸</code>æˆ–æ›´å¤š</li><li>é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)</li><li>èŠ‚ç‚¹ä¹‹ä¸­<code>ä¸å¯ä»¥æœ‰é‡å¤çš„</code>ä¸»æœºåã€MAC åœ°å€æˆ– product_uuidã€‚è¯·å‚è§<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address" title="è¿™é‡Œ">è¿™é‡Œ</a>äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</li><li>å¼€å¯æœºå™¨ä¸Šçš„æŸäº›ç«¯å£ã€‚è¯·å‚è§<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports" title="è¿™é‡Œ">è¿™é‡Œ</a> äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</li><li>ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œä½  <strong>å¿…é¡»</strong> <code>ç¦ç”¨äº¤æ¢åˆ†åŒº</code>ã€‚</li></ul><h2 id="U-ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š-MAC-åœ°å€å’Œ-product-uuid-çš„å”¯ä¸€æ€§-amp-x20"><a href="#U-ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š-MAC-åœ°å€å’Œ-product-uuid-çš„å”¯ä¸€æ€§-amp-x20" class="headerlink" title="U. ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§&amp;#x20;"></a>U. ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§&amp;#x20;</h2><ul><li>ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>ip link</code> æˆ– <code>ifconfig -a</code> æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€</li><li>å¯ä»¥ä½¿ç”¨ <code>sudo cat /sys/class/dmi/id/product_uuid</code> å‘½ä»¤å¯¹ product_uuid æ ¡éªŒ</li></ul><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><strong>[k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li>è®¾ç½®å½“å‰ç”¨æˆ·sudoå…å¯†[é€‰åš]<blockquote><p>ä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥å¯†ç  - åŠ é€Ÿ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼“å­˜ sudo å¯†ç </span></span><br><span class="line"><span class="built_in">echo</span> ubuntu | sudo -v -S </span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/sudoers.d/<span class="variable">$USER</span> &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">$USER ALL=(ALL) NOPASSWD: ALL</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>ä½¿ç”¨å›½å†…é•œåƒä»“åº“[é€‰åš]<blockquote><p>è½¯ä»¶å®‰è£… - åŠ é€Ÿ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ¢é˜¿é‡Œäº‘åŠ é€Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list_bak</span><br><span class="line">vim /etc/apt/sources.list</span><br><span class="line"><span class="comment"># æŸ¥çœ‹/etc/apt/sources.listä¸­çš„URLæ˜¯archive.ubuntuè¿˜æ˜¯cn.archive.ubuntu </span></span><br><span class="line"><span class="comment"># ç„¶åå†æ‰§è¡Œï¼š</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;s/cn.archive.ubuntu.com/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line"><span class="comment"># æˆ– </span></span><br><span class="line">sudo sed -i <span class="string">&#x27;s/archive.ubuntu.com/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>ç¼–è¾‘ hosts&lt;å¿…åš&gt; <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> -a /etc/hosts &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.147.131 k8s-master</span></span><br><span class="line"><span class="string">192.168.147.132 k8s-worker1</span></span><br><span class="line"><span class="string">192.168.147.133 k8s-worker2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li><p>ç¦ç”¨ swap&lt;å¿…åš&gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># äº¤æ¢æ–‡ä»¶</span></span><br><span class="line">SWAPF=$(awk <span class="string">&#x27;/swap/ &#123;print $1&#125;&#x27;</span> /etc/fstab)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç¦ç”¨</span></span><br><span class="line">sudo swapoff <span class="variable">$SWAPF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°¸ä¹…ç¦ç”¨</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤äº¤æ¢æ–‡ä»¶</span></span><br><span class="line">sudo <span class="built_in">rm</span> <span class="variable">$SWAPF</span></span><br></pre></td></tr></table></figure></li><li><p>æ¨¡å—æ”¯æŒ&lt;å¿…åš&gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†…æ ¸æ”¯æŒ</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/sysctl.d/k8s.conf &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">sudo sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿è¡Œæ—¶&lt;å¿…åš&gt;&amp;#x20;</p><p>è¿™é‡Œä¸å†é‡‡ç”¨dockerä½œä¸ºk8sçš„è¿è¡Œæ—¶. å› ä¸ºK8sè‡ª1.24 å¯¹dockeræ”¯æŒæ”¹ä¸º å®‰è£…æŒ‡å®šCRIæ‰èƒ½è®¿é—®.&amp;#x20;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… containerd https://download.docker.com/linux/ubuntu/dists/jammy/pool/stable/amd64/</span></span><br><span class="line"><span class="comment"># ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ containerd å› ä¸ºåœ¨k8såç»­ç‰ˆæœ¬åºŸå¼ƒ1.5.x å®‰è£…å¯¹åº”çš„debç‰ˆæœ¬</span></span><br><span class="line">sudo apt install -y containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-mark hold containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /etc/containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶</span></span><br><span class="line">containerd config default | \</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/containerd/config.toml &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶ åŠ é€Ÿ</span></span><br><span class="line">sudo sed -i \</span><br><span class="line">-e <span class="string">&#x27;/sandbox_image/s?k8s.gcr.io?registry.aliyuncs.com/google_containers?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/SystemdCgroup/s?false?true?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\          endpoint = [&quot;https://docker.nju.edu.cn/&quot;]&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡é‡å¯</span></span><br><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œæ—¶é…ç½®ç§æœ</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://------.mirror.aliyuncs.com&quot;</span>, <span class="string">&quot;https://registry-1.docker.io&quot;</span>]</span><br><span class="line"><span class="comment"># è¿è¡Œæ—¶é…ç½®ç™»å½•</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">   [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">       [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://registry-1.docker.io&quot;</span>]</span><br><span class="line">       [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>.tls]</span><br><span class="line">          insecure_skip_verify = <span class="literal">true</span></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>.auth]</span><br><span class="line">          username = <span class="string">&quot;é˜¿é‡Œäº‘è´¦æˆ·ï¼Œç±»ä¼¼xxx@aliyun.com&quot;</span></span><br><span class="line">          password = <span class="string">&quot;ä¸Šä¸€æ­¥è®¾ç½®çš„å›ºå®šå¯†ç &quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…-K8s"><a href="#å®‰è£…-K8s" class="headerlink" title="å®‰è£… K8s"></a>å®‰è£… K8s</h2><p><strong>[kiosk@k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li>å®‰è£… kubeadmã€kubelet å’Œ kubectl<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° apt åŒ…ç´¢å¼•å¹¶å®‰è£…ä½¿ç”¨ Kubernetes apt ä»“åº“æ‰€éœ€è¦çš„åŒ…</span></span><br><span class="line">sudo apt -y install apt-transport-https ca-certificates curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Google Cloud å…¬å¼€ç­¾åç§˜é’¥</span></span><br><span class="line">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  Kubernetes apt ä»“åº“</span></span><br><span class="line">MIRROR_URL=https://mirrors.aliyun.com/kubernetes/apt/</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb $MIRROR_URL kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–° apt åŒ…ç´¢å¼•</span></span><br><span class="line">sudo <span class="built_in">cp</span> /etc/apt/trusted.gpg /etc/apt/trusted.gpg.d</span><br><span class="line">sudo apt update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison kubelet | grep 1.25</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… kubeletã€kubeadm å’Œ kubectl æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt install -y kubelet=1.25.1-00 kubeadm=1.25.1-00 kubectl=1.25.1-00</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å®ŒK8sä»¥åä¼šè‡ªå¸¦crictl</span></span><br><span class="line"><span class="comment"># crictl é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/crictl.yaml &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">pull-image-on-create: true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>k8s æ”¯æŒ<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ  k8s æ”¯æŒ</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/ExecStart=\//s|$| --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroup-driver=systemd|&#x27;</span> \</span><br><span class="line">  /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ kubelet æœåŠ¡</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-master]$</strong></p><ol><li>åˆå§‹åŒ–<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆåˆå§‹æ–‡ä»¶</span></span><br><span class="line">sudo kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ–‡ä»¶</span></span><br><span class="line">NICP=$(ip a | awk <span class="string">&#x27;/inet / &#123;print $2&#125;&#x27;</span> | grep -v ^127 | sed <span class="string">&#x27;s+/24++&#x27;</span>)</span><br><span class="line">sudo sed -i \</span><br><span class="line">  -e <span class="string">&quot;/advertiseAddress/s?:.*?: <span class="variable">$NICP</span>?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/name/s?:.*?: <span class="subst">$(hostname -s)</span>?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/clusterName/s?:.*?: k8s?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/imageRepository/s?:.*?: registry.aliyuncs.com/google_containers?&quot;</span> kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åˆå§‹æ–‡ä»¶ï¼Œåˆå§‹åŒ–é›†ç¾¤</span></span><br><span class="line">sudo kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure><blockquote><p>Your Kubernetes control-plane has initialized <code>successfully</code>!<br>PS: æ™®é€šç”¨æˆ·ç®¡ç†é›†ç¾¤</p><p>To start using your cluster, you need to run the following as a regular user:<br>bash<br>mkdir -p $HOME&#x2F;.kube<br>sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config<br>sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</p><p>PSï¼šroot ç”¨æˆ·ç®¡ç†é›†ç¾¤</p><p>Alternatively, if you are the root user, you can run:</p><p>bash<br>export KUBECONFIG&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</p><p>You should now deploy a pod network to the cluster.Run â€œ<code>kubectl apply -f [podnetwork].yaml</code>â€œ with one of the options listed at:<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" title="https://kubernetes.io/docs/concepts/cluster-administration/addons/">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a><br>Then you can join any number of worker nodes by running the following on each as root:<br>bash<br>kubeadm join 192.168.147.128:6443 â€“token abcdef.0123456789abcdef â€“discovery-token-ca-cert-hash sha256:c4781194de65ebb47984fc5e7e64d4897875410825ce4d18df81da1a298afa1f</p></blockquote></li><li>é…ç½®æ–‡ä»¶ - Client<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"></span><br><span class="line"><span class="comment"># user å¤åˆ¶é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo \<span class="built_in">cp</span> /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># root å˜é‡</span></span><br><span class="line">sudo <span class="built_in">tee</span> -a ~root/.bashrc &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">export KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>åˆ›å»ºç½‘ç»œ<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure></li><li>å‘½ä»¤è¡¥å…¨ - Client[å»ºè®®]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl completion --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/.kube 2&gt;/dev/null</span><br><span class="line">kubectl completion bash &gt; ~/.kube/completion.bash.inc</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string"># Kubectl shell completion</span></span><br><span class="line"><span class="string">source &#x27;<span class="variable">$HOME</span>/.kube/completion.bash.inc&#x27;</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; <span class="variable">$HOME</span>/.bashrc</span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.bashrc</span><br></pre></td></tr></table></figure></li><li>å‘½ä»¤åˆ«å - Client[å»ºè®®]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç½‘å€ https://kubernetes.io/zh-cn/docs/reference/kubectl/cheatsheet/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">tee</span> -a <span class="variable">$HOME</span>/.bashrc &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">alias k=&#x27;kubectl&#x27;</span></span><br><span class="line"><span class="string">complete -F __start_kubectl k</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.bashrc</span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-worker1|k8s-worker2]$</strong></p><ol><li>åŠ å…¥é›†ç¾¤<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo \</span><br><span class="line">  kubeadm <span class="built_in">join</span> 192.168.147.128:6443 \</span><br><span class="line">  --token abcdef.0123456789abcdef \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:c4781194de65ebb47984fc5e7e64d4897875410825ce4d18df81da1a298afa1f</span><br></pre></td></tr></table></figure></li></ol><h2 id="C-ç¡®è®¤ç¯å¢ƒæ­£å¸¸"><a href="#C-ç¡®è®¤ç¯å¢ƒæ­£å¸¸" class="headerlink" title="C. ç¡®è®¤ç¯å¢ƒæ­£å¸¸"></a>C. ç¡®è®¤ç¯å¢ƒæ­£å¸¸</h2><p><strong>[k8s-master]</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s-master   `Ready`     control-plane   9m17s   `v1.25.1`</span><br><span class="line">k8s-worker1  `Ready`     &lt;none&gt;          90s     `v1.25.1`</span><br><span class="line">k8s-worker2  `Ready`     &lt;none&gt;          51s     `v1.25.1`</span><br><span class="line"></span><br><span class="line">$ kubectl get componentstatuses</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">scheduler           `Healthy`  ok</span><br><span class="line">controller-manager  `Healthy`  ok</span><br><span class="line">etcd-0              `Healthy`  &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">$ kubectl -n kube-system get pod -w</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-798cc86c47-dkdjl   1/1     Running   0          4m5s</span><br><span class="line">calico-node-ftwk8                          1/1     Running   0          4m5s</span><br><span class="line">calico-node-hstcg                          1/1     Running   0          109s</span><br><span class="line">calico-node-lcnw6                          1/1     Running   0          2m28s</span><br><span class="line">coredns-c676cc86f-mxpb8                    1/1     Running   0          10m</span><br><span class="line">coredns-c676cc86f-vhzzh                    1/1     Running   0          10m</span><br><span class="line">etcd-k8s-master                            1/1     Running   0          10m</span><br><span class="line">kube-apiserver-k8s-master                  1/1     Running   0          10m</span><br><span class="line">kube-controller-manager-k8s-master         1/1     Running   0          10m</span><br><span class="line">kube-proxy-g2tz9                           1/1     Running   0          109s</span><br><span class="line">kube-proxy-j4fgc                           1/1     Running   0          10m</span><br><span class="line">kube-proxy-nz8vj                           1/1     Running   0          2m28s</span><br><span class="line">kube-scheduler-k8s-master                  1/1     Running   0          10m</span><br><span class="line">&lt;Ctrl-C&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Kubernetesï¼ˆk8sï¼‰1ã€åŸºæœ¬ä»‹ç»å’ŒåŠŸèƒ½æ¶æ„</title>
    <link href="https://blog.yongwang.lu/post/700b7316.html"/>
    <id>https://blog.yongwang.lu/post/700b7316.html</id>
    <published>2023-01-05T02:40:00.000Z</published>
    <updated>2023-01-05T02:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<p>å‚è€ƒï¼š <a href="https://kubernetes.io/zh/docs/" title="Kubernetes æ–‡æ¡£">Kubernetes æ–‡æ¡£</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/" title="å…¥é—¨">å…¥é—¨</a> &#x2F; <a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/" title="K8sæ¶æ„">K8sæ¶æ„</a></p><h2 id="1ã€kubernetes-æ¦‚è¿°"><a href="#1ã€kubernetes-æ¦‚è¿°" class="headerlink" title="1ã€kubernetes æ¦‚è¿°"></a>1ã€kubernetes æ¦‚è¿°</h2><p>kubernetesï¼Œç®€ç§° <a href="https://so.csdn.net/so/search?q=K8s&spm=1001.2101.3001.7020">K8s</a>ï¼Œæ˜¯ç”¨ 8 ä»£æ›¿ 8 ä¸ªå­—ç¬¦â€œuberneteâ€è€Œæˆçš„ç¼©å†™ã€‚æ˜¯ä¸€ä¸ªå¼€æº çš„ï¼Œç”¨äºç®¡ç†äº‘å¹³å°ä¸­å¤šä¸ªä¸»æœºä¸Šçš„å®¹å™¨åŒ–çš„åº”ç”¨ï¼ŒKubernetes çš„ç›®æ ‡æ˜¯è®©éƒ¨ç½²å®¹å™¨åŒ–çš„ åº”ç”¨ç®€å•å¹¶ä¸”é«˜æ•ˆ(powerful),Kubernetes æä¾›äº†åº”ç”¨éƒ¨ç½²ï¼Œè§„åˆ’ï¼Œæ›´æ–°ï¼Œç»´æŠ¤çš„ä¸€ç§ æœºåˆ¶ã€‚</p><p>ä¼ ç»Ÿçš„åº”ç”¨éƒ¨ç½²æ–¹å¼æ˜¯é€šè¿‡æ’ä»¶æˆ–è„šæœ¬æ¥å®‰è£…åº”ç”¨ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯åº”ç”¨çš„è¿è¡Œã€é… ç½®ã€ç®¡ç†ã€æ‰€æœ‰ç”Ÿå­˜å‘¨æœŸå°†ä¸å½“å‰æ“ä½œç³»ç»Ÿç»‘å®šï¼Œè¿™æ ·åšå¹¶ä¸åˆ©äºåº”ç”¨çš„å‡çº§æ›´æ–°&#x2F;å›æ»šç­‰ æ“ä½œï¼Œå½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡<a href="https://so.csdn.net/so/search?q=%E5%88%9B%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA&spm=1001.2101.3001.7020">åˆ›å»ºè™šæ‹Ÿæœº</a>çš„æ–¹å¼æ¥å®ç°æŸäº›åŠŸèƒ½ï¼Œä½†æ˜¯è™šæ‹Ÿæœºéå¸¸é‡ï¼Œå¹¶ä¸åˆ©äº å¯ç§»æ¤æ€§ã€‚</p><p>æ–°çš„æ–¹å¼æ˜¯é€šè¿‡éƒ¨ç½²å®¹å™¨æ–¹å¼å®ç°ï¼Œæ¯ä¸ªå®¹å™¨ä¹‹é—´äº’ç›¸éš”ç¦»ï¼Œæ¯ä¸ªå®¹å™¨æœ‰è‡ªå·±çš„æ–‡ä»¶ ç³»ç»Ÿ ï¼Œå®¹å™¨ä¹‹é—´è¿›ç¨‹ä¸ä¼šç›¸äº’å½±å“ï¼Œèƒ½åŒºåˆ†è®¡ç®—èµ„æºã€‚ç›¸å¯¹äºè™šæ‹Ÿæœºï¼Œå®¹å™¨èƒ½å¿«é€Ÿéƒ¨ç½²ï¼Œ ç”±äºå®¹å™¨ä¸åº•å±‚è®¾æ–½ã€æœºå™¨æ–‡ä»¶ç³»ç»Ÿè§£è€¦çš„ï¼Œæ‰€ä»¥å®ƒèƒ½åœ¨ä¸åŒäº‘ã€ä¸åŒç‰ˆæœ¬æ“ä½œç³»ç»Ÿé—´è¿› è¡Œè¿ç§»ã€‚</p><p>å®¹å™¨å ç”¨èµ„æºå°‘ã€éƒ¨ç½²å¿«ï¼Œæ¯ä¸ªåº”ç”¨å¯ä»¥è¢«æ‰“åŒ…æˆä¸€ä¸ªå®¹å™¨é•œåƒï¼Œæ¯ä¸ªåº”ç”¨ä¸å®¹å™¨é—´ æˆä¸€å¯¹ä¸€å…³ç³»ä¹Ÿä½¿å®¹å™¨æœ‰æ›´å¤§ä¼˜åŠ¿ï¼Œä½¿ç”¨å®¹å™¨å¯ä»¥åœ¨ build æˆ– release çš„é˜¶æ®µï¼Œä¸ºåº”ç”¨åˆ› å»ºå®¹å™¨é•œåƒï¼Œå› ä¸ºæ¯ä¸ªåº”ç”¨ä¸éœ€è¦ä¸å…¶ä½™çš„åº”ç”¨å †æ ˆç»„åˆï¼Œä¹Ÿä¸ä¾èµ–äºç”Ÿäº§ç¯å¢ƒåŸºç¡€ç»“æ„ï¼Œ è¿™ä½¿å¾—ä»ç ”å‘åˆ°æµ‹è¯•ã€ç”Ÿäº§èƒ½æä¾›ä¸€è‡´ç¯å¢ƒã€‚ç±»ä¼¼åœ°ï¼Œå®¹å™¨æ¯”è™šæ‹Ÿæœºè½»é‡ã€æ›´â€œé€æ˜â€ï¼Œ è¿™æ›´ä¾¿äºç›‘æ§å’Œç®¡ç†ã€‚</p><p>Kubernetes æ˜¯ Google å¼€æºçš„ä¸€ä¸ªå®¹å™¨ç¼–æ’å¼•æ“ï¼Œå®ƒæ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²ã€å¤§è§„æ¨¡å¯ä¼¸ç¼©ã€ åº”ç”¨å®¹å™¨åŒ–ç®¡ç†ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­éƒ¨ç½²ä¸€ä¸ªåº”ç”¨ç¨‹åºæ—¶ï¼Œé€šå¸¸è¦éƒ¨ç½²è¯¥åº”ç”¨çš„å¤šä¸ªå®ä¾‹ä»¥ä¾¿ å¯¹åº”ç”¨è¯·æ±‚è¿›è¡Œè´Ÿè½½å‡è¡¡ã€‚</p><p>åœ¨ Kubernetes ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºå¤šä¸ªå®¹å™¨ï¼Œæ¯ä¸ªå®¹å™¨é‡Œé¢è¿è¡Œä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œç„¶åé€š è¿‡å†…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œå®ç°å¯¹è¿™ä¸€ç»„åº”ç”¨å®ä¾‹çš„ç®¡ç†ã€å‘ç°ã€è®¿é—®ï¼Œè€Œè¿™äº›ç»†èŠ‚éƒ½ä¸éœ€ è¦è¿ç»´äººå‘˜å»è¿›è¡Œå¤æ‚çš„æ‰‹å·¥é…ç½®å’Œå¤„ç†ã€‚</p><h2 id="2ã€kubernetes-åŠŸèƒ½å’Œæ¶æ„"><a href="#2ã€kubernetes-åŠŸèƒ½å’Œæ¶æ„" class="headerlink" title="2ã€kubernetes åŠŸèƒ½å’Œæ¶æ„"></a>2ã€kubernetes åŠŸèƒ½å’Œæ¶æ„</h2><h3 id="2-1ã€æ¦‚è¿°"><a href="#2-1ã€æ¦‚è¿°" class="headerlink" title="2.1ã€æ¦‚è¿°"></a>2.1ã€æ¦‚è¿°</h3><p>Kubernetes æ˜¯ä¸€ä¸ªè½»ä¾¿çš„å’Œå¯æ‰©å±•çš„å¼€æºå¹³å°ï¼Œç”¨äºç®¡ç†å®¹å™¨åŒ–åº”ç”¨å’ŒæœåŠ¡ã€‚é€šè¿‡ Kubernetes èƒ½å¤Ÿè¿›è¡Œåº”ç”¨çš„è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œæ‰©ç¼©å®¹ã€‚åœ¨ Kubernetes ä¸­ï¼Œä¼šå°†ç»„æˆåº”ç”¨çš„å®¹ å™¨ç»„åˆæˆä¸€ä¸ªé€»è¾‘å•å…ƒä»¥æ›´æ˜“ç®¡ç†å’Œå‘ç°ã€‚Kubernetes ç§¯ç´¯äº†ä½œä¸º Google ç”Ÿäº§ç¯å¢ƒè¿è¡Œ å·¥ä½œè´Ÿè½½ 15 å¹´çš„ç»éªŒï¼Œå¹¶å¸æ”¶äº†æ¥è‡ªäºç¤¾åŒºçš„æœ€ä½³æƒ³æ³•å’Œå®è·µã€‚</p><h3 id="2-2ã€K8s-ç‰¹æ€§"><a href="#2-2ã€K8s-ç‰¹æ€§" class="headerlink" title="2.2ã€K8s ç‰¹æ€§"></a>2.2ã€K8s ç‰¹æ€§</h3><ul><li>è‡ªåŠ¨åŒ–è£…ç®±ï¼šåœ¨ä¸ç‰ºç‰²å¯ç”¨æ€§çš„æ¡ä»¶ä¸‹ï¼ŒåŸºäºå®¹å™¨å¯¹èµ„æºçš„è¦æ±‚å’Œçº¦æŸè‡ªåŠ¨éƒ¨ç½²å®¹å™¨ã€‚åŒæ—¶ï¼Œä¸ºäº†æé«˜åˆ©ç”¨ç‡å’ŒèŠ‚çœæ›´å¤šèµ„æºï¼Œå°†å…³é”®å’Œæœ€ä½³å·¥ä½œé‡ç»“åˆåœ¨ä¸€èµ·ã€‚</li><li>è‡ªæ„ˆèƒ½åŠ›ï¼šå½“å®¹å™¨å¤±è´¥æ—¶ï¼Œä¼šå¯¹å®¹å™¨è¿›è¡Œé‡å¯ï¼›å½“æ‰€éƒ¨ç½²çš„NodeèŠ‚ç‚¹æœ‰é—®é¢˜æ—¶ï¼Œä¼šå¯¹å®¹å™¨è¿›è¡Œé‡æ–°éƒ¨ç½²å’Œé‡æ–°è°ƒåº¦ï¼›å½“å®¹å™¨æœªé€šè¿‡ç›‘æ§æ£€æŸ¥æ—¶ï¼Œä¼šå…³é—­æ­¤å®¹å™¨ï¼›ç›´åˆ°å®¹å™¨æ­£å¸¸è¿è¡Œæ—¶ï¼Œæ‰ä¼šå¯¹å¤–æä¾›æœåŠ¡ã€‚</li><li>æ°´å¹³æ‰©å®¹ï¼šé€šè¿‡ç®€å•çš„å‘½ä»¤ã€ç”¨æˆ·ç•Œé¢æˆ–åŸºäºCPUçš„ä½¿ç”¨æƒ…å†µï¼Œèƒ½å¤Ÿå¯¹åº”ç”¨è¿›è¡Œæ‰©å®¹å’Œç¼©å®¹ã€‚</li><li>æœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ï¼šå¼€å‘è€…ä¸éœ€è¦ä½¿ç”¨é¢å¤–çš„æœåŠ¡å‘ç°æœºåˆ¶ï¼Œå°±èƒ½å¤ŸåŸºäºKubernetesè¿›è¡ŒæœåŠ¡å‘ç°å’Œè´Ÿè½½å‡è¡¡ã€‚</li><li>è‡ªåŠ¨å‘å¸ƒå’Œå›æ»šï¼šKubernetesèƒ½å¤Ÿç¨‹åºåŒ–çš„å‘å¸ƒåº”ç”¨å’Œç›¸å…³çš„é…ç½®ã€‚å¦‚æœå‘å¸ƒæœ‰é—®é¢˜ï¼ŒKuberneteså°†èƒ½å¤Ÿå›å½’å‘ç”Ÿçš„å˜æ›´ã€‚</li><li>ä¿å¯†å’Œé…ç½®ç®¡ç†ï¼šåœ¨ä¸éœ€è¦é‡æ–°æ„å»ºé•œåƒçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥éƒ¨ç½²å’Œæ›´æ–°ä¿å¯†å’Œåº”ç”¨é…ç½®ã€‚</li><li>å­˜å‚¨ç¼–æ’ï¼šè‡ªåŠ¨æŒ‚æ¥å­˜å‚¨ç³»ç»Ÿï¼Œè¿™äº›å­˜å‚¨ç³»ç»Ÿå¯ä»¥æ¥è‡ªäºæœ¬åœ°ã€å…¬å…±äº‘æä¾›å•†ï¼ˆä¾‹å¦‚ï¼šGCPå’ŒAWSï¼‰ã€ç½‘ç»œå­˜å‚¨(ä¾‹å¦‚ï¼šNFSã€iSCSIã€Glusterã€Cephã€Cinderå’ŒFlokerç­‰)ã€‚</li></ul><h3 id="2-3ã€k8sç»„ä»¶"><a href="#2-3ã€k8sç»„ä»¶" class="headerlink" title="2.3ã€k8sç»„ä»¶"></a>2.3ã€k8sç»„ä»¶</h3><p><img src="https://res.yongwang.lu/img/202303221859050.png" alt="k8sç»„ä»¶æ¶æ„"></p><p>é›†ç¾¤ä¸­æ€»ä½“åˆ†MasterèŠ‚ç‚¹å’ŒWorkerèŠ‚ç‚¹</p><p>MasterèŠ‚ç‚¹å¯¹åº”ä¸Šå›¾æ§åˆ¶å¹³é¢ç»„ä»¶ï¼ˆControl Plane Componentsï¼‰ç›¸å½“äºç»„ç»‡éƒ¨é•¿ï¼Œè´Ÿè´£è°ƒåº¦åˆ†é…ï¼Œä¸å¹²å…·ä½“çš„äº‹ã€‚</p><p>WorkerèŠ‚ç‚¹å¯¹åº”Nodeï¼Œå°±æ˜¯å®é™…å¹²æ´»çš„äºº</p><p>2.4ã€masterèŠ‚ç‚¹ä¸‹ç»„ä»¶</p><ul><li>kube-apiserver</li></ul><p>kube-apiserveræ˜¯æ•´ä¸ªé›†ç¾¤çš„å…¥å£ï¼Œä»–å°±åƒä¸ªç½‘å…³ï¼Œè¦è®¿é—®é›†ç¾¤ä¸­çš„ç»„ä»¶ï¼Œå¿…é¡»é€šè¿‡ä»–ã€‚</p><ul><li>etcd</li></ul><p>ä¸€è‡´ä¸”é«˜åº¦å¯ç”¨çš„é”®å€¼å­˜å‚¨ï¼Œç”¨ä½œ Kubernetes çš„æ‰€æœ‰é›†ç¾¤æ•°æ®çš„åå°æ•°æ®åº“ã€‚</p><ul><li>kube-scheduler</li></ul><p>è´Ÿè´£ç›‘è§†æ–°åˆ›å»ºçš„ã€æœªæŒ‡å®šè¿è¡Œ<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/" title="èŠ‚ç‚¹ï¼ˆnodeï¼‰">èŠ‚ç‚¹ï¼ˆnodeï¼‰</a>çš„Â <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" title="Pods">Pods</a>ï¼Œ å¹¶é€‰æ‹©èŠ‚ç‚¹æ¥è®© Pod åœ¨ä¸Šé¢è¿è¡Œã€‚</p><ul><li>kube-controller-manager</li></ul><p>å¤„ç†é›†ç¾¤ä¸­å¸¸è§„åå°ä»»åŠ¡ï¼Œä¸€ä¸ªèµ„æºå¯¹åº”ä¸€ä¸ªæ§åˆ¶å™¨</p><p>2.5ã€workerèŠ‚ç‚¹ä¸‹ç»„ä»¶</p><ul><li>kubelet</li></ul><p><code>kubelet</code>ä¼šåœ¨é›†ç¾¤ä¸­æ¯ä¸ª<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/" title="èŠ‚ç‚¹ï¼ˆnodeï¼‰">èŠ‚ç‚¹ï¼ˆnodeï¼‰</a>ä¸Šè¿è¡Œã€‚ å®ƒä¿è¯<a href="https://kubernetes.io/zh-cn/docs/concepts/overview/what-is-kubernetes/#why-containers" title="å®¹å™¨ï¼ˆcontainersï¼‰">å®¹å™¨ï¼ˆcontainersï¼‰</a>éƒ½è¿è¡Œåœ¨Â <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/pods/" title="Pod">Pod</a>Â ä¸­ã€‚kubelet æ¥æ”¶ä¸€ç»„é€šè¿‡å„ç±»æœºåˆ¶æä¾›ç»™å®ƒçš„ PodSpecsï¼Œ ç¡®ä¿è¿™äº› PodSpecs ä¸­æè¿°çš„å®¹å™¨å¤„äºè¿è¡ŒçŠ¶æ€ä¸”å¥åº·ã€‚ kubelet ä¸ä¼šç®¡ç†ä¸æ˜¯ç”± Kubernetes åˆ›å»ºçš„å®¹å™¨ã€‚</p><p>è¯´ç™½äº†å°±æ˜¯èŠ‚ç‚¹çš„æ§åˆ¶å™¨ï¼Œè´Ÿè´£ç®¡ç†æœ¬èŠ‚ç‚¹å®¹å™¨ã€‚</p><ul><li>kube-proxy</li></ul><p><a href="https://kubernetes.io/zh-cn/docs/reference/command-line-tools-reference/kube-proxy/" title="kube-proxy">kube-proxy</a>Â æ˜¯é›†ç¾¤ä¸­æ¯ä¸ª<a href="https://kubernetes.io/zh-cn/docs/concepts/architecture/nodes/" title="èŠ‚ç‚¹ï¼ˆnodeï¼‰">èŠ‚ç‚¹ï¼ˆnodeï¼‰</a>ä¸Šæ‰€è¿è¡Œçš„ç½‘ç»œä»£ç†ï¼Œ å®ç° KubernetesÂ <a href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/" title="æœåŠ¡ï¼ˆServiceï¼‰">æœåŠ¡ï¼ˆServiceï¼‰</a>Â æ¦‚å¿µçš„ä¸€éƒ¨åˆ†ã€‚kube-proxy ç»´æŠ¤èŠ‚ç‚¹ä¸Šçš„ä¸€äº›ç½‘ç»œè§„åˆ™ï¼Œ è¿™äº›ç½‘ç»œè§„åˆ™ä¼šå…è®¸ä»é›†ç¾¤å†…éƒ¨æˆ–å¤–éƒ¨çš„ç½‘ç»œä¼šè¯ä¸ Pod è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</p><p>è‡³æ­¤ï¼Œæˆ‘ç›¸ä¿¡æœ‹å‹ä»¬å¯¹kubernetesæœ‰äº†ä¸€ä¸ªå¤§è‡´çš„äº†è§£ï¼Œä¸‹ç¯‡æˆ‘ä»¬å°±å¼€å§‹æ­å»ºkubernetesé›†ç¾¤</p>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
  <entry>
    <title>Containerd ctr å’Œ crictl å®¢æˆ·ç«¯å‘½ä»¤ä»‹ç»ä¸å®æˆ˜æ“ä½œï¼ˆnerdctl ï¼‰</title>
    <link href="https://blog.yongwang.lu/post/a657fa03.html"/>
    <id>https://blog.yongwang.lu/post/a657fa03.html</id>
    <published>2023-01-02T05:05:21.000Z</published>
    <updated>2023-01-02T05:05:21.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä¸€ã€æ¦‚è¿°"><a href="#ä¸€ã€æ¦‚è¿°" class="headerlink" title="ä¸€ã€æ¦‚è¿°"></a>ä¸€ã€æ¦‚è¿°</h2><blockquote><p>ä½œä¸ºæ¥æ›¿Dockerè¿è¡Œæ—¶çš„<a href="https://containerd.io/">Containerd</a>åœ¨æ—©åœ¨Kubernetes1.7æ—¶å°±èƒ½ç›´æ¥ä¸Kubeleté›†æˆä½¿ç”¨ï¼Œåªæ˜¯å¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬å› ç†Ÿæ‚‰Dockerï¼Œåœ¨éƒ¨ç½²é›†ç¾¤æ—¶é‡‡ç”¨äº†é»˜è®¤çš„dockershimã€‚åœ¨<code>V1.24</code>èµ·çš„ç‰ˆæœ¬çš„kubeletå°±å½»åº•ç§»é™¤äº†<code>dockershim</code>ï¼Œæ”¹ä¸ºé»˜è®¤ä½¿ç”¨<code>Containerd</code>äº†ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Â <code>cri-dockerd</code>Â é€‚é…å™¨æ¥å°†Â <code>Docker Engine</code>Â ä¸ Kubernetes é›†æˆã€‚å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p></blockquote><p><img src="https://res.yongwang.lu/img/5da250511cf72797f2e2e992bd47240f-2.png" alt="å›¾ç‰‡"></p><h2 id="äºŒã€Containerd-å¸¸è§å‘½ä»¤æ“ä½œ"><a href="#äºŒã€Containerd-å¸¸è§å‘½ä»¤æ“ä½œ" class="headerlink" title="äºŒã€Containerd å¸¸è§å‘½ä»¤æ“ä½œ"></a>äºŒã€Containerd å¸¸è§å‘½ä»¤æ“ä½œ</h2><blockquote><p>æ›´æ¢Containerdåï¼Œä»¥å¾€æˆ‘ä»¬å¸¸ç”¨çš„dockerå‘½ä»¤ä¹Ÿä¸å†ä½¿ç”¨ï¼Œå–è€Œä»£ä¹‹çš„åˆ†åˆ«æ˜¯Â <code>crictl</code>Â å’ŒÂ <code>ctr</code>Â ä¸¤ä¸ªå‘½ä»¤å®¢æˆ·ç«¯ã€‚</p></blockquote><ul><li><p><code>crictl</code>Â æ˜¯éµå¾ªCRIæ¥å£è§„èŒƒçš„ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œé€šå¸¸ç”¨å®ƒæ¥æ£€æŸ¥å’Œç®¡ç†<code>kubelet</code>èŠ‚ç‚¹ä¸Šçš„å®¹å™¨è¿è¡Œæ—¶å’Œé•œåƒã€‚</p></li><li><p><code>ctr</code>Â æ˜¯Â <code>containerd</code>Â çš„ä¸€ä¸ªå®¢æˆ·ç«¯å·¥å…·ã€‚</p></li><li><p><code>ctr -v</code>Â è¾“å‡ºçš„æ˜¯Â <code>containerd</code>Â çš„ç‰ˆæœ¬ï¼Œ<code>crictl -v</code>Â è¾“å‡ºçš„æ˜¯å½“å‰ k8s çš„ç‰ˆæœ¬ï¼Œä»ç»“æœæ˜¾è€Œæ˜“è§ä½ å¯ä»¥è®¤ä¸ºÂ <code>crictl</code>Â æ˜¯ç”¨äºÂ <code>k8s</code>Â çš„ã€‚</p></li><li><p>ä¸€èˆ¬æ¥è¯´ä½ æŸä¸ªä¸»æœºå®‰è£…äº† k8s åï¼Œå‘½ä»¤è¡Œæ‰ä¼šæœ‰ crictl å‘½ä»¤ã€‚è€Œ ctr æ˜¯è·Ÿ k8s æ— å…³çš„ï¼Œä½ ä¸»æœºå®‰è£…äº† containerd æœåŠ¡åå°±å¯ä»¥æ“ä½œ ctr å‘½ä»¤ã€‚</p></li></ul><p>ä½¿ç”¨<code>crictl</code>å‘½ä»¤ä¹‹å‰ï¼Œéœ€è¦å…ˆé…ç½®<code>/etc/crictl.yaml</code>å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sockimage-endpoint: unix:///run/containerd/containerd.socktimeout: 10debug: false</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥é€šè¿‡å‘½ä»¤è¿›è¡Œè®¾ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crictl config runtime-endpoint unix:///run/containerd/containerd.sockcrictl config image-endpoint unix:///run/containerd/containerd.sock</span><br></pre></td></tr></table></figure><table><thead><tr><th>å‘½ä»¤</th><th>docker</th><th>ctrï¼ˆcontainerdï¼‰</th><th>crictlï¼ˆkubernetesï¼‰</th></tr></thead><tbody><tr><td>æŸ¥çœ‹è¿è¡Œçš„å®¹å™¨</td><td>docker ps</td><td>ctr task ls&#x2F;ctr container ls</td><td>crictl ps</td></tr><tr><td>æŸ¥çœ‹é•œåƒ</td><td>docker images</td><td>ctr image ls</td><td>crictl images</td></tr><tr><td>æŸ¥çœ‹å®¹å™¨æ—¥å¿—</td><td>docker logs</td><td>æ— </td><td>crictl logs</td></tr><tr><td>æŸ¥çœ‹å®¹å™¨æ•°æ®ä¿¡æ¯</td><td>docker inspect</td><td>ctr container info</td><td>crictl inspect</td></tr><tr><td>æŸ¥çœ‹å®¹å™¨èµ„æº</td><td>docker stats</td><td>æ— </td><td>crictl stats</td></tr><tr><td>å¯åŠ¨&#x2F;å…³é—­å·²æœ‰çš„å®¹å™¨</td><td>docker start&#x2F;stop</td><td>ctr task start&#x2F;kill</td><td>crictl start&#x2F;stop</td></tr><tr><td>è¿è¡Œä¸€ä¸ªæ–°çš„å®¹å™¨</td><td>docker run</td><td>ctr run</td><td>æ— ï¼ˆæœ€å°å•å…ƒä¸ºpodï¼‰</td></tr><tr><td>æ‰“æ ‡ç­¾</td><td>docker tag</td><td>ctr image tag</td><td>æ— </td></tr><tr><td>åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹å™¨</td><td>docker create</td><td>ctr container create</td><td>crictl create</td></tr><tr><td>å¯¼å…¥é•œåƒ</td><td>docker load</td><td>ctr image import</td><td>æ— </td></tr><tr><td>å¯¼å‡ºé•œåƒ</td><td>docker save</td><td>ctr image export</td><td>æ— </td></tr><tr><td>åˆ é™¤å®¹å™¨</td><td>docker rm</td><td>ctr container rm</td><td>crictl rm</td></tr><tr><td>åˆ é™¤é•œåƒ</td><td>docker rmi</td><td>ctr image rm</td><td>crictl rmi</td></tr><tr><td>æ‹‰å–é•œåƒ</td><td>docker pull</td><td>ctr image pull</td><td>ctictl pull</td></tr><tr><td>æ¨é€é•œåƒ</td><td>docker push</td><td>ctr image push</td><td>æ— </td></tr><tr><td>ç™»å½•æˆ–åœ¨å®¹å™¨å†…éƒ¨æ‰§è¡Œå‘½ä»¤</td><td>docker exec</td><td>æ— </td><td>crictl exec</td></tr><tr><td>æ¸…ç©ºä¸ç”¨çš„å®¹å™¨</td><td>docker image prune</td><td>æ— </td><td>crictl rmi â€“prune</td></tr></tbody></table><p>æ›´å¤šå‘½ä»¤æ“ä½œï¼Œå¯ä»¥ç›´æ¥åœ¨å‘½ä»¤è¡Œè¾“å…¥å‘½ä»¤æŸ¥çœ‹å¸®åŠ©ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker --help</span><br><span class="line">ctr --help</span><br><span class="line">crictl --help</span><br></pre></td></tr></table></figure><p>ç”±äºContainerdä¹Ÿæœ‰namespacesçš„æ¦‚å¿µï¼Œå¯¹äºä¸Šå±‚ç¼–æ’ç³»ç»Ÿçš„æ”¯æŒï¼Œ<code>ctr</code>Â å®¢æˆ·ç«¯ ä¸»è¦åŒºåˆ†äº†3ä¸ªå‘½åç©ºé—´åˆ†åˆ«æ˜¯<code>k8s.io</code>ã€<code>moby</code>å’Œ<code>default</code>ï¼Œä»¥ä¸Šæˆ‘ä»¬ç”¨<code>crictl</code>æ“ä½œçš„å‡åœ¨<code>k8s.io</code>å‘½åç©ºé—´ï¼Œä½¿ç”¨<code>ctr</code>Â çœ‹é•œåƒåˆ—è¡¨å°±éœ€è¦åŠ ä¸Š-nå‚æ•°ã€‚crictlæ˜¯åªæœ‰ä¸€ä¸ª<code>k8s.io</code>å‘½åç©ºé—´ï¼Œä½†æ˜¯æ²¡æœ‰-nå‚æ•°ã€‚</p><blockquote><p>ã€æ¸©é¦¨æç¤ºã€‘ctr images pull æ‹‰å–çš„é•œåƒé»˜è®¤æ”¾åœ¨<code>default</code>ï¼Œè€Œcrictl pull å’Œ kubelet é»˜è®¤æ‹‰å–çš„é•œåƒéƒ½åœ¨k8s.ioå‘½åç©ºé—´ä¸‹ã€‚æ‰€ä»¥é€šè¿‡<code>ctr</code>å¯¼å…¥é•œåƒçš„æ—¶å€™ç‰¹åˆ«æ³¨æ„ä¸€ç‚¹ï¼Œæœ€å¥½æŒ‡å®šå‘½åç©ºé—´ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># æ³¨æ„-nä¸èƒ½æ”¾åœ¨å‘½ä»¤æœ€åé¢ï¼Œä¸‹é¢å‡ è¡ŒæŸ¥çœ‹çš„é•œåƒæ˜¯ä¸€æ ·çš„</span><br><span class="line">ctr -n=k8s.io image ls</span><br><span class="line">ctr -n k8s.io image ls</span><br><span class="line"></span><br><span class="line"># crictl æ²¡æœ‰-nå‚æ•°ï¼Œæ“ä½œéƒ½åœ¨`k8s.io`å‘½åç©ºé—´ä¸‹ã€‚</span><br><span class="line">crictl image ls</span><br><span class="line">crictl images</span><br><span class="line"># crictl image list = ctr -n=k8s.io image list</span><br><span class="line"># crictl image ls = ctr -n=k8s.io image ls</span><br><span class="line"># crictl images = ctr -n=k8s.io image list</span><br><span class="line"># crictl images = ctr -n=k8s.io image ls</span><br><span class="line"></span><br><span class="line"># ä½¿ç”¨ctrå‘½ä»¤æŒ‡å®šå‘½åç©ºé—´å¯¼å…¥é•œåƒ</span><br><span class="line">ctr -n=k8s.io image import dashboard.tar</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹é•œåƒï¼Œå¯ä»¥çœ‹åˆ°å¯ä»¥æŸ¥è¯¢åˆ°äº†</span><br><span class="line">crictl images</span><br></pre></td></tr></table></figure><h2 id="ä¸‰ã€container-å®¢æˆ·ç«¯å·¥å…·-nerdctl"><a href="#ä¸‰ã€container-å®¢æˆ·ç«¯å·¥å…·-nerdctl" class="headerlink" title="ä¸‰ã€container å®¢æˆ·ç«¯å·¥å…· nerdctl"></a>ä¸‰ã€container å®¢æˆ·ç«¯å·¥å…· nerdctl</h2><p>æ¨èä½¿ç”¨nerdctlï¼Œä½¿ç”¨æ•ˆæœä¸dockerå‘½ä»¤çš„è¯­æ³•ä¸€è‡´<br>githubä¸‹è½½é“¾æ¥ï¼š<a href="https://github.com/containerd/nerdctl/releases">https://github.com/containerd/nerdctl/releases</a></p><ul><li><p>ç²¾ç®€ (nerdctl-</p><p>-linux-amd64.tar.gz): åªåŒ…å«nerdctl</p></li><li><p>å®Œæ•´ (nerdctl-full-</p><p>-linux-amd64.tar.gz): åŒ…å« containerd, runc, and CNIç­‰ä¾èµ–</p></li></ul><blockquote><p><code>nerdctl</code>Â çš„ç›®æ ‡å¹¶ä¸æ˜¯å•çº¯åœ°å¤åˆ¶ docker çš„åŠŸèƒ½ï¼Œå®ƒè¿˜å®ç°äº†å¾ˆå¤š docker ä¸å…·å¤‡çš„åŠŸèƒ½ï¼Œä¾‹å¦‚å»¶è¿Ÿæ‹‰å–é•œåƒï¼ˆlazy-pullingï¼‰ã€é•œåƒåŠ å¯†ï¼ˆimgcryptï¼‰ç­‰ã€‚å…·ä½“çœ‹nerdctlã€‚</p></blockquote><h3 id="1ï¼‰å®‰è£…-nerdctlï¼ˆç²¾ç®€ç‰ˆï¼‰"><a href="#1ï¼‰å®‰è£…-nerdctlï¼ˆç²¾ç®€ç‰ˆï¼‰" class="headerlink" title="1ï¼‰å®‰è£… nerdctlï¼ˆç²¾ç®€ç‰ˆï¼‰"></a>1ï¼‰å®‰è£… nerdctlï¼ˆç²¾ç®€ç‰ˆï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/nerdctl/releases/download/v0.22.2/nerdctl-0.22.2-linux-amd64.tar.gz</span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">tar -xf nerdctl-0.22.2-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="built_in">ln</span> -s /opt/k8s/nerdctl/nerdctl /usr/local/bin/nerdctl</span><br></pre></td></tr></table></figure><h3 id="2ï¼‰å®‰è£…-nerdctlï¼ˆå®Œæ•´ç‰ˆï¼Œè¿™é‡Œä¸è£…ï¼‰"><a href="#2ï¼‰å®‰è£…-nerdctlï¼ˆå®Œæ•´ç‰ˆï¼Œè¿™é‡Œä¸è£…ï¼‰" class="headerlink" title="2ï¼‰å®‰è£… nerdctlï¼ˆå®Œæ•´ç‰ˆï¼Œè¿™é‡Œä¸è£…ï¼‰"></a>2ï¼‰å®‰è£… nerdctlï¼ˆå®Œæ•´ç‰ˆï¼Œè¿™é‡Œä¸è£…ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/containerd/nerdctl/releases/download/v0.22.2/nerdctl-full-0.22.2-linux-amd64.tar.gz</span><br><span class="line">tar -xf nerdctl-full-0.16.0-linux-amd64.tar.gz -C /usr/local/</span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /usr/local/lib/systemd/system/*.service /etc/systemd/system/</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡buildkit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl <span class="built_in">enable</span>  buildkit containerd --now</span><br><span class="line">systemctl status buildkit containerd</span><br></pre></td></tr></table></figure><h3 id="3ï¼‰å®‰è£…-buildkit-æ”¯æŒæ„å»ºé•œåƒ"><a href="#3ï¼‰å®‰è£…-buildkit-æ”¯æŒæ„å»ºé•œåƒ" class="headerlink" title="3ï¼‰å®‰è£… buildkit æ”¯æŒæ„å»ºé•œåƒ"></a>3ï¼‰å®‰è£… buildkit æ”¯æŒæ„å»ºé•œåƒ</h3><p>buildkit GitHubåœ°å€ï¼š<a href="https://github.com/moby/buildkit">https://github.com/moby/buildkit</a></p><blockquote><p>ä½¿ç”¨<strong>ç²¾ç®€ç‰ˆ nerdctlæ— æ³•ç›´æ¥é€šè¿‡containerdæ„å»ºé•œåƒ</strong>ï¼Œéœ€è¦ä¸buildkitç»„å…¨ä½¿ç”¨ä»¥å®ç°é•œåƒæ„å»ºã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å®‰è£…ä¸Šé¢çš„å®Œæ•´nerdctlï¼›buildkité¡¹ç›®æ˜¯Dockerå…¬å¸å¼€æºå‡ºæ¥çš„ä¸€ä¸ªæ„å»ºå·¥å…·åŒ…ï¼Œæ”¯æŒOCIæ ‡å‡†çš„é•œåƒæ„å»ºã€‚å®ƒä¸»è¦åŒ…å«ä»¥ä¸‹éƒ¨åˆ†:</p></blockquote><ul><li><p>æœåŠ¡ç«¯buildkitdï¼Œå½“å‰æ”¯æŒruncå’Œcontainerdä½œä¸ºworkerï¼Œé»˜è®¤æ˜¯runcï¼›</p></li><li><p>å®¢æˆ·ç«¯buildctlï¼Œè´Ÿè´£è§£æDockerfileï¼Œå¹¶å‘æœåŠ¡ç«¯buildkitdå‘å‡ºæ„å»ºè¯·æ±‚ã€‚</p></li></ul><p>buildkitæ˜¯å…¸å‹çš„<strong>C&#x2F;Sæ¶æ„</strong>ï¼Œclientå’Œserverå¯ä»¥ä¸åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šã€‚è€Œnerdctlåœ¨æ„å»ºé•œåƒæ–¹é¢ä¹Ÿå¯ä»¥ä½œä¸ºbuildkitdçš„å®¢æˆ·ç«¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://github.com/moby/buildkit/releases</span></span><br><span class="line">wget https://github.com/moby/buildkit/releases/download/v0.10.4/buildkit-v0.10.4.linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line">tar -xf buildkit-v0.10.4.linux-amd64.tar.gz  -C /usr/local/</span><br></pre></td></tr></table></figure><p>é…ç½®buildkitçš„å¯åŠ¨æ–‡ä»¶ï¼Œå¯ä»¥ä»è¿™é‡Œä¸‹è½½ï¼š<a href="https://github.com/moby/buildkit/tree/master/examples/systemd">https://github.com/moby/buildkit/tree/master/examples/systemd</a><br>buildkitéœ€è¦é…ç½®ä¸¤ä¸ªæ–‡ä»¶</p><ul><li><code>/usr/lib/systemd/system/buildkit.socket</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/buildkit.socket &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=BuildKit</span></span><br><span class="line"><span class="string">Documentation=https://github.com/moby/buildkit</span></span><br><span class="line"><span class="string">[Socket]</span></span><br><span class="line"><span class="string">ListenStream=%t/buildkit/buildkitd.sock</span></span><br><span class="line"><span class="string">SocketMode=0660</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=sockets.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><ul><li><code>/usr/lib/systemd/system/buildkit.service</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; /usr/lib/systemd/system/buildkit.service &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">[Unit]</span></span><br><span class="line"><span class="string">Description=BuildKit</span></span><br><span class="line"><span class="string">Requires=buildkit.socket</span></span><br><span class="line"><span class="string">After=buildkit.socket</span></span><br><span class="line"><span class="string">Documentation=https://github.com/moby/buildkit</span></span><br><span class="line"><span class="string">[Service]</span></span><br><span class="line"><span class="string"># Replace runc builds with containerd builds  </span></span><br><span class="line"><span class="string">ExecStart=/usr/local/bin/buildkitd --addr fd://</span></span><br><span class="line"><span class="string">[Install]</span></span><br><span class="line"><span class="string">WantedBy=multi-user.target</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨buildkit</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> buildkit --now</span><br></pre></td></tr></table></figure><h2 id="å››ã€å®æˆ˜æ“ä½œ"><a href="#å››ã€å®æˆ˜æ“ä½œ" class="headerlink" title="å››ã€å®æˆ˜æ“ä½œ"></a>å››ã€å®æˆ˜æ“ä½œ</h2><h3 id="1ï¼‰ä¿®æ”¹containerdé…ç½®æ–‡ä»¶"><a href="#1ï¼‰ä¿®æ”¹containerdé…ç½®æ–‡ä»¶" class="headerlink" title="1ï¼‰ä¿®æ”¹containerdé…ç½®æ–‡ä»¶"></a>1ï¼‰ä¿®æ”¹containerdé…ç½®æ–‡ä»¶</h3><p>å¯ä»¥å‚è€ƒæˆ‘ä¹‹å‰çš„æ–‡ç« ï¼šã€äº‘åŸç”Ÿ.å¤§æ•°æ®ã€‘é•œåƒä»“åº“Harborå¯¹æ¥MinIOå¯¹è±¡å­˜å‚¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">containerd config default &gt; /etc/containerd/config.toml</span><br></pre></td></tr></table></figure><p>é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry]</span></span><br><span class="line">      <span class="attr">config_path</span> = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.auths]</span></span><br><span class="line"></span><br><span class="line">      <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs]</span></span><br><span class="line">        <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;myharbor-minio.com&quot;.tls]</span></span><br><span class="line">          <span class="attr">insecure_skip_verify</span> = <span class="literal">true</span>  <span class="comment">#è·³è¿‡è®¤è¯</span></span><br><span class="line">          <span class="attr">ca_file</span> = <span class="string">&quot;/etc/containerd/myharbor-minio.com/ca.crt&quot;</span></span><br><span class="line">        <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.configs.&quot;myharbor-minio.com&quot;.auth]</span></span><br><span class="line">          <span class="attr">username</span> = <span class="string">&quot;admin&quot;</span></span><br><span class="line">          <span class="attr">password</span> = <span class="string">&quot;Harbor12345&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.headers]</span></span><br><span class="line"></span><br><span class="line">      <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors]</span></span><br><span class="line">        <span class="section">[plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;myharbor-minio.com&quot;]</span></span><br><span class="line">          <span class="attr">endpoint</span> = [<span class="string">&quot;https://myharbor-minio.com&quot;</span>]</span><br></pre></td></tr></table></figure><p>é‡å¯containerd</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#é‡æ–°åŠ è½½é…ç½®</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="comment">#é‡å¯containerd</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šè¿™ä¸ªé…ç½®æ–‡ä»¶æ˜¯ç»™<code>crictl</code>å’Œ<code>kubelet</code>ä½¿ç”¨ï¼Œ<code>ctr</code>æ˜¯ä¸å¯ä»¥ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶çš„ï¼Œctr ä¸ä½¿ç”¨ CRIï¼Œå› æ­¤å®ƒä¸è¯»å–plugins.â€io.containerd.grpc.v1.criâ€é…ç½®ã€‚</p></blockquote><h3 id="2ï¼‰ctr-æ‹‰å–æ¨é€é•œåƒ"><a href="#2ï¼‰ctr-æ‹‰å–æ¨é€é•œåƒ" class="headerlink" title="2ï¼‰ctr æ‹‰å–æ¨é€é•œåƒ"></a>2ï¼‰ctr æ‹‰å–æ¨é€é•œåƒ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ¨é€é•œåƒåˆ°harbor</span></span><br><span class="line">ctr --namespace=k8s.io images push myharbor-minio.com/bigdata/minio:2022.8.22-debian-11-r0 --skip-verify --user admin:Harbor12345</span><br><span class="line"></span><br><span class="line"><span class="comment"># --namespace=k8s.io æŒ‡å®šå‘½åç©ºé—´ï¼Œä¸æ˜¯å¿…é¡»ï¼Œæ ¹æ®ç¯å¢ƒè€Œå®š</span></span><br><span class="line"><span class="comment"># --skip-verify è·³è¿‡è®¤è¯</span></span><br><span class="line"><span class="comment"># --user æŒ‡å®šharborç”¨æˆ·ååŠå¯†ç </span></span><br><span class="line"></span><br><span class="line">ctr  images pull --user admin:Harbor12345  --tlscacert=/etc/containerd/myharbor-minio.com/ca.crt myharbor-minio.com/bigdata/minio:2022.8.22-debian-11-r0</span><br></pre></td></tr></table></figure><p>ä¸æƒ³-u user:passwordæ¯æ¬¡å¿…é¡»ä½¿ç”¨ ctr pull&#x2F;ctr pushï¼Œ å¯ä»¥ä½¿ç”¨<code>nerdctl</code>Â ã€‚</p><h3 id="3ï¼‰é•œåƒæ„å»º"><a href="#3ï¼‰é•œåƒæ„å»º" class="headerlink" title="3ï¼‰é•œåƒæ„å»º"></a>3ï¼‰é•œåƒæ„å»º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> &gt; Dockerfile &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">FROM nginx:alpine</span></span><br><span class="line"><span class="string">RUN echo &#x27;Hello Nerdctl From Containerd&#x27; &gt; /usr/share/nginx/html/index.html</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨æ–‡ä»¶æ‰€åœ¨ç›®å½•æ‰§è¡Œé•œåƒæ„å»ºå‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸åŠ -næŒ‡å®šå‘½åç©ºé—´ï¼Œcrictlçœ‹ä¸åˆ°ï¼Œkubeletä¹Ÿä¸èƒ½ä½¿ç”¨å®ƒï¼Œé»˜è®¤åœ¨defaultå‘½åç©ºé—´ä¸‹</span></span><br><span class="line">nerdctl -n k8s.io build -t nginx:nerctl -f ./Dockerfile . </span><br><span class="line"><span class="comment">### å‚æ•°è§£é‡Š</span></span><br><span class="line"><span class="comment"># -tï¼šæŒ‡å®šé•œåƒåç§°</span></span><br><span class="line"><span class="comment"># . ï¼šå½“å‰ç›®å½•Dockerfile</span></span><br><span class="line"><span class="comment"># -fï¼šæŒ‡å®šDockerfileè·¯å¾„</span></span><br><span class="line"><span class="comment">#  --no-cacheï¼šä¸ç¼“å­˜</span></span><br></pre></td></tr></table></figure><h3 id="4ï¼‰æ‰“æ ‡ç­¾-tag"><a href="#4ï¼‰æ‰“æ ‡ç­¾-tag" class="headerlink" title="4ï¼‰æ‰“æ ‡ç­¾ tag"></a>4ï¼‰æ‰“æ ‡ç­¾ tag</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># crictlæ²¡æœ‰tagå‘½ä»¤ï¼Œåªèƒ½ä½¿ç”¨nerdctlå’Œctrï¼Œå¿…é¡»æŒ‡å®šå‘½åç©ºé—´ï¼Œè¦ä¸ç„¶kubeletæ— æ³•ä½¿ç”¨ã€‚</span></span><br><span class="line">ctr -n k8s.io i tag </span><br><span class="line">nerdctl -n k8s.io tag nginx:nerctl myharbor-minio.com/bigdata/nginx:nerctl</span><br><span class="line"><span class="comment"># ctr -n k8s.io tag nginx:nerctl myharbor-minio.com/bigdata/nginx:nerctl</span></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒ</span></span><br><span class="line">nerdctl  -n k8s.io  images myharbor-minio.com/bigdata/nginx:nerctl</span><br></pre></td></tr></table></figure><h3 id="5ï¼‰å°†é•œåƒæ¨é€åˆ°-Harbor"><a href="#5ï¼‰å°†é•œåƒæ¨é€åˆ°-Harbor" class="headerlink" title="5ï¼‰å°†é•œåƒæ¨é€åˆ° Harbor"></a>5ï¼‰å°†é•œåƒæ¨é€åˆ° Harbor</h3><p>ç¬¬ä¸€ç§æƒ…å†µï¼š<code>http</code>æ–¹å¼ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸‹ä¸¤ä¸ªå“ªä¸ªéƒ½å¯ä»¥</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/docker/certs.d/myharbor-minio.com:443</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd/certs.d/myharbor-minio.com:443</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/myharbor-minio.com\:443/hosts.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server = &quot;https://docker.io&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[host.&quot;http://myharbor-minio.com:80&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;,&quot;push&quot;]</span></span><br><span class="line"><span class="string">  #skip_verify = true</span></span><br><span class="line"><span class="string">  #ca = &quot;ca.crt&quot;   #ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="string">  #ca = &quot;/opt/auth/ca.crt&quot;  #ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="string">  #ca = [&quot;/opt/auth/ca.crt&quot;]</span></span><br><span class="line"><span class="string">  #ca = [&quot;ca.crt&quot;]</span></span><br><span class="line"><span class="string">  #client = [[&quot;/opt/auth/nginx.cclinux.cn.crt&quot;, &quot;/opt/auth/nginx.cclinux.cn.key&quot;]]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§æƒ…å†µï¼š<code>https</code>æ–¹å¼ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä»¥ä¸‹ä¸¤ä¸ªå“ªä¸ªéƒ½å¯ä»¥</span></span><br><span class="line"><span class="comment"># mkdir -p /etc/docker/certs.d/myharbor-minio.com:443</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /etc/containerd/certs.d/myharbor-minio.com:443</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/containerd/certs.d/myharbor-minio.com\:443/hosts.toml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">server = &quot;https://docker.io&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[host.&quot;https://myharbor-minio.com:443&quot;]</span></span><br><span class="line"><span class="string">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;,&quot;push&quot;]</span></span><br><span class="line"><span class="string">  skip_verify = true</span></span><br><span class="line"><span class="string">  #ca = &quot;ca.crt&quot;   #ç›¸å¯¹è·¯å¾„</span></span><br><span class="line"><span class="string">  #ca = &quot;/opt/auth/ca.crt&quot;  #ç»å¯¹è·¯å¾„</span></span><br><span class="line"><span class="string">  #ca = [&quot;/opt/auth/ca.crt&quot;]</span></span><br><span class="line"><span class="string">  ca = [&quot;/etc/containerd/myharbor-minio.com/ca.crt&quot;]</span></span><br><span class="line"><span class="string">  #client = [[&quot;/opt/auth/nginx.cclinux.cn.crt&quot;, &quot;/opt/auth/nginx.cclinux.cn.key&quot;]]</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure><p>é€šè¿‡ nerdctl ç™»å½• harbor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> Harbor12345 | nerdctl login --username <span class="string">&quot;admin&quot;</span> --password-stdin  myharbor-minio.com:443</span><br><span class="line"></span><br><span class="line">$ nerdctl login --username <span class="string">&quot;admin&quot;</span> --password Harbor12345 myharbor-minio.com:443</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç™»å‡º</span></span><br><span class="line">$ nerdctl <span class="built_in">logout</span></span><br></pre></td></tr></table></figure><p>å¼€å§‹å°†é•œåƒæ¨é€åˆ°harbor</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### æ¨é€åˆ°Harbor</span></span><br><span class="line"><span class="comment"># --insecure-registry        skips verifying HTTPS certs, and allows falling back to plain HTTP</span></span><br><span class="line">nerdctl --insecure-registry --namespace=k8s.io push myharbor-minio.com/bigdata/nginx:nerctl</span><br><span class="line"><span class="comment"># ctr --namespace=k8s.io images push myharbor-minio.com/bigdata/nginx:nerctl --skip-verify --user admin:Harbor12345</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --namespace=k8s.io æŒ‡å®šå‘½åç©ºé—´ï¼Œè·Ÿ-nä¸€æ ·ï¼Œä¸æ˜¯å¿…é¡»ï¼Œæ ¹æ®ç¯å¢ƒè€Œå®š</span></span><br><span class="line"><span class="comment"># --skip-verify è·³è¿‡è®¤è¯</span></span><br><span class="line"><span class="comment"># --user æŒ‡å®šharborç”¨æˆ·ååŠå¯†ç </span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">containerd</summary>
    
    
    
    <category term="containerd" scheme="https://blog.yongwang.lu/categories/containerd/"/>
    
    
    <category term="containerd" scheme="https://blog.yongwang.lu/tags/containerd/"/>
    
  </entry>
  
  <entry>
    <title>Containerd å…¥é—¨åˆ°å°è¯•</title>
    <link href="https://blog.yongwang.lu/post/964191ef.html"/>
    <id>https://blog.yongwang.lu/post/964191ef.html</id>
    <published>2023-01-02T03:45:41.000Z</published>
    <updated>2023-01-02T03:45:41.000Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>Kubernetes v1.24 ä¹‹å‰çš„ç‰ˆæœ¬ç›´æ¥é›†æˆäº† Docker Engine çš„ä¸€ä¸ªç»„ä»¶ï¼Œåä¸º <strong>dockershim</strong> [ç”¨äºè°ƒç”¨Docker]ã€‚ è¿™ç§ç‰¹æ®Šçš„ç›´æ¥æ•´åˆä¸å†æ˜¯ Kubernetes çš„ä¸€éƒ¨åˆ† ï¼ˆè¿™æ¬¡åˆ é™¤è¢«ä½œä¸º v1.20 å‘è¡Œç‰ˆæœ¬çš„ä¸€éƒ¨åˆ†å®£å¸ƒï¼‰ã€‚ è¿™æ„å‘³Kubernetesä»ç‰ˆæœ¬1.24å¼€å§‹å°±å¼ƒç”¨Dockerä½œä¸ºå®¹å™¨è¿è¡Œæ—¶ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ›´åŠ è½»é‡çº§çš„Containerdã€‚</p></blockquote><p><img src="https://res.yongwang.lu/img/5da250511cf72797f2e2e992bd47240f-2.png" alt="K8s-CRIæµç¨‹æ›´æ”¹"></p><blockquote><p>containerdå¯ç”¨ä½œ Linux å’Œ Windows çš„å®ˆæŠ¤è¿›ç¨‹ã€‚å®ƒç®¡ç†å…¶ä¸»æœºç³»ç»Ÿçš„å®Œæ•´å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼Œä»å›¾åƒä¼ è¾“å’Œå­˜å‚¨åˆ°å®¹å™¨æ‰§è¡Œå’Œç›‘ç£ï¼Œå†åˆ°ä½çº§å­˜å‚¨åˆ°ç½‘ç»œé™„ä»¶ç­‰ç­‰ã€‚</p></blockquote><h2 id="ä¸€ã€Containerdä»‹ç»"><a href="#ä¸€ã€Containerdä»‹ç»" class="headerlink" title="ä¸€ã€Containerdä»‹ç»"></a>ä¸€ã€Containerdä»‹ç»</h2><h3 id="1ã€Containerdçš„ç”±æ¥"><a href="#1ã€Containerdçš„ç”±æ¥" class="headerlink" title="1ã€Containerdçš„ç”±æ¥"></a>1ã€Containerdçš„ç”±æ¥</h3><p>ã€Dockeråå™ªä¸€æ—¶ï¼Œæå‡ºrunCã€‘2013å¹´dockerå…¬å¸åœ¨æ¨å‡ºdockeräº§å“åï¼Œç”±äºå…¶å¯¹å…¨çƒæŠ€æœ¯äº§ç”Ÿäº†ä¸€å®šçš„å½±å“åŠ›ï¼ŒGoogleå…¬å¸æ˜æ˜¾æ„Ÿè§‰åˆ°è‡ªå·±å…¬å¸å†…éƒ¨æ‰€ä½¿ç”¨çš„Brogç³»ç»Ÿæ±Ÿæ¹–åœ°ä½å—åˆ°çš„å¨èƒï¼Œå¸Œæœ›Dockerå…¬å¸èƒ½å¤Ÿä¸è‡ªå·±è”åˆæ‰“é€ ä¸€æ¬¾å¼€æºçš„å®¹å™¨è¿è¡Œæ—¶ä½œä¸ºDockeræ ¸å¿ƒä¾èµ–ï¼Œä½†Dockerå…¬å¸æ‹’ç»äº†ï¼›æ¥ç€Googleå…¬å¸è”åˆRedHatã€IBMç­‰å…¬å¸è¯´æœDockerå…¬å¸æŠŠå…¶å®¹å™¨æ ¸å¿ƒæŠ€æœ¯<code>libcontainer</code>æç»™OCIï¼ˆOpen Container Intiativeï¼‰ï¼Œå¹¶æ›´åä¸º<code>runC</code>ã€‚</p><p>ã€CNCFæˆç«‹ï¼Œkubernetesè¢«è¿«å¼€æºã€‘ä¸ºäº†è¿›ä¸€æ­¥éåˆ¶Dockeråœ¨æœªæ¥æŠ€æœ¯å¸‚åœºå½±å“åŠ›ï¼Œé¿å…åœ¨å®¹å™¨å¸‚åœºä¸ŠDockerä¸€å®¶ç‹¬å¤§ï¼ŒGoogleå…¬å¸å¸¦é¢†RedHatã€IBMç­‰æˆç«‹äº†CNCFï¼ˆCloud Native Computing Fundationï¼‰åŸºé‡‘ä¼šï¼Œå³<strong>äº‘åŸç”Ÿè®¡ç®—åŸºé‡‘ä¼š</strong>ã€‚CNCFçš„ç›®æ ‡å¾ˆæ˜ç¡®ï¼Œæ—¢ç„¶åœ¨å®¹å™¨åº”ç”¨é¢†åŸŸæ— æ³•ä¸Dockerç›¸æŠ—è¡¡ï¼Œé‚£å°±åšGoogleæ›´æœ‰ç»éªŒçš„æŠ€æœ¯å¸‚åœºâ€”â€”å¤§è§„æ¨¡å®¹å™¨ç¼–æ’åº”ç”¨åœºæ™¯ã€‚Googleå…¬å¸æŠŠè‡ªå·±å†…éƒ¨ä½¿ç”¨çš„Brogç³»ç»Ÿå¼€æºâ€”â€”Kubernetesï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä»Šå¤©æ‰€è¯´çš„äº‘åŸç”ŸæŠ€æœ¯ç”Ÿæ€ã€‚</p><p>ã€Dockerå¦¥åï¼Œè´¡çŒ®å‡ºContainerdã€‘2016å¹´Dockerå…¬å¸æ¨å‡ºäº†Docker Swarmï¼Œæ„åœ¨ä¸€ç»ŸDockerç”Ÿæ€ï¼Œè®©Dockeræ—¢å¯ä»¥å®ç°å®¹å™¨åº”ç”¨ç®¡ç†ï¼Œä¹Ÿå¯ä»¥å®ç°å¤§è§„æ¨¡å®¹å™¨ç¼–æ’ï¼Œç»è¿‡è¿‘1å¹´å·¦å³æ—¶é—´çš„å¸‚åœºéªŒè¯åï¼Œå‘ç°åœ¨å®¹å™¨ç¼–æ’æ–¹é¢æ— æ³•ç‹¬ç«‹æŠ—è¡¡kubernetesï¼Œæ‰€ä»¥Dockerå…¬å¸äº2017å¹´æ­£å¼å®£å¸ƒåŸç”Ÿæ”¯æŒKubernetesã€‚è‡³æ­¤ï¼ŒDockeråœ¨å¤§è§„æ¨¡å®¹å™¨ç¼–æ’åº”ç”¨å¸‚åœºè´¥ä¸‹é˜µæ¥ï¼Œä½†æ˜¯Dockerä¾ç„¶ä¸ç”˜å¿ƒå¤±è´¥ï¼ŒæŠŠDockeræ ¸å¿ƒä¾èµ–Containerdæç»™äº†CNCFï¼Œä¾æ­¤è¯´æ˜Dockerä¾æ—§æ˜¯ä¸€ä¸ªPaaSå¹³å°ã€‚</p><p>ã€k8så®£å¸ƒä¸æ”¯æŒDockerï¼ŒContainerdæˆä¸ºCRIä¸»è§’ã€‘2020å¹´CNCFåŸºé‡‘ä¼šå®£å¸ƒKubernetes 1.20ç‰ˆæœ¬å°†ä¸å†ä»…æ”¯æŒDockerå®¹å™¨ç®¡ç†å·¥å…·ï¼Œæ­¤äº‹çš„èµ·å› ä¸»è¦ä¹Ÿä¸Dockeræç»™CNCFåŸºé‡‘ä¼šçš„Containerdæœ‰å…³ï¼Œæ—©æœŸä¸ºäº†å®ç°Kubernetesèƒ½å¤Ÿä½¿ç”¨Dockerå®ç°å®¹å™¨ç®¡ç†ï¼Œä¸“é—¨åœ¨Kubernetesç»„ä»¶ä¸­é›†æˆä¸€ä¸ª<code>shim</code>æŠ€æœ¯ï¼Œç”¨æ¥å°†Kubernetes <strong>å®¹å™¨è¿è¡Œæ—¶æ¥å£</strong>ï¼ˆCRIï¼ŒContainer Runntime Interfaceï¼‰è°ƒç”¨ç¿»è¯‘æˆDockerçš„APIï¼Œè¿™æ ·å°±å¯ä»¥å¾ˆå¥½åœ°ä½¿ç”¨Dockeräº†ã€‚ä½†æ˜¯éšç€Kubernetesåœ¨å…¨çƒæŠ€æœ¯å¸‚åœºçš„å¹¿æ³›åº”ç”¨ï¼Œæœ‰æ›´å¤šçš„å®¹å™¨ç®¡ç†å·¥å…·çš„å‡ºç°ï¼Œå®ƒä»¬éƒ½æƒ³èƒ½å¤Ÿå€ŸåŠ©äºKubernetesè¢«ç”¨æˆ·æ‰€ä½¿ç”¨ï¼Œæ‰€ä»¥å°±æå‡ºæ ‡å‡†åŒ–å®¹å™¨è¿è¡Œæ—¶æ¥å£ï¼Œåªè¦é€‚é…äº†è¿™ä¸ªæ¥å£å°±å¯ä»¥é›†æˆåˆ°Kubernetesç”Ÿæ€å½“ä¸­ï¼Œæ‰€ä»¥Kuberneteså–æ¶ˆäº†å¯¹shimçš„ç»´æŠ¤ï¼Œå¹¶ä¸”ç”±äºContainerdæŠ€æœ¯çš„æˆåŠŸï¼Œå¯ä»¥å®ç°æ— ç¼å¯¹æ¥Kubernetesï¼Œæ‰€ä»¥æ¥ä¸‹æ¥Kuberneteså®¹å™¨è¿è¡Œæ—¶çš„ä¸»è§’æ˜¯Containerdã€‚</p><h3 id="2ã€Containerdæ¦‚å¿µ"><a href="#2ã€Containerdæ¦‚å¿µ" class="headerlink" title="2ã€Containerdæ¦‚å¿µ"></a>2ã€Containerdæ¦‚å¿µ</h3><p>æ—©åœ¨2016å¹´3æœˆï¼ŒDocker 1.11çš„Docker Engineé‡Œå°±åŒ…å«äº†containerdï¼Œè€Œç°åœ¨åˆ™æ˜¯æŠŠcontainerdä»Docker Engineé‡Œå½»åº•å‰¥ç¦»å‡ºæ¥ï¼Œä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„å¼€æºé¡¹ç›®ç‹¬ç«‹å‘å±•ï¼Œç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªæ›´åŠ å¼€æ”¾ã€ç¨³å®šçš„å®¹å™¨è¿è¡ŒåŸºç¡€è®¾æ–½ã€‚</p><p>å’ŒåŸå…ˆåŒ…å«åœ¨Docker Engineé‡Œcontainerdç›¸æ¯”ï¼Œç‹¬ç«‹çš„containerdå°†å…·æœ‰æ›´å¤šçš„åŠŸèƒ½ï¼Œå¯ä»¥æ¶µç›–æ•´ä¸ªå®¹å™¨è¿è¡Œæ—¶ç®¡ç†çš„æ‰€æœ‰éœ€æ±‚ã€‚å¦å¤–ç‹¬ç«‹ä¹‹åcontainerdçš„ç‰¹æ€§æ¼”è¿›å¯ä»¥å’ŒDocker Engineåˆ†å¼€ï¼Œä¸“æ³¨å®¹å™¨è¿è¡Œæ—¶ç®¡ç†ï¼Œå¯ä»¥æ›´ç¨³å®šã€‚</p><p>Containerdæ˜¯ä¸€ä¸ªå·¥ä¸šæ ‡å‡†çš„å®¹å™¨è¿è¡Œæ—¶ï¼Œé‡ç‚¹æ˜¯å®ƒç®€æ´ï¼Œå¥å£®ï¼Œä¾¿æºï¼Œåœ¨Linuxå’Œwindowä¸Šå¯ä»¥ä½œä¸ºä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹è¿è¡Œï¼Œå®ƒå¯ä»¥ç®¡ç†ä¸»æœºç³»ç»Ÿä¸Šå®¹å™¨çš„å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸï¼šé•œåƒä¼ è¾“å’Œå­˜å‚¨ï¼Œå®¹å™¨çš„æ‰§è¡Œå’Œç›‘æ§ï¼Œä½çº§åˆ«çš„å­˜å‚¨å’Œç½‘ç»œã€‚</p><p><strong>æ¯ä¸ªcontainerdåªè´Ÿè´£ä¸€å°æœºå™¨</strong>ï¼ŒPullé•œåƒï¼Œå¯¹å®¹å™¨çš„æ“ä½œï¼ˆå¯åŠ¨ã€åœæ­¢ç­‰ï¼‰ï¼Œç½‘ç»œï¼Œå­˜å‚¨éƒ½æ˜¯ç”±containerdå®Œæˆã€‚<strong>å…·ä½“è¿è¡Œå®¹å™¨ç”±runCè´Ÿè´£</strong>ï¼Œå®é™…ä¸Šåªè¦æ˜¯ç¬¦åˆOCIè§„èŒƒçš„å®¹å™¨éƒ½å¯ä»¥æ”¯æŒã€‚</p><p>Containerdå’Œdockerä¸åŒï¼Œcontainerdé‡ç‚¹æ˜¯é›†æˆåœ¨å¤§è§„æ¨¡çš„ç³»ç»Ÿä¸­ï¼Œä¾‹å¦‚kubernetesã€Swarmã€Mesosç­‰ã€å¯¹äºå®¹å™¨ç¼–æ’æœåŠ¡æ¥è¯´ï¼Œè¿è¡Œæ—¶åªéœ€è¦ä½¿ç”¨containerd+runCï¼Œæ›´åŠ è½»é‡ï¼Œå®¹æ˜“ç®¡ç†ã€‚ã€‘ã€‚<strong>Containerd è¢«è®¾è®¡æˆåµŒå…¥åˆ°ä¸€ä¸ªæ›´å¤§çš„ç³»ç»Ÿä¸­ï¼Œè€Œä¸æ˜¯ç›´æ¥ç”±å¼€å‘äººå‘˜æˆ–ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨</strong>ã€‚</p><p>Containerdçš„ç‰¹ç‚¹ï¼š</p><ul><li>ç®€æ´çš„åŸºäº gRPC çš„ API å’Œ client libraryã€‚</li><li>å®Œæ•´çš„ OCI æ”¯æŒ(runtime å’Œ image spec)ã€‚</li><li>åŒæ—¶å…·å¤‡ç¨³å®šæ€§å’Œé«˜æ€§èƒ½çš„å®šä¹‰è‰¯å¥½çš„å®¹å™¨æ ¸å¿ƒåŠŸèƒ½ã€‚</li><li>ä¸€ä¸ªè§£è€¦çš„ç³»ç»Ÿ(è®© imageã€filesystemã€runtime è§£è€¦åˆ)ï¼Œå®ç°æ’ä»¶å¼çš„æ‰©å±•å’Œé‡ç”¨ã€‚</li></ul><p>Containerdçš„ä½œç”¨ï¼š</p><ul><li>ç®¡ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸ(ä»åˆ›å»ºå®¹å™¨åˆ°é”€æ¯å®¹å™¨)ã€‚</li><li>æ‹‰å–&#x2F;æ¨é€å®¹å™¨é•œåƒã€‚</li><li>å­˜å‚¨ç®¡ç†(ç®¡ç†é•œåƒåŠå®¹å™¨æ•°æ®çš„å­˜å‚¨)ã€‚</li><li>è°ƒç”¨ runC è¿è¡Œå®¹å™¨(ä¸ runC ç­‰å®¹å™¨è¿è¡Œæ—¶äº¤äº’)ã€‚</li><li>ç®¡ç†å®¹å™¨ç½‘ç»œæ¥å£åŠç½‘ç»œã€‚</li></ul><p>ä½¿ç”¨ bucketbench å¯¹ Dockerã€crio å’Œ Containerd çš„æ€§èƒ½æµ‹è¯•ç»“æœï¼ŒåŒ…æ‹¬å¯åŠ¨ã€åœæ­¢å’Œåˆ é™¤å®¹å™¨ï¼Œä»¥æ¯”è¾ƒå®ƒä»¬æ‰€è€—çš„æ—¶é—´ï¼Œå¯ä»¥å‘ç°Containerd åœ¨å„ä¸ªæ–¹é¢éƒ½è¡¨ç°è‰¯å¥½ï¼Œæ€»ä½“æ€§èƒ½ä¼˜äº Docker å’Œ crioã€‚</p><h3 id="3ã€Containerdæ¶æ„"><a href="#3ã€Containerdæ¶æ„" class="headerlink" title="3ã€Containerdæ¶æ„"></a>3ã€Containerdæ¶æ„</h3><p>Containerd é‡‡ç”¨æ ‡å‡†çš„ C&#x2F;S æ¶æ„ï¼šæœåŠ¡ç«¯é€šè¿‡ GRPC åè®®æä¾›ç¨³å®šçš„ APIï¼›å®¢æˆ·ç«¯é€šè¿‡è°ƒç”¨æœåŠ¡ç«¯çš„ API è¿›è¡Œé«˜çº§çš„æ“ä½œã€‚</p><p>ä¸ºäº†å®ç°è§£è€¦ï¼ŒContainerd å°†ä¸åŒçš„èŒè´£åˆ’åˆ†ç»™ä¸åŒçš„ç»„ä»¶ï¼Œæ¯ä¸ªç»„ä»¶å°±ç›¸å½“äºä¸€ä¸ªå­ç³»ç»Ÿï¼ˆsubsystemï¼‰ã€‚è¿æ¥ä¸åŒå­ç³»ç»Ÿçš„ç»„ä»¶è¢«ç§°ä¸ºæ¨¡å—ã€‚</p><p>Containerd è¢«åˆ†ä¸ºä¸‰ä¸ªå¤§å—ï¼š Storage ã€ Metadata å’Œ Runtimeã€‚</p><p>Containerd ä¸¤å¤§å­ç³»ç»Ÿä¸ºï¼š<br>Bundle : åœ¨ Containerd ä¸­ï¼ŒBundle åŒ…å«äº†é…ç½®ã€å…ƒæ•°æ®å’Œæ ¹æ–‡ä»¶ç³»ç»Ÿæ•°æ®ï¼Œä½ å¯ä»¥ç†è§£ä¸º å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿã€‚è€Œ Bundle å­ç³»ç»Ÿå…è®¸ç”¨æˆ·ä»é•œåƒä¸­æå–å’Œæ‰“åŒ… Bundlesã€‚<br>Runtime : Runtime å­ç³»ç»Ÿç”¨æ¥æ‰§è¡Œ Bundlesï¼Œæ¯”å¦‚åˆ›å»ºå®¹å™¨ã€‚å…¶ä¸­ï¼Œæ¯ä¸€ä¸ªå­ç³»ç»Ÿçš„è¡Œä¸ºéƒ½ç”±ä¸€ä¸ªæˆ–å¤šä¸ªæ¨¡å—åä½œå®Œæˆï¼ˆæ¶æ„å›¾ä¸­çš„ Core éƒ¨åˆ†ï¼‰ã€‚</p><p><img src="https://containerd.io/img/architecture.png"></p><h3 id="4ã€å‡ ä¸ªæ¦‚å¿µåŒºåˆ†"><a href="#4ã€å‡ ä¸ªæ¦‚å¿µåŒºåˆ†" class="headerlink" title="4ã€å‡ ä¸ªæ¦‚å¿µåŒºåˆ†"></a>4ã€å‡ ä¸ªæ¦‚å¿µåŒºåˆ†</h3><p><code>containerd</code> æ˜¯ä¸€ä¸ªé«˜çº§å®¹å™¨è¿è¡Œæ—¶ï¼Œåˆåå®¹å™¨ç®¡ç†å™¨ã€‚ç®€å•æ¥è¯´ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹ï¼Œåœ¨å•ä¸ªä¸»æœºä¸Šç®¡ç†å®Œæ•´çš„å®¹å™¨ç”Ÿå‘½å‘¨æœŸï¼šåˆ›å»ºã€å¯åŠ¨ã€åœæ­¢å®¹å™¨ã€æ‹‰å–å’Œå­˜å‚¨é•œåƒã€é…ç½®æŒ‚è½½ã€ç½‘ç»œç­‰ã€‚</p><p><code>ctr</code> æ˜¯ä½œä¸º containerd é¡¹ç›®çš„ä¸€éƒ¨åˆ†æä¾›çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚è¯¥<code>ctr</code>ç•Œé¢ ä¸ Docker CLIä¸å…¼å®¹ï¼Œä¹ä¸€çœ‹ï¼Œå¯èƒ½çœ‹èµ·æ¥ä¸å¤ªç”¨æˆ·å‹å¥½ã€‚å› ä¸ºå®ƒçš„ä¸»è¦å—ä¼—æ˜¯æµ‹è¯•å®ˆæŠ¤è¿›ç¨‹çš„å®¹å™¨å¼€å‘äººå‘˜ã€‚<strong>ctr + containerdæ¯”docker + dockerdæ›´æ¥è¿‘å®é™…çš„å®¹å™¨ã€‚</strong></p><p><code>nerdctl</code> æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒæ–°çš„containerdå‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚ä¸cträ¸åŒï¼Œnerdctlçš„ç›®æ ‡æ˜¯ç”¨æˆ·å‹å¥½å’Œdockerå…¼å®¹ã€‚åœ¨æŸç§ç¨‹åº¦ä¸Šï¼Œ<strong>nerdctl + containerdå¯ä»¥æ— ç¼åœ°æ›¿ä»£docker + dockerdã€‚</strong></p><p><code>crictl</code> æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®¢æˆ·ç«¯ï¼Œç”¨äº [kubernetes] CRIå…¼å®¹çš„å®¹å™¨è¿è¡Œæ—¶ã€‚å¼•å…¥ Kubernetes å®¹å™¨è¿è¡Œæ—¶æ¥å£ (CRI)ä»¥ä½¿ Kubernetes å®¹å™¨è¿è¡Œæ—¶ä¸å¯çŸ¥ã€‚KubernetesèŠ‚ç‚¹ä»£ç†kubeletå®ç°äº† CRIå®¢æˆ·ç«¯ APIï¼Œå¯ä»¥ä½¿ç”¨ä»»ä½•å®ç° CRI æœåŠ¡å™¨ APIçš„å®¹å™¨è¿è¡Œæ—¶æ¥ç®¡ç†å…¶èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å’Œ Podã€‚</p><h2 id="äºŒã€Containerdå®‰è£…"><a href="#äºŒã€Containerdå®‰è£…" class="headerlink" title="äºŒã€Containerdå®‰è£…"></a>äºŒã€Containerdå®‰è£…</h2><p>containerdå®˜ç½‘ï¼š<a href="https://containerd.io/" title="https://containerd.io/">https://containerd.io/</a></p><p>containerdå®˜æ–¹å®‰è£…æ­¥éª¤ï¼š<a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md" title="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></p><h3 id="step1ï¼šå®‰è£…Containerd"><a href="#step1ï¼šå®‰è£…Containerd" class="headerlink" title="step1ï¼šå®‰è£…Containerd"></a>step1ï¼šå®‰è£…Containerd</h3><p>å› åç»­ç‰ˆæœ¬Kubernetes å¯¹containerdè¿è¡Œæ—¶æœ‰ç‰ˆæœ¬è¦æ±‚è¿™é‡Œå®‰è£…1.6.xç‰ˆæœ¬çš„. Ubuntuæºæ˜¯1.5.9ç‰ˆæœ¬. è¿™é‡Œ ç›´æ¥ä¸‹è½½debå®‰è£….&amp;#x20;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½Deb</span></span><br><span class="line"><span class="comment"># Dockerå®˜æ–¹æº https://download.docker.com/linux/ubuntu/dists/jammy/pool/stable/amd64/</span></span><br><span class="line"><span class="comment"># Tencentæº https://mirrors.cloud.tencent.com/docker-ce/linux/ubuntu/dists/jammy/pool/stable/amd64/</span></span><br><span class="line">$ wget https://download.docker.com/linux/ubuntu/dists/jammy/pool/stable/amd64/containerd.io_1.6.14-1_amd64.deb</span><br><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">$ dpkg -i containerd.io_1.6.14-1_amd64.deb</span><br></pre></td></tr></table></figure><p>å°†containerdæœåŠ¡è®¾ç½®å«å¼€æœºå¯åŠ¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ systemctl enable --now containerd</span><br><span class="line"># éªŒè¯</span><br><span class="line">$ ctr version</span><br><span class="line">Client:</span><br><span class="line">  Version:  v1.6.14</span><br><span class="line">  Revision: 9cd3357b7fd7218e4aec3eae239db1f68a5a6ec6</span><br><span class="line">  Go version: go1.17.13</span><br><span class="line"></span><br><span class="line">Server:</span><br><span class="line">  Version:  v1.6.14</span><br><span class="line">  Revision: 9cd3357b7fd7218e4aec3eae239db1f68a5a6ec6</span><br><span class="line">  UUID: 87222662-9eb1-44cb-998a-689c9efce638</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œcontainerdå®‰è£…å®Œæˆã€‚</p><h3 id="step2ï¼šä¿®æ”¹é…ç½®"><a href="#step2ï¼šä¿®æ”¹é…ç½®" class="headerlink" title="step2ï¼šä¿®æ”¹é…ç½®"></a>step2ï¼šä¿®æ”¹é…ç½®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /etc/containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶</span></span><br><span class="line">containerd config default | \</span><br><span class="line"><span class="built_in">tee</span> /etc/containerd/config.toml &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶ åŠ é€Ÿ</span></span><br><span class="line">sed -i \</span><br><span class="line">-e <span class="string">&#x27;/sandbox_image/s?k8s.gcr.io?registry.aliyuncs.com/google_containers?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/SystemdCgroup/s?false?true?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\          endpoint = [&quot;https://docker.nju.edu.cn/&quot;]&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡é‡å¯</span></span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h3 id="step3ï¼šå®‰è£…cniæ’ä»¶å’Œcniå·¥å…·åŒ…"><a href="#step3ï¼šå®‰è£…cniæ’ä»¶å’Œcniå·¥å…·åŒ…" class="headerlink" title="step3ï¼šå®‰è£…cniæ’ä»¶å’Œcniå·¥å…·åŒ…"></a>step3ï¼šå®‰è£…cniæ’ä»¶å’Œcniå·¥å…·åŒ…</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">mkdir</span> -p /home/cni-plugins</span><br><span class="line">$ tar Cxzvf /home/cni-plugins cni-plugins-linux-amd64-v1.0.0.tgz</span><br><span class="line"><span class="comment">## è¯¥äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€æ„å»ºçš„ï¼Œå¯ä»¥åœ¨ä»»ä½• Linux å‘è¡Œç‰ˆä¸Šè¿è¡Œ</span></span><br><span class="line"><span class="comment"># cniå·¥å…·1.1.2å…¼å®¹cniæ’ä»¶1.0.0</span></span><br><span class="line">$ <span class="built_in">mkdir</span> -p /home/cni-tools</span><br><span class="line">$ tar Cxzvf /home/cni-tools cni-1.1.2.tar.gz</span><br></pre></td></tr></table></figure><p>å®Œæˆã€‚</p><h2 id="ä¸‰ã€ctrå‘½ä»¤è¡Œæ“ä½œ"><a href="#ä¸‰ã€ctrå‘½ä»¤è¡Œæ“ä½œ" class="headerlink" title="ä¸‰ã€ctrå‘½ä»¤è¡Œæ“ä½œ"></a>ä¸‰ã€ctrå‘½ä»¤è¡Œæ“ä½œ</h2><p><strong>ctræ˜¯ä½œä¸º containerd é¡¹ç›®çš„ä¸€éƒ¨åˆ†æä¾›çš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯ã€‚</strong></p><p>è¯¥ctrç•Œé¢ [æ˜¾ç„¶] ä¸ Docker CLIä¸å…¼å®¹ï¼Œä¹ä¸€çœ‹ï¼Œå¯èƒ½çœ‹èµ·æ¥ä¸å¤ªç”¨æˆ·å‹å¥½ã€‚æ˜¾ç„¶ï¼Œå®ƒçš„ä¸»è¦å—ä¼—æ˜¯æµ‹è¯•å®ˆæŠ¤è¿›ç¨‹çš„å®¹å™¨å¼€å‘äººå‘˜ã€‚ä½†æ˜¯ï¼Œç”±äºå®ƒæœ€æ¥è¿‘å®é™…çš„ containerd APIï¼Œå› æ­¤å®ƒå¯ä»¥ä½œä¸ºä¸€ç§å¾ˆå¥½çš„æ¢ç´¢æ‰‹æ®µâ€”â€”é€šè¿‡æ£€æŸ¥å¯ç”¨å‘½ä»¤ï¼Œå¯ä»¥å¤§è‡´äº†è§£ containerdå¯ä»¥åšä»€ä¹ˆå’Œä¸å¯ä»¥åšä»€ä¹ˆã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">$ ctr --<span class="built_in">help</span></span><br><span class="line">NAME:</span><br><span class="line">   ctr - </span><br><span class="line">        __</span><br><span class="line">  _____/ /______</span><br><span class="line"> / ___/ __/ ___/</span><br><span class="line">/ /__/ /_/ /</span><br><span class="line">\___/\__/_/</span><br><span class="line"></span><br><span class="line">containerd CLI</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">USAGE:</span><br><span class="line">   ctr [global options] <span class="built_in">command</span> [<span class="built_in">command</span> options] [arguments...]</span><br><span class="line"></span><br><span class="line">VERSION:</span><br><span class="line">   v1.6.8</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">   </span><br><span class="line">ctr is an unsupported debug and administrative client <span class="keyword">for</span> interacting</span><br><span class="line">with the containerd daemon. Because it is unsupported, the commands,</span><br><span class="line">options, and operations are not guaranteed to be backward compatible or</span><br><span class="line">stable from release to release of the containerd project.</span><br><span class="line"></span><br><span class="line">COMMANDS:</span><br><span class="line">   plugins, plugin            provides information about containerd plugins</span><br><span class="line">   version                    <span class="built_in">print</span> the client and server versions</span><br><span class="line">   containers, c, container   manage containers</span><br><span class="line">   content                    manage content</span><br><span class="line">   events, event              display containerd events</span><br><span class="line">   images, image, i           manage images</span><br><span class="line">   leases                     manage leases</span><br><span class="line">   namespaces, namespace, ns  manage namespaces</span><br><span class="line">   pprof                      provide golang pprof outputs <span class="keyword">for</span> containerd</span><br><span class="line">   run                        run a container</span><br><span class="line">   snapshots, snapshot        manage snapshots</span><br><span class="line">   tasks, t, task             manage tasks</span><br><span class="line">   install                    install a new package</span><br><span class="line">   oci                        OCI tools</span><br><span class="line">   shim                       interact with a shim directly</span><br><span class="line">   <span class="built_in">help</span>, h                    Shows a list of commands or <span class="built_in">help</span> <span class="keyword">for</span> one <span class="built_in">command</span></span><br><span class="line"></span><br><span class="line">GLOBAL OPTIONS:</span><br><span class="line">   --debug                      <span class="built_in">enable</span> debug output <span class="keyword">in</span> logs</span><br><span class="line">   --address value, -a value    address <span class="keyword">for</span> containerd<span class="string">&#x27;s GRPC server (default: &quot;/run/containerd/containerd.sock&quot;) [$CONTAINERD_ADDRESS]</span></span><br><span class="line"><span class="string">   --timeout value              total timeout for ctr commands (default: 0s)</span></span><br><span class="line"><span class="string">   --connect-timeout value      timeout for connecting to containerd (default: 0s)</span></span><br><span class="line"><span class="string">   --namespace value, -n value  namespace to use with commands (default: &quot;default&quot;) [$CONTAINERD_NAMESPACE]</span></span><br><span class="line"><span class="string">   --help, -h                   show help</span></span><br><span class="line"><span class="string">   --version, -v                print the version</span></span><br></pre></td></tr></table></figure><h3 id="1ã€Containerdé•œåƒç®¡ç†"><a href="#1ã€Containerdé•œåƒç®¡ç†" class="headerlink" title="1ã€Containerdé•œåƒç®¡ç†"></a>1ã€Containerdé•œåƒç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–é•œåƒ  æ‹‰å–é•œåƒï¼Œå®Œå…¨åˆæ ¼çš„å‚è€ƒä¼¼ä¹æ˜¯å¿…éœ€çš„ï¼Œæ‰€ä»¥ä¸èƒ½å¿½ç•¥é•œåƒä»“åº“æˆ–æ ‡ç­¾éƒ¨åˆ†ã€‚</span></span><br><span class="line">$ ctr images pull --all-platforms docker.io/library/nginx:alpine</span><br><span class="line"><span class="comment"># --all-platforms  æŒ‡å®šæ‰€æœ‰å¹³å°é•œåƒ  </span></span><br><span class="line"><span class="comment"># --platform       æŒ‡å®šç³»ç»Ÿå¹³å°</span></span><br><span class="line">$ ctr images pull --platform linux/amd64 docker.io/library/nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹é•œåƒ</span></span><br><span class="line">$ ctr images <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŒ‚è½½é•œåƒ</span></span><br><span class="line">$ ctr images mount docker.io/library/nginx:alpine /mnt</span><br><span class="line">$ <span class="built_in">ls</span> /mnt</span><br><span class="line">$ umount /mnt</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒå¯¼å‡ºï¼Œå¹¶ä¿å­˜ä¸ºnginx.imgæ–‡ä»¶</span></span><br><span class="line">$ ctr i <span class="built_in">export</span> --all-platforms nginx.img docker.io/library/nginx:alpine</span><br><span class="line">$ <span class="built_in">ls</span> -l</span><br><span class="line">-rw-r--r-- 1 root root 70138368 Sep  2 16:33 nginx.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒå¯¼å…¥</span></span><br><span class="line">$ ctr images import nginx.img</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒåˆ é™¤</span></span><br><span class="line">$ ctr image <span class="built_in">rm</span> docker.io/library/nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒæ‰“tag</span></span><br><span class="line">$ ctr images tag docker.io/library/nginx:alpine nginx:alpine</span><br><span class="line"></span><br><span class="line"><span class="comment"># é•œåƒå¯¹æ¯”</span></span><br><span class="line">$ ctr images check</span><br></pre></td></tr></table></figure><h3 id="2ã€Containerdå®¹å™¨ç®¡ç†"><a href="#2ã€Containerdå®¹å™¨ç®¡ç†" class="headerlink" title="2ã€Containerdå®¹å™¨ç®¡ç†"></a>2ã€Containerdå®¹å™¨ç®¡ç†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºã€é™æ€ã€‘å®¹å™¨</span></span><br><span class="line"><span class="comment"># è¯¥å‘½ä»¤åˆ›å»ºå®¹å™¨åï¼Œå®¹å™¨å¹¶æ²¡æœ‰å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œå…¶åªæ˜¯ä¸€ä¸ªé™æ€çš„å®¹å™¨ã€‚è¿™ä¸ªcontainerå¯¹è±¡åªæ˜¯åŒ…å«äº†è¿è¡Œä¸€ä¸ªå®¹å™¨æ‰€éœ€çš„èµ„æºåŠé…ç½®çš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚ï¼š namespacesã€rootfs å’Œå®¹å™¨çš„é…ç½®éƒ½å·²ç»åˆå§‹åŒ–æˆåŠŸäº†ï¼Œåªæ˜¯ç”¨æˆ·è¿›ç¨‹(æœ¬æ¡ˆä¾‹ä¸ºnginx)è¿˜æ²¡æœ‰å¯åŠ¨ã€‚éœ€è¦ä½¿ç”¨`ctr tasks`å‘½ä»¤æ‰èƒ½è·å–ä¸€ä¸ªåŠ¨æ€å®¹å™¨ã€‚</span></span><br><span class="line">$ ctr container create docker.io/library/nginx:alpine testnginx1</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨ã€åŠ¨æ€ã€‘å®¹å™¨  åˆ›å»ºå®¹å™¨å’Œä»»åŠ¡å­å‘½ä»¤åˆ†ç¦»</span></span><br><span class="line">$ ctr task start -d testnginx1</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç›´æ¥è¿è¡Œä¸€ä¸ªåŠ¨æ€å®¹å™¨ã€å®¹å™¨çš„IPå°±æ˜¯å®¿ä¸»æœºçš„IPã€‘</span></span><br><span class="line"><span class="comment"># ctrè¿è¡Œå‘½ä»¤å®é™…ä¸Šæ˜¯ctrå®¹å™¨åˆ›å»º+ cträ»»åŠ¡å¯åŠ¨çš„å¿«æ·æ–¹å¼</span></span><br><span class="line">$ ctr run -d --net-host docker.io/library/nginx:alpine testnginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ã€é™æ€ã€‘å®¹å™¨</span></span><br><span class="line">$ ctr container <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ã€åŠ¨æ€ã€‘å®¹å™¨</span></span><br><span class="line">$ ctr task ps testnginx1</span><br><span class="line">PID      INFO</span><br><span class="line">64574    -</span><br><span class="line">64613    -</span><br><span class="line">64614    -</span><br><span class="line">64615    -</span><br><span class="line">64616    -</span><br><span class="line"><span class="comment"># ç‰©ç†æœºä¸ŠæŸ¥çœ‹</span></span><br><span class="line">$ ps -ef | grep nginx</span><br><span class="line">root      64574  64553  0 16:41 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class="line">101       64613  64574  0 16:41 ?        00:00:00 nginx: worker process</span><br><span class="line">101       64614  64574  0 16:41 ?        00:00:00 nginx: worker process</span><br><span class="line">101       64615  64574  0 16:41 ?        00:00:00 nginx: worker process</span><br><span class="line">101       64616  64574  0 16:41 ?        00:00:00 nginx: worker process</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨</span></span><br><span class="line">$ ctr task <span class="built_in">exec</span> --exec-id 1 testnginx2 sh</span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç½‘å¡</span></span><br><span class="line">ifconfig  </span><br><span class="line">ens33     Link encap:Ethernet  HWaddr 00:0C:29:32:CC:B0  </span><br><span class="line">          inet addr:192.168.168.201  Bcast:192.168.168.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::63d5:da66:d3db:fa1c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:476940 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:595381 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:175687016 (167.5 MiB)  TX bytes:149770479 (142.8 MiB)</span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"><span class="comment"># ä¸ºå®¹å™¨ä¸­è¿è¡Œçš„ç½‘ç«™æ·»åŠ ç½‘ç«™æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello nginx2&quot;</span> &gt; /usr/share/nginx/html/index.html</span><br><span class="line"><span class="comment"># åœ¨å®¹å™¨é‡Œè®¿é—®</span></span><br><span class="line">curl 127.0.0.1</span><br><span class="line"><span class="comment"># é€€å‡ºå®¹å™¨          </span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å®¿ä¸»æœºä¸Šè®¿é—®</span></span><br><span class="line">$ curl 192.168.168.201</span><br><span class="line">hello nginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># æš‚åœå®¹å™¨</span></span><br><span class="line">$ ctr task pause testnginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ¢å¤å®¹å™¨</span></span><br><span class="line">$ ctr task resume testnginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åœæ­¢å®¹å™¨</span></span><br><span class="line">$ ctr task <span class="built_in">kill</span> testnginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤åŠ¨æ€å®¹å™¨ã€å¿…é¡»å…ˆåœæ­¢ã€‘</span></span><br><span class="line">$ ctr task delete testnginx2</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤é™æ€å®¹å™¨</span></span><br><span class="line">$ ctr container delete testnginx2</span><br></pre></td></tr></table></figure><h3 id="3ã€Containerdå‘½åç©ºé—´ç®¡ç†"><a href="#3ã€Containerdå‘½åç©ºé—´ç®¡ç†" class="headerlink" title="3ã€Containerdå‘½åç©ºé—´ç®¡ç†"></a>3ã€Containerdå‘½åç©ºé—´ç®¡ç†</h3><p><strong>containerdä¸­namespaceçš„ä½œç”¨ä¸ºï¼šéš”ç¦»è¿è¡Œçš„å®¹å™¨ï¼Œå¯ä»¥å®ç°è¿è¡Œå¤šä¸ªå®¹å™¨ã€‚</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ‹‰å–é•œåƒ</span></span><br><span class="line">$ ctr namespace --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºå‘½åç©ºé—´</span></span><br><span class="line">$ ctr ns create testns</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å‘½åç©ºé—´</span></span><br><span class="line">$ ctr ns <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åœ¨å‘½åç©ºé—´ä¸­è¿›è¡Œé•œåƒã€å®¹å™¨ç­‰ç›¸å…³æ“ä½œ</span></span><br><span class="line">$ ctr -n testns images pull docker.io/library/nginx:latest</span><br><span class="line">$ ctr -n testns images <span class="built_in">ls</span></span><br><span class="line">$ ctr -n testns container create docker.io/library/nginx:latest</span><br><span class="line">$ ctr -n testns container <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤å‘½åç©ºé—´</span></span><br><span class="line">$ ctr ns <span class="built_in">rm</span> testns</span><br></pre></td></tr></table></figure><h3 id="4ã€Containerdç½‘ç»œç®¡ç†"><a href="#4ã€Containerdç½‘ç»œç®¡ç†" class="headerlink" title="4ã€Containerdç½‘ç»œç®¡ç†"></a>4ã€Containerdç½‘ç»œç®¡ç†</h3><p><strong>é»˜è®¤Containerdç®¡ç†çš„å®¹å™¨ä»…æœ‰loç½‘ç»œï¼Œæ— æ³•è®¿é—®å®¹å™¨ä¹‹å¤–çš„ç½‘ç»œï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ ç½‘ç»œæ’ä»¶ï¼Œä½¿ç”¨å®¹å™¨å¯ä»¥è¿æ¥å¤–ç½‘ï¼ŒCNIï¼ˆContainer Network Interfaceï¼‰</strong></p><p>cniæ’ä»¶å’Œcniå·¥å…·åŒ…å·²ç»åœ¨å‰é¢ç¬¬äºŒç« èŠ‚å·²ç»éƒ¨ç½²å®Œæ¯•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cniæ’ä»¶ç›®å½•</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/cni-plugins</span><br><span class="line"><span class="comment"># cniå·¥å…·åŒ…ç›®å½•</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/cni-tools/cni-1.1.2</span><br><span class="line"><span class="comment"># cniå·¥å…·1.1.2å…¼å®¹cniæ’ä»¶1.0.0</span></span><br></pre></td></tr></table></figure><ul><li><p>ä¸‹é¢å…ˆå¼€å§‹å‡†å¤‡å®¹å™¨ç½‘ç»œé…ç½®æ–‡ä»¶ï¼Œç”¨äºä¸ºå®¹å™¨æä¾›ç½‘å…³ã€IPåœ°å€ç­‰ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/cni/net.d/10-mynet.conf</span><br><span class="line">$ vim /etc/cni/net.d/99-loopback.conf</span><br><span class="line">$ <span class="built_in">cat</span> /etc/cni/net.d/10-mynet.conf</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;cniVersion&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;mynet&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>: <span class="string">&quot;bridge&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bridge&quot;</span>: <span class="string">&quot;cni0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;isGateway&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;ipMasq&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="string">&quot;ipam&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;type&quot;</span>: <span class="string">&quot;host-local&quot;</span>,</span><br><span class="line">            <span class="string">&quot;subnet&quot;</span>: <span class="string">&quot;10.66.0.0/16&quot;</span>,</span><br><span class="line">            <span class="string">&quot;routes&quot;</span>: [</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="string">&quot;dst&quot;</span>: <span class="string">&quot;0.0.0.0/0&quot;</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">$ <span class="built_in">cat</span> /etc/cni/net.d/99-loopback.conf</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;cniVerion&quot;</span>: <span class="string">&quot;1.0.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;lo&quot;</span>,</span><br><span class="line">    <span class="string">&quot;type&quot;</span>: <span class="string">&quot;loopback&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç”Ÿæˆcniç½‘ç»œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–epelæº</span></span><br><span class="line">$ wget -O /etc/yum.repos.d/epel.repo [http://mirrors.aliyun.com/repo/epel-7.repo](http://mirrors.aliyun.com/repo/epel-7.repo <span class="string">&quot;http://mirrors.aliyun.com/repo/epel-7.repo&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®‰è£…jqã€jqæ˜¯ä¸€ä¸ª&#x27;å‡ºè‰²&#x27;çš„&#x27;é’ˆå¯¹--&gt;JSONå¤„ç†å™¨&#x27;çš„å‘½ä»¤è¡Œã€‘</span></span><br><span class="line">$ yum -y install jq</span><br><span class="line"><span class="comment"># è¿›å…¥cniå·¥å…·ç›®å½•</span></span><br><span class="line">$ <span class="built_in">cd</span> /home/cni-tools/cni-1.1.2</span><br><span class="line"><span class="comment"># æ‰§è¡Œè„šæœ¬æ–‡ä»¶ï¼ŒåŸºäº/etc/cni/net.d/ç›®å½•ä¸­çš„ \*.confé…ç½®æ–‡ä»¶ç”Ÿæˆå®¹å™¨ç½‘ç»œ</span></span><br><span class="line"><span class="comment"># CNI\_PATHæ˜¯cniæ’ä»¶å®‰è£…çš„ç›®å½•</span></span><br><span class="line">$ CNI\_PATH=/home/cni-plugins ./priv-net-run.sh <span class="built_in">echo</span> <span class="string">&quot;Hello World&quot;</span></span><br><span class="line"><span class="comment"># cniæ’ä»¶å’Œcniå·¥å…·åŒ…ç‰ˆæœ¬è¦å…¼å®¹ï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</span></span><br><span class="line">mynet : error executing ADD: &#123;</span><br><span class="line">    <span class="string">&quot;code&quot;</span>: 1,</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;incompatible CNI versions&quot;</span>,</span><br><span class="line">    <span class="string">&quot;details&quot;</span>: <span class="string">&quot;config is &quot;</span>1.0.0<span class="string">&quot;, plugin supports \[&quot;</span>0.1.0<span class="string">&quot; &quot;</span>0.2.0<span class="string">&quot; &quot;</span>0.3.0<span class="string">&quot; &quot;</span>0.3.1<span class="string">&quot; &quot;</span>0.4.0<span class="string">&quot;]&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#å®‰è£…æˆåŠŸåï¼Œåœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹æ˜¯å¦ç”Ÿæˆå®¹å™¨ç½‘ç»œåä¸ºcni0çš„ç½‘æ¡¥</span></span><br><span class="line">$ ip a s</span><br><span class="line">    1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">    ...</span><br><span class="line">    7: cni0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether 6a:32:bc:eb:0f:23 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.66.0.1/16 brd 10.66.255.255 scope global cni0</span><br><span class="line">    valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::6832:bcff:feeb:f23/64 scope <span class="built_in">link</span></span><br><span class="line">    valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå®¹å™¨</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ ctr images pull docker.io/library/busybox:latest</span><br><span class="line">$ ctr run -d docker.io/library/busybox:latest busybox</span><br><span class="line">$ ctr tasks <span class="built_in">exec</span> --exec-id<span class="variable">$RANDOM</span> -t busybox sh ip a s</span><br><span class="line">    1: lo: \&lt;LOOPBACK,UP,LOWER\_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    2: tunl0\@NONE:  mtu 1480 qdisc noop qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line"><span class="comment">#è·å–å®¹å™¨è¿›ç¨‹IDåŠå…¶ç½‘ç»œå‘½åç©ºé—´</span></span><br><span class="line">$ pid= $(ctr tasks <span class="built_in">ls</span> | grep busybox | awk <span class="string">&#x27;&#123;print $ 2&#125;&#x27;</span>) &amp;&amp; <span class="built_in">echo</span> <span class="variable">$pid</span></span><br><span class="line">39287</span><br><span class="line">$ netnspath=/proc/ <span class="variable">$pid</span>/ns/net &amp;&amp; <span class="built_in">echo</span> <span class="variable">$netnspath</span>/proc/39287/ns/net</span><br><span class="line"><span class="comment"># è¿›å…¥ç›®å½•ä¸ºæŒ‡å®šå®¹å™¨æ·»åŠ ç½‘ç»œé…ç½®</span></span><br><span class="line"><span class="variable">$cd</span> /home/cni-tools/cni-1.1.2/scripts/$ CNI\_PATH=/home/cni-plugins ./exec-plugins.sh add $ pid  <span class="variable">$netnspath</span></span><br></pre></td></tr></table></figure></li><li><p>éªŒè¯å®¹å™¨ç½‘ç»œä¸å®¿ä¸»æœºç½‘ç»œçš„äº’è®¿åŠŸèƒ½</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éªŒè¯</span></span><br><span class="line">    <span class="comment"># è¿›å…¥å®¹å™¨ç¡®è®¤æ˜¯å¦æ·»åŠ ç½‘å¡ä¿¡æ¯</span></span><br><span class="line">    <span class="variable">$ctr</span> tasks <span class="built_in">exec</span> --exec-id<span class="variable">$RANDOM</span> -t busybox sh</span><br><span class="line">    $ ip a s</span><br><span class="line">    1: lo: \&lt;LOOPBACK,UP,LOWER\_UP&gt; mtu 65536 qdisc noqueue qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    2: tunl0\@NONE:&amp;<span class="comment">#x20;</span></span><br><span class="line"></span><br><span class="line">    &amp;<span class="comment">#x20;mtu 1480 qdisc noop qlen 1000</span></span><br><span class="line">    <span class="built_in">link</span>/ipip 0.0.0.0 brd 0.0.0.0</span><br><span class="line">    3: eth0\@if9: \&lt;BROADCAST,MULTICAST,UP,LOWER\_UP,M-DOWN&gt; mtu 1500 qdisc noqueue</span><br><span class="line">    <span class="built_in">link</span>/ether 5a:36:90:c1:33:b1 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.66.0.4/16 brd 10.66.255.255 scope global eth0</span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    inet6 fe80::5836:90ff:fec1:33b1/64 scope <span class="built_in">link</span></span><br><span class="line">    valid\_lft forever preferred\_lft forever</span><br><span class="line">    <span class="comment"># åœ¨å®¹å™¨ä¸­pingå®¹å™¨å®¿ä¸»æœºIPåœ°å€</span></span><br><span class="line">    $ ping -c 2 192.168.168.201</span><br><span class="line">    PING 192.168.168.201 (192.168.168.201): 56 data bytes</span><br><span class="line">    64 bytes from 192.168.168.201: <span class="built_in">seq</span>=0 ttl=64 time=0.067 ms</span><br><span class="line">    64 bytes from 192.168.168.201: <span class="built_in">seq</span>=1 ttl=64 time=0.070 ms</span><br><span class="line"></span><br><span class="line">    \--- 192.168.168.201 ping statistics ---</span><br><span class="line">    2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">    round-trip min/avg/max = 0.067/0.068/0.070 ms</span><br><span class="line">    <span class="comment"># åœ¨å®¹å™¨ä¸­pingå®¹å™¨å®¿ä¸»æœºIPåœ°å€</span></span><br><span class="line">    $ ping -c 2 192.168.168.2</span><br><span class="line">    PING 192.168.168.2 (192.168.168.2): 56 data bytes</span><br><span class="line">    64 bytes from 192.168.168.2: <span class="built_in">seq</span>=0 ttl=127 time=0.141 ms</span><br><span class="line">    64 bytes from 192.168.168.2: <span class="built_in">seq</span>=1 ttl=127 time=0.324 ms</span><br><span class="line"></span><br><span class="line">    \--- 192.168.168.2 ping statistics ---</span><br><span class="line">    2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">    round-trip min/avg/max = 0.141/0.232/0.324 ms</span><br><span class="line">    <span class="comment"># åœ¨å®¹å™¨ä¸­pingå®¹å™¨å®¿ä¸»æœºIPåœ°å€</span></span><br><span class="line">    $ ping -c 2 192.168.168.202</span><br><span class="line">    PING 192.168.168.201 (192.168.168.202): 56 data bytes</span><br><span class="line">    64 bytes from 192.168.168.202: <span class="built_in">seq</span>=0 ttl=64 time=0.067 ms</span><br><span class="line">    64 bytes from 192.168.168.202: <span class="built_in">seq</span>=1 ttl=64 time=0.070 ms</span><br><span class="line"></span><br><span class="line">    \--- 192.168.168.202 ping statistics ---</span><br><span class="line">    2 packets transmitted, 2 packets received, 0% packet loss</span><br><span class="line">    round-trip min/avg/max = 0.067/0.068/0.070 ms</span><br><span class="line">    <span class="comment"># åœ¨å®¹å™¨ä¸­å¼€å¯httpdæœåŠ¡</span></span><br><span class="line">    $ <span class="built_in">echo</span> <span class="string">&quot;containerd net web test&quot;</span> &gt; /tmp/index.html</span><br><span class="line">    $ httpd -h /tmp</span><br><span class="line">    $ wget -O - -q 127.0.0.1</span><br><span class="line">    containerd net web <span class="built_in">test</span></span><br><span class="line">    $ <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">    \<span class="comment">#åœ¨å®¿ä¸»æœºè®¿é—®å®¹å™¨æä¾›çš„httpdæœåŠ¡</span></span><br><span class="line">    \$ curl 10.66.0.4</span><br><span class="line">    containerd net web <span class="built_in">test</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="5ã€Containerdæ•°æ®æŒä¹…åŒ–"><a href="#5ã€Containerdæ•°æ®æŒä¹…åŒ–" class="headerlink" title="5ã€Containerdæ•°æ®æŒä¹…åŒ–"></a>5ã€Containerdæ•°æ®æŒä¹…åŒ–</h3><p>å®ç°æŠŠå®¿ä¸»æœºç›®å½•æŒ‚è½½è‡³Containerdå®¹å™¨ä¸­ï¼Œ<strong>å®ç°å®¹å™¨æ•°æ®æŒä¹…åŒ–å­˜å‚¨</strong>ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºä¸€ä¸ªé™æ€å®¹å™¨ï¼Œå®ç°å®¿ä¸»æœºç›®å½•ä¸å®¹å™¨æŒ‚è½½ï¼Œsrc=/tmp ä¸ºå®¿ä¸»æœºç›®å½• dst=/hostdir ä¸ºå®¹å™¨ä¸­ç›®å½•</span></span><br><span class="line">$ ctr container create docker.io/library/busybox:latest busybox3 --mount <span class="built_in">type</span>=<span class="built_in">bind</span>,src=/tmp,dst=/hostdir,options=rbind:rw</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œç”¨æˆ·è¿›ç¨‹</span></span><br><span class="line">$ ctr tasks start -d busybox3 bash</span><br><span class="line">$ ctr t <span class="built_in">ls</span></span><br><span class="line">TASK        PID       STATUS    </span><br><span class="line">busybox     39287     RUNNING</span><br><span class="line">busybox3    105003    RUNNING</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿›å…¥å®¹å™¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æŒ‚è½½æˆåŠŸ</span></span><br><span class="line">$ ctr tasks <span class="built_in">exec</span> --exec-id <span class="variable">$RANDOM</span> -t busybox3 sh</span><br><span class="line">$ <span class="built_in">ls</span> /hostdir/</span><br><span class="line">ks-script-GSRMK8                                                         vmware-root_6389-1958486695</span><br><span class="line">systemd-private-cc74dd8802f0428490924757e690c750-chronyd.service-9TDICh  vmware-root_6511-1689719547</span><br><span class="line">vmware-root_6359-1949639453                                              yum.log</span><br><span class="line"><span class="comment"># å‘å®¹å™¨ä¸­æŒ‚è½½ç›®å½•ä¸­æ·»åŠ æ–‡ä»¶</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello world&quot;</span> &gt; /hostdir/test.txt</span><br><span class="line">$ <span class="built_in">ls</span> /hostdir/</span><br><span class="line">ks-script-GSRMK8                                                         vmware-root_6389-1958486695</span><br><span class="line">systemd-private-cc74dd8802f0428490924757e690c750-chronyd.service-9TDICh  vmware-root_6511-1689719547</span><br><span class="line">test.txt                                                                 yum.log</span><br><span class="line">vmware-root_6359-1949639453</span><br><span class="line"><span class="comment"># åœ¨å®¿ä¸»æœºä¸ŠæŸ¥çœ‹è¢«å®¹å™¨æŒ‚è½½çš„ç›®å½•ä¸­æ˜¯å¦æ·»åŠ äº†æ–°çš„æ–‡ä»¶ï¼Œå·²æ·»åŠ è¡¨æ˜è¢«å®¹å™¨æŒ‚è½½æˆåŠŸï¼Œå¹¶å¯ä»¥è¯»å†™æ­¤ç›®å½•ä¸­å†…å®¹ã€‚</span></span><br><span class="line">$ <span class="built_in">cat</span> /tmp/test.txt </span><br><span class="line">hello world</span><br></pre></td></tr></table></figure><h3 id="6ã€Dockeré›†æˆContainerå®¹å™¨ç®¡ç†"><a href="#6ã€Dockeré›†æˆContainerå®¹å™¨ç®¡ç†" class="headerlink" title="6ã€Dockeré›†æˆContainerå®¹å™¨ç®¡ç†"></a>6ã€Dockeré›†æˆContainerå®¹å™¨ç®¡ç†</h3><p>ç›®å‰Containerdä¸»è¦ä»»åŠ¡è¿˜åœ¨äºè§£å†³å®¹å™¨è¿è¡Œæ—¶çš„é—®é¢˜ï¼Œå¯¹äºå…¶å‘¨è¾¹ç”Ÿæ€è¿˜ä¸å®Œå–„ï¼Œæ‰€ä»¥æœ‰æ—¶éœ€è¦å€ŸåŠ©ï¼šDockerç»“åˆContainerdæ¥å®ç°Dockerå®Œæ•´çš„åŠŸèƒ½åº”ç”¨ã€‚</p><p>Dockerå®‰è£…ä¸ä½¿ç”¨æ•™ç¨‹ï¼š<a href="https://blog.csdn.net/qq_41822345/article/details/107123094" title="https://blog.csdn.net/qq_41822345/article/details/107123094">https://blog.csdn.net/qq_41822345&#x2F;article&#x2F;details&#x2F;107123094</a></p><p>dockerè¿è¡Œçš„å®¹å™¨é»˜è®¤åœ¨mobyå‘½åç©ºé—´ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…docker</span></span><br><span class="line">$ yum install docker</span><br><span class="line"><span class="comment"># å¯åŠ¨docker</span></span><br><span class="line">$ systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡Œä¸€ä¸ªå®¹å™¨</span></span><br><span class="line">$ docker run -d nginx:latest</span><br><span class="line">$ docker ps</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ctrå‘½ä»¤ä¸‹çš„namespaceï¼Œå‘ç°å¤šäº†ä¸€ä¸ªmobyå‘½åç©ºé—´ã€‚mobyå³ä¸ºdockerä½¿ç”¨çš„å‘½åç©ºé—´ã€‚</span></span><br><span class="line">$ ctr namespace <span class="built_in">ls</span></span><br><span class="line">NAME    LABELS </span><br><span class="line">default        </span><br><span class="line">k8s.io         </span><br><span class="line">moby</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹mobyå‘½åç©ºé—´ä¸‹çš„å®¹å™¨å’Œä»»åŠ¡</span></span><br><span class="line">$ ctr -n moby container <span class="built_in">ls</span></span><br><span class="line">$ ctr -n moby tasks <span class="built_in">ls</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">containerd</summary>
    
    
    
    <category term="containerd" scheme="https://blog.yongwang.lu/categories/containerd/"/>
    
    
    <category term="containerd" scheme="https://blog.yongwang.lu/tags/containerd/"/>
    
  </entry>
  
</feed>
