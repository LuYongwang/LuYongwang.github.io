<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Lä¸¶luluâ€˜s Blog</title>
  
  <subtitle>æ•¬å¾€äº‹ä¸€æ¯é…’,å†çˆ±æˆ‘ä¹Ÿä¸å›å¤´ğŸŒ¹</subtitle>
  <link href="https://blog.yongwang.lu/atom.xml" rel="self"/>
  
  <link href="https://blog.yongwang.lu/"/>
  <updated>2023-03-21T13:40:00.000Z</updated>
  <id>https://blog.yongwang.lu/</id>
  
  <author>
    <name>Lä¸¶lulu</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kubernetes-é›†ç¾¤æ­å»º</title>
    <link href="https://blog.yongwang.lu/post/kubernetes1.html"/>
    <id>https://blog.yongwang.lu/post/kubernetes1.html</id>
    <published>2023-03-21T13:40:00.000Z</published>
    <updated>2023-03-21T13:40:00.000Z</updated>
    
    <content type="html"><![CDATA[<h1 id="é›†ç¾¤æ­å»º"><a href="#é›†ç¾¤æ­å»º" class="headerlink" title="é›†ç¾¤æ­å»º"></a>é›†ç¾¤æ­å»º</h1><p>å‚è€ƒï¼š <a href="https://kubernetes.io/zh/docs/" title="Kubernetes æ–‡æ¡£">Kubernetes æ–‡æ¡£</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/" title="å…¥é—¨">å…¥é—¨</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/" title="ç”Ÿäº§ç¯å¢ƒ">ç”Ÿäº§ç¯å¢ƒ</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/" title="ä½¿ç”¨éƒ¨ç½²å·¥å…·å®‰è£… Kubernetes">ä½¿ç”¨éƒ¨ç½²å·¥å…·å®‰è£… Kubernetes</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/" title="ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤">ä½¿ç”¨ kubeadm å¼•å¯¼é›†ç¾¤</a> &#x2F; <a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" title="å®‰è£… kubeadm">å®‰è£… kubeadm</a></p><p>æµç¨‹å›¾</p><p><img src="https://res.yongwang.lu/img/image_rFtNPTs_40.png"></p><h2 id="å‡†å¤‡å¼€å§‹"><a href="#å‡†å¤‡å¼€å§‹" class="headerlink" title="å‡†å¤‡å¼€å§‹"></a>å‡†å¤‡å¼€å§‹</h2><ul><li>ä¸€å°å…¼å®¹çš„ Linux ä¸»æœºã€‚Kubernetes é¡¹ç›®ä¸ºåŸºäº Debian å’Œ Red Hat çš„ Linux å‘è¡Œç‰ˆä»¥åŠä¸€äº›ä¸æä¾›åŒ…ç®¡ç†å™¨çš„å‘è¡Œç‰ˆæä¾›é€šç”¨çš„æŒ‡ä»¤</li><li>æ¯å°æœºå™¨ <code>2 GB</code> æˆ–æ›´å¤šçš„ RAM ï¼ˆå¦‚æœå°‘äºè¿™ä¸ªæ•°å­—å°†ä¼šå½±å“ä½ åº”ç”¨çš„è¿è¡Œå†…å­˜)</li><li><code>2 CPU æ ¸</code>æˆ–æ›´å¤š</li><li>é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨çš„ç½‘ç»œå½¼æ­¤å‡èƒ½ç›¸äº’è¿æ¥(å…¬ç½‘å’Œå†…ç½‘éƒ½å¯ä»¥)</li><li>èŠ‚ç‚¹ä¹‹ä¸­<code>ä¸å¯ä»¥æœ‰é‡å¤çš„</code>ä¸»æœºåã€MAC åœ°å€æˆ– product_uuidã€‚è¯·å‚è§<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#verify-mac-address" title="è¿™é‡Œ">è¿™é‡Œ</a>äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</li><li>å¼€å¯æœºå™¨ä¸Šçš„æŸäº›ç«¯å£ã€‚è¯·å‚è§<a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/#check-required-ports" title="è¿™é‡Œ">è¿™é‡Œ</a> äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ã€‚</li><li>ç¦ç”¨äº¤æ¢åˆ†åŒºã€‚ä¸ºäº†ä¿è¯ kubelet æ­£å¸¸å·¥ä½œï¼Œä½  <strong>å¿…é¡»</strong> <code>ç¦ç”¨äº¤æ¢åˆ†åŒº</code>ã€‚</li></ul><h2 id="U-ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š-MAC-åœ°å€å’Œ-product-uuid-çš„å”¯ä¸€æ€§-amp-x20"><a href="#U-ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š-MAC-åœ°å€å’Œ-product-uuid-çš„å”¯ä¸€æ€§-amp-x20" class="headerlink" title="U. ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§&amp;#x20;"></a>U. ç¡®ä¿æ¯ä¸ªèŠ‚ç‚¹ä¸Š MAC åœ°å€å’Œ product_uuid çš„å”¯ä¸€æ€§&amp;#x20;</h2><ul><li>ä½ å¯ä»¥ä½¿ç”¨å‘½ä»¤ <code>ip link</code> æˆ– <code>ifconfig -a</code> æ¥è·å–ç½‘ç»œæ¥å£çš„ MAC åœ°å€</li><li>å¯ä»¥ä½¿ç”¨ <code>sudo cat /sys/class/dmi/id/product_uuid</code> å‘½ä»¤å¯¹ product_uuid æ ¡éªŒ</li></ul><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><p><strong>[k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li>è®¾ç½®å½“å‰ç”¨æˆ·sudoå…å¯†[é€‰åš]<blockquote><p>ä¸æƒ³æ¯æ¬¡éƒ½è¾“å…¥å¯†ç  - åŠ é€Ÿ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼“å­˜ sudo å¯†ç </span></span><br><span class="line"><span class="built_in">echo</span> ubuntu | sudo -v -S </span><br><span class="line"></span><br><span class="line"><span class="comment"># </span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/sudoers.d/<span class="variable">$USER</span> &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">$USER ALL=(ALL) NOPASSWD: ALL</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>ä½¿ç”¨å›½å†…é•œåƒä»“åº“[é€‰åš]<blockquote><p>è½¯ä»¶å®‰è£… - åŠ é€Ÿ</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ¢é˜¿é‡Œäº‘åŠ é€Ÿ</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cp</span> /etc/apt/sources.list /etc/apt/sources.list_bak</span><br><span class="line">vim /etc/apt/sources.list</span><br><span class="line">æŸ¥çœ‹/etc/apt/sources.listä¸­çš„URLæ˜¯archive.ubuntuè¿˜æ˜¯cn.archive.ubuntu </span><br><span class="line">ç„¶åå†æ‰§è¡Œï¼š</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/cn.archive.ubuntu.com/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line"> æˆ– </span><br><span class="line">sudo sed -i <span class="string">&#x27;s/archive.ubuntu.com/mirrors.aliyun.com/g&#x27;</span> /etc/apt/sources.list</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li>ç¼–è¾‘ hosts&lt;å¿…åš&gt; <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">tee</span> -a /etc/hosts &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">192.168.147.131 k8s-master</span></span><br><span class="line"><span class="string">192.168.147.132 k8s-worker1</span></span><br><span class="line"><span class="string">192.168.147.133 k8s-worker2</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li><p>ç¦ç”¨ swap&lt;å¿…åš&gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># äº¤æ¢æ–‡ä»¶</span></span><br><span class="line">SWAPF=$(awk <span class="string">&#x27;/swap/ &#123;print $1&#125;&#x27;</span> /etc/fstab)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç¦ç”¨</span></span><br><span class="line">sudo swapoff <span class="variable">$SWAPF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°¸ä¹…ç¦ç”¨</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/swap/d&#x27;</span> /etc/fstab</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤äº¤æ¢æ–‡ä»¶</span></span><br><span class="line">sudo <span class="built_in">rm</span> <span class="variable">$SWAPF</span></span><br></pre></td></tr></table></figure></li><li><p>æ¨¡å—æ”¯æŒ&lt;å¿…åš&gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…</span></span><br><span class="line">sudo apt -y install bridge-utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">sudo modprobe br_netfilter</span><br><span class="line"></span><br><span class="line"><span class="comment"># å†…æ ¸æ”¯æŒ</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/sysctl.d/k8s.conf &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward=1</span></span><br><span class="line"><span class="string">vm.swappiness=0</span></span><br><span class="line"><span class="string">vm.overcommit_memory=1</span></span><br><span class="line"><span class="string">vm.panic_on_oom=0</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line">sudo sysctl -p /etc/sysctl.d/k8s.conf</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…è¿è¡Œæ—¶&lt;å¿…åš&gt;&amp;#x20;</p><p>è¿™é‡Œä¸å†é‡‡ç”¨dockerä½œä¸ºk8sçš„è¿è¡Œæ—¶. å› ä¸ºK8sè‡ª1.24 å¯¹dockeræ”¯æŒæ”¹ä¸º å®‰è£…æŒ‡å®šCRIæ‰èƒ½è®¿é—®.&amp;#x20;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£… containerd https://download.docker.com/linux/ubuntu/dists/jammy/pool/stable/amd64/</span></span><br><span class="line"><span class="comment"># ä¸‹è½½æœ€æ–°ç‰ˆæœ¬ containerd å› ä¸ºåœ¨k8såç»­ç‰ˆæœ¬åºŸå¼ƒ1.5.x å®‰è£…å¯¹åº”çš„debç‰ˆæœ¬</span></span><br><span class="line">sudo apt install -y containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-mark hold containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> /etc/containerd</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç”Ÿæˆé»˜è®¤é…ç½®æ–‡ä»¶</span></span><br><span class="line">containerd config default | \</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/containerd/config.toml &gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶ åŠ é€Ÿ</span></span><br><span class="line">sudo sed -i \</span><br><span class="line">-e <span class="string">&#x27;/sandbox_image/s?k8s.gcr.io?registry.aliyuncs.com/google_containers?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/SystemdCgroup/s?false?true?&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\        [plugins.&quot;io.containerd.grpc.v1.cri&quot;.registry.mirrors.&quot;docker.io&quot;]&#x27;</span> \</span><br><span class="line">-e <span class="string">&#x27;/registry.mirrors/a\          endpoint = [&quot;https://docker.nju.edu.cn/&quot;]&#x27;</span> /etc/containerd/config.toml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœåŠ¡é‡å¯</span></span><br><span class="line">sudo systemctl restart containerd</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡Œæ—¶é…ç½®ç§æœ</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">    [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://------.mirror.aliyuncs.com&quot;</span>, <span class="string">&quot;https://registry-1.docker.io&quot;</span>]</span><br><span class="line"><span class="comment"># è¿è¡Œæ—¶é…ç½®ç™»å½•</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry]</span><br><span class="line">   [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">       [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://registry-1.docker.io&quot;</span>]</span><br><span class="line">       [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>]</span><br><span class="line">          endpoint = [<span class="string">&quot;https://registry.cn-hangzhou.aliyuncs.com&quot;</span>]</span><br><span class="line">      [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs]</span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>.tls]</span><br><span class="line">          insecure_skip_verify = <span class="literal">true</span></span><br><span class="line">        [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.configs.<span class="string">&quot;registry.cn-hangzhou.aliyuncs.com&quot;</span>.auth]</span><br><span class="line">          username = <span class="string">&quot;é˜¿é‡Œäº‘è´¦æˆ·ï¼Œç±»ä¼¼xxx@aliyun.com&quot;</span></span><br><span class="line">          password = <span class="string">&quot;ä¸Šä¸€æ­¥è®¾ç½®çš„å›ºå®šå¯†ç &quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h2 id="å®‰è£…-K8s"><a href="#å®‰è£…-K8s" class="headerlink" title="å®‰è£… K8s"></a>å®‰è£… K8s</h2><p><strong>[kiosk@k8s-master|k8s-worker1|k8s-worker2]$</strong></p><ol><li>å®‰è£… kubeadmã€kubelet å’Œ kubectl<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ›´æ–° apt åŒ…ç´¢å¼•å¹¶å®‰è£…ä½¿ç”¨ Kubernetes apt ä»“åº“æ‰€éœ€è¦çš„åŒ…</span></span><br><span class="line">sudo apt -y install apt-transport-https ca-certificates curl</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½ Google Cloud å…¬å¼€ç­¾åç§˜é’¥</span></span><br><span class="line">curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | sudo apt-key add -</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ  Kubernetes apt ä»“åº“</span></span><br><span class="line">MIRROR_URL=https://mirrors.aliyun.com/kubernetes/apt/</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/kubernetes.list &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">deb $MIRROR_URL kubernetes-xenial main</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ›´æ–° apt åŒ…ç´¢å¼•</span></span><br><span class="line">sudo <span class="built_in">cp</span> /etc/apt/trusted.gpg /etc/apt/trusted.gpg.d</span><br><span class="line">sudo apt update -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-cache madison kubelet | grep 1.25</span><br><span class="line"></span><br><span class="line"><span class="comment"># å®‰è£… kubeletã€kubeadm å’Œ kubectl æŒ‡å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt install -y kubelet=1.25.1-00 kubeadm=1.25.1-00 kubectl=1.25.1-00</span><br><span class="line"></span><br><span class="line"><span class="comment"># é”å®šç‰ˆæœ¬</span></span><br><span class="line">sudo apt-mark hold kubelet kubeadm kubectl</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å®ŒK8sä»¥åä¼šè‡ªå¸¦crictl</span></span><br><span class="line"><span class="comment"># crictl é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo <span class="built_in">tee</span> /etc/crictl.yaml &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">debug: false</span></span><br><span class="line"><span class="string">pull-image-on-create: true</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>k8s æ”¯æŒ<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¢åŠ  k8s æ”¯æŒ</span></span><br><span class="line">sudo sed -i <span class="string">&#x27;/ExecStart=\//s|$| --container-runtime=remote --container-runtime-endpoint=unix:///run/containerd/containerd.sock --cgroup-driver=systemd|&#x27;</span> \</span><br><span class="line">  /etc/systemd/system/kubelet.service.d/10-kubeadm.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å¯ kubelet æœåŠ¡</span></span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart kubelet</span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-master]$</strong></p><ol><li>åˆå§‹åŒ–<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç”Ÿæˆåˆå§‹æ–‡ä»¶</span></span><br><span class="line">sudo kubeadm config <span class="built_in">print</span> init-defaults &gt; kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¿®æ”¹æ–‡ä»¶</span></span><br><span class="line">NICP=$(ip a | awk <span class="string">&#x27;/inet / &#123;print $2&#125;&#x27;</span> | grep -v ^127 | sed <span class="string">&#x27;s+/24++&#x27;</span>)</span><br><span class="line">sudo sed -i \</span><br><span class="line">  -e <span class="string">&quot;/advertiseAddress/s?:.*?: <span class="variable">$NICP</span>?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/name/s?:.*?: <span class="subst">$(hostname -s)</span>?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/clusterName/s?:.*?: k8s?&quot;</span> \</span><br><span class="line">  -e <span class="string">&quot;/imageRepository/s?:.*?: registry.aliyuncs.com/google_containers?&quot;</span> kubeadm-config.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿ç”¨åˆå§‹æ–‡ä»¶ï¼Œåˆå§‹åŒ–é›†ç¾¤</span></span><br><span class="line">sudo kubeadm init --config kubeadm-config.yaml</span><br></pre></td></tr></table></figure><blockquote><p>Your Kubernetes control-plane has initialized <code>successfully</code>!<br>PS: æ™®é€šç”¨æˆ·ç®¡ç†é›†ç¾¤</p><p>To start using your cluster, you need to run the following as a regular user:<br>bash<br>mkdir -p $HOME&#x2F;.kube<br>sudo cp -i &#x2F;etc&#x2F;kubernetes&#x2F;admin.conf $HOME&#x2F;.kube&#x2F;config<br>sudo chown $(id -u):$(id -g) $HOME&#x2F;.kube&#x2F;config</p><p>PSï¼šroot ç”¨æˆ·ç®¡ç†é›†ç¾¤</p><p>Alternatively, if you are the root user, you can run:</p><p>bash<br>export KUBECONFIG&#x3D;&#x2F;etc&#x2F;kubernetes&#x2F;admin.conf</p><p>You should now deploy a pod network to the cluster.Run â€œ<code>kubectl apply -f [podnetwork].yaml</code>â€œ with one of the options listed at:<a href="https://kubernetes.io/docs/concepts/cluster-administration/addons/" title="https://kubernetes.io/docs/concepts/cluster-administration/addons/">https://kubernetes.io/docs/concepts/cluster-administration/addons/</a><br>Then you can join any number of worker nodes by running the following on each as root:<br>bash<br>kubeadm join 192.168.147.128:6443 â€“token abcdef.0123456789abcdef â€“discovery-token-ca-cert-hash sha256:c4781194de65ebb47984fc5e7e64d4897875410825ce4d18df81da1a298afa1f</p></blockquote></li><li>é…ç½®æ–‡ä»¶ - Client<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line"></span><br><span class="line"><span class="comment"># user å¤åˆ¶é…ç½®æ–‡ä»¶</span></span><br><span class="line">sudo \<span class="built_in">cp</span> /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># root å˜é‡</span></span><br><span class="line">sudo <span class="built_in">tee</span> -a ~root/.bashrc &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">export KUBECONFIG=/etc/kubernetes/admin.conf</span></span><br><span class="line"><span class="string">EOF</span></span><br></pre></td></tr></table></figure></li><li>åˆ›å»ºç½‘ç»œ<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml</span><br></pre></td></tr></table></figure></li><li>å‘½ä»¤è¡¥å…¨ - Client[å»ºè®®]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl completion --<span class="built_in">help</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> &lt;(kubectl completion bash)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">mkdir</span> ~/.kube 2&gt;/dev/null</span><br><span class="line">kubectl completion bash &gt; ~/.kube/completion.bash.inc</span><br><span class="line"><span class="built_in">printf</span> <span class="string">&quot;</span></span><br><span class="line"><span class="string"># Kubectl shell completion</span></span><br><span class="line"><span class="string">source &#x27;<span class="variable">$HOME</span>/.kube/completion.bash.inc&#x27;</span></span><br><span class="line"><span class="string">&quot;</span> &gt;&gt; <span class="variable">$HOME</span>/.bashrc</span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.bashrc</span><br></pre></td></tr></table></figure></li><li>å‘½ä»¤åˆ«å - Client[å»ºè®®]<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç½‘å€ https://kubernetes.io/zh-cn/docs/reference/kubectl/cheatsheet/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æ°¸ä¹…ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">tee</span> -a <span class="variable">$HOME</span>/.bashrc &gt;/dev/null &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">alias k=&#x27;kubectl&#x27;</span></span><br><span class="line"><span class="string">complete -F __start_kubectl k</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç«‹å³ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> <span class="variable">$HOME</span>/.bashrc</span><br></pre></td></tr></table></figure></li></ol><p><strong>[k8s-worker1|k8s-worker2]$</strong></p><ol><li>åŠ å…¥é›†ç¾¤<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo \</span><br><span class="line">  kubeadm <span class="built_in">join</span> 192.168.147.128:6443 \</span><br><span class="line">  --token abcdef.0123456789abcdef \</span><br><span class="line">  --discovery-token-ca-cert-hash sha256:c4781194de65ebb47984fc5e7e64d4897875410825ce4d18df81da1a298afa1f</span><br></pre></td></tr></table></figure></li></ol><h2 id="C-ç¡®è®¤ç¯å¢ƒæ­£å¸¸"><a href="#C-ç¡®è®¤ç¯å¢ƒæ­£å¸¸" class="headerlink" title="C. ç¡®è®¤ç¯å¢ƒæ­£å¸¸"></a>C. ç¡®è®¤ç¯å¢ƒæ­£å¸¸</h2><p><strong>[k8s-master]</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME          STATUS     ROLES           AGE     VERSION</span><br><span class="line">k8s-master   `Ready`     control-plane   9m17s   `v1.25.1`</span><br><span class="line">k8s-worker1  `Ready`     &lt;none&gt;          90s     `v1.25.1`</span><br><span class="line">k8s-worker2  `Ready`     &lt;none&gt;          51s     `v1.25.1`</span><br><span class="line"></span><br><span class="line">$ kubectl get componentstatuses</span><br><span class="line">Warning: v1 ComponentStatus is deprecated <span class="keyword">in</span> v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE                         ERROR</span><br><span class="line">scheduler           `Healthy`  ok</span><br><span class="line">controller-manager  `Healthy`  ok</span><br><span class="line">etcd-0              `Healthy`  &#123;<span class="string">&quot;health&quot;</span>:<span class="string">&quot;true&quot;</span>,<span class="string">&quot;reason&quot;</span>:<span class="string">&quot;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">$ kubectl -n kube-system get pod -w</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-798cc86c47-dkdjl   1/1     Running   0          4m5s</span><br><span class="line">calico-node-ftwk8                          1/1     Running   0          4m5s</span><br><span class="line">calico-node-hstcg                          1/1     Running   0          109s</span><br><span class="line">calico-node-lcnw6                          1/1     Running   0          2m28s</span><br><span class="line">coredns-c676cc86f-mxpb8                    1/1     Running   0          10m</span><br><span class="line">coredns-c676cc86f-vhzzh                    1/1     Running   0          10m</span><br><span class="line">etcd-k8s-master                            1/1     Running   0          10m</span><br><span class="line">kube-apiserver-k8s-master                  1/1     Running   0          10m</span><br><span class="line">kube-controller-manager-k8s-master         1/1     Running   0          10m</span><br><span class="line">kube-proxy-g2tz9                           1/1     Running   0          109s</span><br><span class="line">kube-proxy-j4fgc                           1/1     Running   0          10m</span><br><span class="line">kube-proxy-nz8vj                           1/1     Running   0          2m28s</span><br><span class="line">kube-scheduler-k8s-master                  1/1     Running   0          10m</span><br><span class="line">&lt;Ctrl-C&gt;</span><br></pre></td></tr></table></figure>]]></content>
    
    
    <summary type="html">kubernetes1.26</summary>
    
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/categories/kubernetes/"/>
    
    
    <category term="kubernetes" scheme="https://blog.yongwang.lu/tags/kubernetes/"/>
    
  </entry>
  
</feed>
